export function compareTransactionSpendingLimits(expectedPermissions, actualPermissions) {
    let hasAllPermissions = true;
    // if the key is unlimited then we don't need to check anything else
    if (actualPermissions?.IsUnlimited) {
        return hasAllPermissions;
    }
    walkObj(expectedPermissions, (expectedVal, path) => {
        // If the actual permissions are configured with any of the special "allow
        // anything" mappings then we rewrite the lookup path for any explicit
        // mapping to match on the "allow any" mapping. In some cases, simply
        // compare the OpCounts and return early if their can be only 1 mapping.
        switch (path?.[0]) {
            case 'AccessGroupLimitMap':
                if (actualPermissions?.AccessGroupLimitMap?.find((map) => {
                    return (map.ScopeType === 'Any' &&
                        map.AccessGroupKeyName === '' &&
                        map.OperationType === 'Any' &&
                        map.OpCount >=
                            normalizeCount(expectedPermissions?.AccessGroupLimitMap?.[Number(path[1])]
                                ?.OpCount));
                })) {
                    return;
                }
                break;
            case 'AccessGroupMemberLimitMap':
                if (actualPermissions?.AccessGroupMemberLimitMap?.find((map) => {
                    return (map.ScopeType === 'Any' &&
                        map.AccessGroupKeyName === '' &&
                        map.OperationType === 'Any' &&
                        map.OpCount >=
                            normalizeCount(expectedPermissions?.AccessGroupMemberLimitMap?.[Number(path[1])]?.OpCount));
                })) {
                    return;
                }
                break;
            case 'AssociationLimitMap':
                if (actualPermissions?.AssociationLimitMap?.find((map) => {
                    return (map.AssociationClass ===
                        expectedPermissions?.AssociationLimitMap?.[Number(path[1])]
                            ?.AssociationClass &&
                        map.AppScopeType === 'Any' &&
                        map.AssociationType === '' &&
                        map.AssociationOperation === 'Any' &&
                        map.OpCount >=
                            normalizeCount(expectedPermissions?.AssociationLimitMap?.[Number(path[1])]
                                ?.OpCount));
                })) {
                    return;
                }
                break;
            case 'CreatorCoinOperationLimitMap':
                if (actualPermissions?.CreatorCoinOperationLimitMap?.['']) {
                    path =
                        typeof actualPermissions?.CreatorCoinOperationLimitMap['']?.any ===
                            'number'
                            ? ['CreatorCoinOperationLimitMap', '', 'any']
                            : ['CreatorCoinOperationLimitMap', '', path[path.length - 1]];
                }
                break;
            case 'NFTOperationLimitMap':
                if (actualPermissions?.NFTOperationLimitMap?.['']?.[0]) {
                    path =
                        typeof actualPermissions?.NFTOperationLimitMap?.['']?.[0]?.any ===
                            'number'
                            ? ['NFTOperationLimitMap', '', '0', 'any']
                            : ['NFTOperationLimitMap', '', '0', path[path.length - 1]];
                }
                break;
        }
        const actualVal = getDeepValue(actualPermissions, path);
        if (typeof actualVal === 'undefined' ||
            (typeof actualVal === 'number' &&
                actualVal < normalizeCount(expectedVal)) ||
            (typeof actualVal === 'string' && actualVal !== expectedVal)) {
            hasAllPermissions = false;
        }
    });
    return hasAllPermissions;
}
export function buildTransactionSpendingLimitResponse(spendingLimitOptions) {
    if (spendingLimitOptions.IsUnlimited) {
        return {
            IsUnlimited: true,
        };
    }
    if (spendingLimitOptions.GlobalDESOLimit?.toString() === 'UNLIMITED') {
        throw new Error('GlobalDESOLimit cannot be unlimited. You must specify a specific limit, or set the IsUnlimited flag to true.');
    }
    const result = {};
    walkObj(spendingLimitOptions, (val, path) => {
        setDeepValue(result, path, val === 'UNLIMITED' ? 1e9 : val);
    }, []);
    if (result.AccessGroupLimitMap) {
        result.AccessGroupLimitMap = Object.values(result.AccessGroupLimitMap);
    }
    if (result.AccessGroupMemberLimitMap) {
        result.AccessGroupMemberLimitMap = Object.values(result.AccessGroupMemberLimitMap);
    }
    if (result.AssociationLimitMap) {
        result.AssociationLimitMap = Object.values(result.AssociationLimitMap);
        // Validate each association limit object
        result.AssociationLimitMap.forEach((associationLimitItem) => {
            if (associationLimitItem.AppPublicKeyBase58Check &&
                associationLimitItem.AppScopeType === 'Any') {
                throw new Error(`AppPublicKeyBase58Check must be set to undefined or an empty string if AppScopeType is Any. You provided ${associationLimitItem.AppPublicKeyBase58Check}`);
            }
            if (!/^(?:BC1|tBC).+/.test(associationLimitItem.AppPublicKeyBase58Check) &&
                associationLimitItem.AppScopeType === 'Scoped') {
                throw new Error(`AppPublicKeyBase58Check must be set to a valid public key if AppScopeType is Scoped. You provided: ${associationLimitItem.AppPublicKeyBase58Check}`);
            }
        });
    }
    result.TransactionCountLimitMap = result.TransactionCountLimitMap ?? {};
    if (typeof result.TransactionCountLimitMap['AUTHORIZE_DERIVED_KEY'] ===
        'undefined') {
        result.TransactionCountLimitMap = {
            ...result.TransactionCountLimitMap,
            AUTHORIZE_DERIVED_KEY: 1,
        };
    }
    else if (result.TransactionCountLimitMap['AUTHORIZE_DERIVED_KEY'] < 0) {
        delete result.TransactionCountLimitMap['AUTHORIZE_DERIVED_KEY'];
    }
    return result;
}
function walkObj(node, callback, path = []) {
    if (typeof node === 'object' && node !== null) {
        const keys = Object.keys(node);
        for (let i = 0; i < keys.length; i++) {
            walkObj(node[keys[i]], callback, path.concat(keys[i]));
        }
    }
    else {
        callback(node, path);
    }
}
function getDeepValue(obj, path) {
    const currKey = path[0];
    if (obj === null ||
        typeof obj !== 'object' ||
        typeof obj[currKey] === 'undefined') {
        return;
    }
    if (path.length === 1) {
        return obj[currKey];
    }
    else {
        return getDeepValue(obj[currKey], path.slice(1));
    }
}
function setDeepValue(obj, path, value) {
    const currKey = path[0];
    if (typeof obj[currKey] === 'undefined') {
        obj[currKey] = {};
    }
    if (path.length === 1) {
        obj[currKey] = value;
    }
    else {
        setDeepValue(obj[currKey], path.slice(1), value);
    }
}
function normalizeCount(count) {
    // NOTE: If checking for unlimited, we just check if it's greater than 1
    // because there is no good way to know if the original value was 'UNLIMITED'
    // or some other numeric.  As long as the value is greater than 1, we just let
    // it pass as 'UNLIMITED.' In the end this shouldn't matter since we fail the
    // check if there are no more transactions left to spend.
    return count === 'UNLIMITED' || count === 1e9 ? 1 : count ?? 0;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGVybWlzc2lvbnMtdXRpbHMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvaWRlbnRpdHkvcGVybWlzc2lvbnMtdXRpbHMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBR0EsTUFBTSxVQUFVLGdDQUFnQyxDQUM5QyxtQkFBNEQsRUFDNUQsaUJBQW1EO0lBRW5ELElBQUksaUJBQWlCLEdBQUcsSUFBSSxDQUFDO0lBRTdCLG9FQUFvRTtJQUNwRSxJQUFJLGlCQUFpQixFQUFFLFdBQVcsRUFBRTtRQUNsQyxPQUFPLGlCQUFpQixDQUFDO0tBQzFCO0lBRUQsT0FBTyxDQUFDLG1CQUFtQixFQUFFLENBQUMsV0FBVyxFQUFFLElBQUksRUFBRSxFQUFFO1FBQ2pELDBFQUEwRTtRQUMxRSxzRUFBc0U7UUFDdEUscUVBQXFFO1FBQ3JFLHdFQUF3RTtRQUN4RSxRQUFRLElBQUksRUFBRSxDQUFDLENBQUMsQ0FBQyxFQUFFO1lBQ2pCLEtBQUsscUJBQXFCO2dCQUN4QixJQUNFLGlCQUFpQixFQUFFLG1CQUFtQixFQUFFLElBQUksQ0FBQyxDQUFDLEdBQUcsRUFBRSxFQUFFO29CQUNuRCxPQUFPLENBQ0wsR0FBRyxDQUFDLFNBQVMsS0FBSyxLQUFLO3dCQUN2QixHQUFHLENBQUMsa0JBQWtCLEtBQUssRUFBRTt3QkFDN0IsR0FBRyxDQUFDLGFBQWEsS0FBSyxLQUFLO3dCQUMzQixHQUFHLENBQUMsT0FBTzs0QkFDVCxjQUFjLENBQ1osbUJBQW1CLEVBQUUsbUJBQW1CLEVBQUUsQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7Z0NBQ3pELEVBQUUsT0FBTyxDQUNaLENBQ0osQ0FBQztnQkFDSixDQUFDLENBQUMsRUFDRjtvQkFDQSxPQUFPO2lCQUNSO2dCQUNELE1BQU07WUFDUixLQUFLLDJCQUEyQjtnQkFDOUIsSUFDRSxpQkFBaUIsRUFBRSx5QkFBeUIsRUFBRSxJQUFJLENBQUMsQ0FBQyxHQUFHLEVB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QUMsRUFBRSxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxFQUFFLEtBQUssQ0FBQyxDQUFDO0tBQ2xEO0FBQ0gsQ0FBQztBQUVELFNBQVMsY0FBYyxDQUFDLEtBQTRCO0lBQ2xELHdFQUF3RTtJQUN4RSw2RUFBNkU7SUFDN0UsOEVBQThFO0lBQzlFLDZFQUE2RTtJQUM3RSx5REFBeUQ7SUFDekQsT0FBTyxLQUFLLEtBQUssV0FBVyxJQUFJLEtBQUssS0FBSyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsS0FBSyxJQUFJLENBQUMsQ0FBQztBQUNqRSxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgVHJhbnNhY3Rpb25TcGVuZGluZ0xpbWl0UmVzcG9uc2UgfSBmcm9tICcuLi9iYWNrZW5kLXR5cGVzL2luZGV4LmpzJztcbmltcG9ydCB7IFRyYW5zYWN0aW9uU3BlbmRpbmdMaW1pdFJlc3BvbnNlT3B0aW9ucyB9IGZyb20gJy4vdHlwZXMuanMnO1xuXG5leHBvcnQgZnVuY3Rpb24gY29tcGFyZVRyYW5zYWN0aW9uU3BlbmRpbmdMaW1pdHMoXG4gIGV4cGVjdGVkUGVybWlzc2lvbnM6IFRyYW5zYWN0aW9uU3BlbmRpbmdMaW1pdFJlc3BvbnNlT3B0aW9ucyxcbiAgYWN0dWFsUGVybWlzc2lvbnM6IFRyYW5zYWN0aW9uU3BlbmRpbmdMaW1pdFJlc3BvbnNlXG4pOiBib29sZWFuIHtcbiAgbGV0IGhhc0FsbFBlcm1pc3Npb25zID0gdHJ1ZTtcblxuICAvLyBpZiB0aGUga2V5IGlzIHVubGltaXRlZCB0aGVuIHdlIGRvbid0IG5lZWQgdG8gY2hlY2sgYW55dGhpbmcgZWxzZVxuICBpZiAoYWN0dWFsUGVybWlzc2lvbnM/LklzVW5saW1pdGVkKSB7XG4gICAgcmV0dXJuIGhhc0FsbFBlcm1pc3Npb25zO1xuICB9XG5cbiAgd2Fsa09iaihleHBlY3RlZFBlcm1pc3Npb25zLCAoZXhwZWN0ZWRWYWwsIHBhdGgpID0+IHtcbiAgICAvLyBJZiB0aGUgYWN0dWFsIHBlcm1pc3Npb25zIGFyZSBjb25maWd1cmVkIHdpdGggYW55IG9mIHRoZSBzcGVjaWFsIFwiYWxsb3dcbiAgICAvLyBhbnl0aGluZ1wiIG1hcHBpbmdzIHRoZW4gd2UgcmV3cml0ZSB0aGUgbG9va3VwIHBhdGggZm9yIGFueSBleHBsaWNpdFxuICAgIC8vIG1hcHBpbmcgdG8gbWF0Y2ggb24gdGhlIFwiYWxsb3cgYW55XCIgbWFwcGluZy4gSW4gc29tZSBjYXNlcywgc2ltcGx5XG4gICAgLy8gY29tcGFyZSB0aGUgT3BDb3VudHMgYW5kIHJldHVybiBlYXJseSBpZiB0aGVpciBjYW4gYmUgb25seSAxIG1hcHBpbmcuXG4gICAgc3dpdGNoIChwYXRoPy5bMF0pIHtcbiAgICAgIGNhc2UgJ0FjY2Vzc0dyb3VwTGltaXRNYXAnOlxuICAgICAgICBpZiAoXG4gICAgICAgICAgYWN0dWFsUGVybWlzc2lvbnM/LkFjY2Vzc0dyb3VwTGltaXRNYXA/LmZpbmQoKG1hcCkgPT4ge1xuICAgICAgICAgICAgcmV0dXJuIChcbiAgICAgICAgICAgICAgbWFwLlNjb3BlVHlwZSA9PT0gJ0FueScgJiZcbiAgICAgICAgICAgICAgbWFwLkFjY2Vzc0dyb3VwS2V5TmFtZSA9PT0gJycgJiZcbiAgICAgICAgICAgICAgbWFwLk9wZXJhdGlvblR5cGUgPT09ICdBbnknICYmXG4gICAgICAgICAgICAgIG1hcC5PcENvdW50ID49XG4gICAgICAgICAgICAgICAgbm9ybWFsaXplQ291bnQoXG4gICAgICAgICAgICAgICAgICBleHBlY3RlZFBlcm1pc3Npb25zPy5BY2Nlc3NHcm91cExpbWl0TWFwPy5bTnVtYmVyKHBhdGhbMV0pXVxuICAgICAgICAgICAgICAgICAgICA/Lk9wQ291bnRcbiAgICAgICAgICAgICAgICApXG4gICAgICAgICAgICApO1xuICAgICAgICAgIH0pXG4gICAgICAgICkge1xuICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgJ0FjY2Vzc0dyb3VwTWVtYmVyTGltaXRNYXAnOlxuICAgICAgICBpZiAoXG4gICAgICAgICAgYWN0dWFsUGVybWlzc2lvbnM/LkFjY2Vzc0dyb3VwTWVtYmVyTGltaXRNYXA/LmZpbmQoKG1hcCkgPT4ge1xuICAgICAgICAgICAgcmV0dXJuIChcbiAgICAgICAgICAgICAgbWFwLlNjb3BlVHlwZSA9PT0gJ0FueScgJiZcbiAgICAgICAgICAgICAgbWFwLkFjY2Vzc0dyb3VwS2V5TmFtZSA9PT0gJycgJiZcbiAgICAgICAgICAgICAgbWFwLk9wZXJhdGlvblR5cGUgPT09ICdBbnknICYmXG4gICAgICAgICAgICAgIG1hcC5PcENvdW50ID49XG4gICAgICAgICAgICAgICAgbm9ybWFsaXplQ291bnQoXG4gICAgICAgICAgICAgICAgICBleHBlY3RlZFBlcm1pc3Npb25zPy5BY2Nlc3NHcm91cE1lbWJlckxpbWl0TWFwPy5bXG4gICAgICAgICAgICAgICAgICAgIE51bWJlcihwYXRoWzFdKVxuICAgICAgICAgICAgICAgICAgXT8uT3BDb3VudFxuICAgICAgICAgICAgICAgIClcbiAgICAgICAgICAgICk7XG4gICAgICAgICAgfSlcbiAgICAgICAgKSB7XG4gICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICAgIGJyZWFrO1xuICAgICAgY2FzZSAnQXNzb2NpYXRpb25MaW1pdE1hcCc6XG4gICAgICAgIGlmIChcbiAgICAgICAgICBhY3R1YWxQZXJtaXNzaW9ucz8uQXNzb2NpYXRpb25MaW1pdE1hcD8uZmluZCgobWFwKSA9PiB7XG4gICAgICAgICAgICByZXR1cm4gKFxuICAgICAgICAgICAgICBtYXAuQXNzb2NpYXRpb25DbGFzcyA9PT1cbiAgICAgICAgICAgICAgICBleHBlY3RlZFBlcm1pc3Npb25zPy5Bc3NvY2lhdGlvbkxpbWl0TWFwPy5bTnVtYmVyKHBhdGhbMV0pXVxuICAgICAgICAgICAgICAgICAgPy5Bc3NvY2lhdGlvbkNsYXNzICYmXG4gICAgICAgICAgICAgIG1hcC5BcHBTY29wZVR5cGUgPT09ICdBbnknICYmXG4gICAgICAgICAgICAgIG1hcC5Bc3NvY2lhdGlvblR5cGUgPT09ICcnICYmXG4gICAgICAgICAgICAgIG1hcC5Bc3NvY2lhdGlvbk9wZXJhdGlvbiA9PT0gJ0FueScgJiZcbiAgICAgICAgICAgICAgbWFwLk9wQ291bnQgPj1cbiAgICAgICAgICAgICAgICBub3JtYWxpemVDb3VudChcbiAgICAgICAgICAgICAgICAgIGV4cGVjdGVkUGVybWlzc2lvbnM/LkFzc29jaWF0aW9uTGltaXRNYXA/LltOdW1iZXIocGF0aFsxXSldXG4gICAgICAgICAgICAgICAgICAgID8uT3BDb3VudFxuICAgICAgICAgICAgICAgIClcbiAgICAgICAgICAgICk7XG4gICAgICAgICAgfSlcbiAgICAgICAgKSB7XG4gICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICAgIGJyZWFrO1xuICAgICAgY2FzZSAnQ3JlYXRvckNvaW5PcGVyYXRpb25MaW1pdE1hcCc6XG4gICAgICAgIGlmIChhY3R1YWxQZXJtaXNzaW9ucz8uQ3JlYXRvckNvaW5PcGVyYXRpb25MaW1pdE1hcD8uWycnXSkge1xuICAgICAgICAgIHBhdGggPVxuICAgICAgICAgICAgdHlwZW9mIGFjdHVhbFBlcm1pc3Npb25zPy5DcmVhdG9yQ29pbk9wZXJhdGlvbkxpbWl0TWFwWycnXT8uYW55ID09PVxuICAgICAgICAgICAgJ251bWJlcidcbiAgICAgICAgICAgICAgPyBbJ0NyZWF0b3JDb2luT3BlcmF0aW9uTGltaXRNYXAnLCAnJywgJ2FueSddXG4gICAgICAgICAgICAgIDogWydDcmVhdG9yQ29pbk9wZXJhdGlvbkxpbWl0TWFwJywgJycsIHBhdGhbcGF0aC5sZW5ndGggLSAxXV07XG4gICAgICAgIH1cbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlICdORlRPcGVyYXRpb25MaW1pdE1hcCc6XG4gICAgICAgIGlmIChhY3R1YWxQZXJtaXNzaW9ucz8uTkZUT3BlcmF0aW9uTGltaXRNYXA/LlsnJ10/LlswXSkge1xuICAgICAgICAgIHBhdGggPVxuICAgICAgICAgICAgdHlwZW9mIGFjdHVhbFBlcm1pc3Npb25zPy5ORlRPcGVyYXRpb25MaW1pdE1hcD8uWycnXT8uWzBdPy5hbnkgPT09XG4gICAgICAgICAgICAnbnVtYmVyJ1xuICAgICAgICAgICAgICA/IFsnTkZUT3BlcmF0aW9uTGltaXRNYXAnLCAnJywgJzAnLCAnYW55J11cbiAgICAgICAgICAgICAgOiBbJ05GVE9wZXJhdGlvbkxpbWl0TWFwJywgJycsICcwJywgcGF0aFtwYXRoLmxlbmd0aCAtIDFdXTtcbiAgICAgICAgfVxuICAgICAgICBicmVhaztcbiAgICB9XG5cbiAgICBjb25zdCBhY3R1YWxWYWwgPSBnZXREZWVwVmFsdWUoYWN0dWFsUGVybWlzc2lvbnMsIHBhdGgpO1xuXG4gICAgaWYgKFxuICAgICAgdHlwZW9mIGFjdHVhbFZhbCA9PT0gJ3VuZGVmaW5lZCcgfHxcbiAgICAgICh0eXBlb2YgYWN0dWFsVmFsID09PSAnbnVtYmVyJyAmJlxuICAgICAgICBhY3R1YWxWYWwgPCBub3JtYWxpemVDb3VudChleHBlY3RlZFZhbCkpIHx8XG4gICAgICAodHlwZW9mIGFjdHVhbFZhbCA9PT0gJ3N0cmluZycgJiYgYWN0dWFsVmFsICE9PSBleHBlY3RlZFZhbClcbiAgICApIHtcbiAgICAgIGhhc0FsbFBlcm1pc3Npb25zID0gZmFsc2U7XG4gICAgfVxuICB9KTtcblxuICByZXR1cm4gaGFzQWxsUGVybWlzc2lvbnM7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBidWlsZFRyYW5zYWN0aW9uU3BlbmRpbmdMaW1pdFJlc3BvbnNlKFxuICBzcGVuZGluZ0xpbWl0T3B0aW9uczogUGFydGlhbDxUcmFuc2FjdGlvblNwZW5kaW5nTGltaXRSZXNwb25zZU9wdGlvbnM+XG4pOiBUcmFuc2FjdGlvblNwZW5kaW5nTGltaXRSZXNwb25zZSB7XG4gIGlmIChzcGVuZGluZ0xpbWl0T3B0aW9ucy5Jc1VubGltaXRlZCkge1xuICAgIHJldHVybiB7XG4gICAgICBJc1VubGltaXRlZDogdHJ1ZSxcbiAgICB9O1xuICB9XG5cbiAgaWYgKHNwZW5kaW5nTGltaXRPcHRpb25zLkdsb2JhbERFU09MaW1pdD8udG9TdHJpbmcoKSA9PT0gJ1VOTElNSVRFRCcpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAnR2xvYmFsREVTT0xpbWl0IGNhbm5vdCBiZSB1bmxpbWl0ZWQuIFlvdSBtdXN0IHNwZWNpZnkgYSBzcGVjaWZpYyBsaW1pdCwgb3Igc2V0IHRoZSBJc1VubGltaXRlZCBmbGFnIHRvIHRydWUuJ1xuICAgICk7XG4gIH1cblxuICBjb25zdCByZXN1bHQ6IFRyYW5zYWN0aW9uU3BlbmRpbmdMaW1pdFJlc3BvbnNlID0ge307XG5cbiAgd2Fsa09iaihcbiAgICBzcGVuZGluZ0xpbWl0T3B0aW9ucyxcbiAgICAodmFsLCBwYXRoKSA9PiB7XG4gICAgICBzZXREZWVwVmFsdWUocmVzdWx0LCBwYXRoLCB2YWwgPT09ICdVTkxJTUlURUQnID8gMWU5IDogdmFsKTtcbiAgICB9LFxuICAgIFtdXG4gICk7XG5cbiAgaWYgKHJlc3VsdC5BY2Nlc3NHcm91cExpbWl0TWFwKSB7XG4gICAgcmVzdWx0LkFjY2Vzc0dyb3VwTGltaXRNYXAgPSBPYmplY3QudmFsdWVzKHJlc3VsdC5BY2Nlc3NHcm91cExpbWl0TWFwKTtcbiAgfVxuICBpZiAocmVzdWx0LkFjY2Vzc0dyb3VwTWVtYmVyTGltaXRNYXApIHtcbiAgICByZXN1bHQuQWNjZXNzR3JvdXBNZW1iZXJMaW1pdE1hcCA9IE9iamVjdC52YWx1ZXMoXG4gICAgICByZXN1bHQuQWNjZXNzR3JvdXBNZW1iZXJMaW1pdE1hcFxuICAgICk7XG4gIH1cbiAgaWYgKHJlc3VsdC5Bc3NvY2lhdGlvbkxpbWl0TWFwKSB7XG4gICAgcmVzdWx0LkFzc29jaWF0aW9uTGltaXRNYXAgPSBPYmplY3QudmFsdWVzKHJlc3VsdC5Bc3NvY2lhdGlvbkxpbWl0TWFwKTtcbiAgICAvLyBWYWxpZGF0ZSBlYWNoIGFzc29jaWF0aW9uIGxpbWl0IG9iamVjdFxuICAgIHJlc3VsdC5Bc3NvY2lhdGlvbkxpbWl0TWFwLmZvckVhY2goKGFzc29jaWF0aW9uTGltaXRJdGVtKSA9PiB7XG4gICAgICBpZiAoXG4gICAgICAgIGFzc29jaWF0aW9uTGltaXRJdGVtLkFwcFB1YmxpY0tleUJhc2U1OENoZWNrICYmXG4gICAgICAgIGFzc29jaWF0aW9uTGltaXRJdGVtLkFwcFNjb3BlVHlwZSA9PT0gJ0FueSdcbiAgICAgICkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgICAgYEFwcFB1YmxpY0tleUJhc2U1OENoZWNrIG11c3QgYmUgc2V0IHRvIHVuZGVmaW5lZCBvciBhbiBlbXB0eSBzdHJpbmcgaWYgQXBwU2NvcGVUeXBlIGlzIEFueS4gWW91IHByb3ZpZGVkICR7YXNzb2NpYXRpb25MaW1pdEl0ZW0uQXBwUHVibGljS2V5QmFzZTU4Q2hlY2t9YFxuICAgICAgICApO1xuICAgICAgfVxuICAgICAgaWYgKFxuICAgICAgICAhL14oPzpCQzF8dEJDKS4rLy50ZXN0KGFzc29jaWF0aW9uTGltaXRJdGVtLkFwcFB1YmxpY0tleUJhc2U1OENoZWNrKSAmJlxuICAgICAgICBhc3NvY2lhdGlvbkxpbWl0SXRlbS5BcHBTY29wZVR5cGUgPT09ICdTY29wZWQnXG4gICAgICApIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICAgIGBBcHBQdWJsaWNLZXlCYXNlNThDaGVjayBtdXN0IGJlIHNldCB0byBhIHZhbGlkIHB1YmxpYyBrZXkgaWYgQXBwU2NvcGVUeXBlIGlzIFNjb3BlZC4gWW91IHByb3ZpZGVkOiAke2Fzc29jaWF0aW9uTGltaXRJdGVtLkFwcFB1YmxpY0tleUJhc2U1OENoZWNrfWBcbiAgICAgICAgKTtcbiAgICAgIH1cbiAgICB9KTtcbiAgfVxuXG4gIHJlc3VsdC5UcmFuc2FjdGlvbkNvdW50TGltaXRNYXAgPSByZXN1bHQuVHJhbnNhY3Rpb25Db3VudExpbWl0TWFwID8/IHt9O1xuXG4gIGlmIChcbiAgICB0eXBlb2YgcmVzdWx0LlRyYW5zYWN0aW9uQ291bnRMaW1pdE1hcFsnQVVUSE9SSVpFX0RFUklWRURfS0VZJ10gPT09XG4gICAgJ3VuZGVmaW5lZCdcbiAgKSB7XG4gICAgcmVzdWx0LlRyYW5zYWN0aW9uQ291bnRMaW1pdE1hcCA9IHtcbiAgICAgIC4uLnJlc3VsdC5UcmFuc2FjdGlvbkNvdW50TGltaXRNYXAsXG4gICAgICBBVVRIT1JJWkVfREVSSVZFRF9LRVk6IDEsXG4gICAgfTtcbiAgfSBlbHNlIGlmIChyZXN1bHQuVHJhbnNhY3Rpb25Db3VudExpbWl0TWFwWydBVVRIT1JJWkVfREVSSVZFRF9LRVknXSA8IDApIHtcbiAgICBkZWxldGUgcmVzdWx0LlRyYW5zYWN0aW9uQ291bnRMaW1pdE1hcFsnQVVUSE9SSVpFX0RFUklWRURfS0VZJ107XG4gIH1cblxuICByZXR1cm4gcmVzdWx0O1xufVxuXG5mdW5jdGlvbiB3YWxrT2JqKFxuICBub2RlOiBhbnksXG4gIGNhbGxiYWNrOiAodmFsOiBhbnksIHBhdGg6IHN0cmluZ1tdKSA9PiB2b2lkLFxuICBwYXRoOiBzdHJpbmdbXSA9IFtdXG4pIHtcbiAgaWYgKHR5cGVvZiBub2RlID09PSAnb2JqZWN0JyAmJiBub2RlICE9PSBudWxsKSB7XG4gICAgY29uc3Qga2V5cyA9IE9iamVjdC5rZXlzKG5vZGUpO1xuICAgIGZvciAobGV0IGkgPSAwOyBpIDwga2V5cy5sZW5ndGg7IGkrKykge1xuICAgICAgd2Fsa09iaihub2RlW2tleXNbaV1dLCBjYWxsYmFjaywgcGF0aC5jb25jYXQoa2V5c1tpXSkpO1xuICAgIH1cbiAgfSBlbHNlIHtcbiAgICBjYWxsYmFjayhub2RlLCBwYXRoKTtcbiAgfVxufVxuXG5mdW5jdGlvbiBnZXREZWVwVmFsdWUob2JqOiBhbnksIHBhdGg6IHN0cmluZ1tdKTogYW55IHtcbiAgY29uc3QgY3VycktleSA9IHBhdGhbMF07XG5cbiAgaWYgKFxuICAgIG9iaiA9PT0gbnVsbCB8fFxuICAgIHR5cGVvZiBvYmogIT09ICdvYmplY3QnIHx8XG4gICAgdHlwZW9mIG9ialtjdXJyS2V5XSA9PT0gJ3VuZGVmaW5lZCdcbiAgKSB7XG4gICAgcmV0dXJuO1xuICB9XG5cbiAgaWYgKHBhdGgubGVuZ3RoID09PSAxKSB7XG4gICAgcmV0dXJuIG9ialtjdXJyS2V5XTtcbiAgfSBlbHNlIHtcbiAgICByZXR1cm4gZ2V0RGVlcFZhbHVlKG9ialtjdXJyS2V5XSwgcGF0aC5zbGljZSgxKSk7XG4gIH1cbn1cblxuZnVuY3Rpb24gc2V0RGVlcFZhbHVlKG9iajogYW55LCBwYXRoOiBzdHJpbmdbXSwgdmFsdWU6IGFueSkge1xuICBjb25zdCBjdXJyS2V5ID0gcGF0aFswXTtcbiAgaWYgKHR5cGVvZiBvYmpbY3VycktleV0gPT09ICd1bmRlZmluZWQnKSB7XG4gICAgb2JqW2N1cnJLZXldID0ge307XG4gIH1cblxuICBpZiAocGF0aC5sZW5ndGggPT09IDEpIHtcbiAgICBvYmpbY3VycktleV0gPSB2YWx1ZTtcbiAgfSBlbHNlIHtcbiAgICBzZXREZWVwVmFsdWUob2JqW2N1cnJLZXldLCBwYXRoLnNsaWNlKDEpLCB2YWx1ZSk7XG4gIH1cbn1cblxuZnVuY3Rpb24gbm9ybWFsaXplQ291bnQoY291bnQ/OiBudW1iZXIgfCAnVU5MSU1JVEVEJykge1xuICAvLyBOT1RFOiBJZiBjaGVja2luZyBmb3IgdW5saW1pdGVkLCB3ZSBqdXN0IGNoZWNrIGlmIGl0J3MgZ3JlYXRlciB0aGFuIDFcbiAgLy8gYmVjYXVzZSB0aGVyZSBpcyBubyBnb29kIHdheSB0byBrbm93IGlmIHRoZSBvcmlnaW5hbCB2YWx1ZSB3YXMgJ1VOTElNSVRFRCdcbiAgLy8gb3Igc29tZSBvdGhlciBudW1lcmljLiAgQXMgbG9uZyBhcyB0aGUgdmFsdWUgaXMgZ3JlYXRlciB0aGFuIDEsIHdlIGp1c3QgbGV0XG4gIC8vIGl0IHBhc3MgYXMgJ1VOTElNSVRFRC4nIEluIHRoZSBlbmQgdGhpcyBzaG91bGRuJ3QgbWF0dGVyIHNpbmNlIHdlIGZhaWwgdGhlXG4gIC8vIGNoZWNrIGlmIHRoZXJlIGFyZSBubyBtb3JlIHRyYW5zYWN0aW9ucyBsZWZ0IHRvIHNwZW5kLlxuICByZXR1cm4gY291bnQgPT09ICdVTkxJTUlURUQnIHx8IGNvdW50ID09PSAxZTkgPyAxIDogY291bnQgPz8gMDtcbn1cbiJdfQ==