import { hexToBytes } from '@noble/hashes/utils';
import { TransactionMetadataCreatePostAssociation, TransactionMetadataCreateUserAssociation, TransactionMetadataDeletePostAssociation, TransactionMetadataDeleteUserAssociation, bs58PublicKeyToCompressedBytes, encodeUTF8ToBytes, } from '../identity/index.js';
import { constructBalanceModelTx, getTxWithFeeNanos, handleSignAndSubmit, sumTransactionFees, } from '../internal.js';
import { guardTxPermission } from './utils.js';
export const createUserAssociation = async (params, options) => {
    const txWithFee = getTxWithFeeNanos(params.TransactorPublicKeyBase58Check, buildCreateUserAssociationMetadata(params), {
        ExtraData: params.ExtraData,
        MinFeeRateNanosPerKB: params.MinFeeRateNanosPerKB,
        TransactionFees: params.TransactionFees,
    });
    if (options?.checkPermissions !== false) {
        await guardTxPermission({
            GlobalDESOLimit: txWithFee.feeNanos + sumTransactionFees(params.TransactionFees),
            AssociationLimitMap: [
                {
                    AssociationClass: 'User',
                    AssociationType: params.AssociationType,
                    AppScopeType: params.AppPublicKeyBase58Check ? 'Scoped' : 'Any',
                    AppPublicKeyBase58Check: params.AppPublicKeyBase58Check ?? '',
                    AssociationOperation: 'Create',
                    OpCount: options?.txLimitCount ?? 1,
                },
                // NOTE: This is a bit weird, but we don't have AppPublicKeyBase58Check
                // or AssociationType in the delete params, so we just ask for delete
                // permission at the same time the association is created.
                {
                    AssociationClass: 'User',
                    AssociationType: params.AssociationType,
                    AppScopeType: params.AppPublicKeyBase58Check ? 'Scoped' : 'Any',
                    AppPublicKeyBase58Check: params.AppPublicKeyBase58Check ?? '',
                    AssociationOperation: 'Delete',
                    OpCount: options?.txLimitCount ?? 1,
                },
            ],
        });
    }
    return handleSignAndSubmit('api/v0/user-associations/create', params, {
        ...options,
        constructionFunction: constructCreateUserAssociationTransaction,
    });
};
const buildCreateUserAssociationMetadata = (params) => {
    const metadata = new TransactionMetadataCreateUserAssociation();
    metadata.appPublicKey = bs58PublicKeyToCompressedBytes(params.AppPublicKeyBase58Check || '');
    metadata.associationType = encodeUTF8ToBytes(params.AssociationType);
    metadata.associationValue = encodeUTF8ToBytes(params.AssociationValue);
    metadata.targetUserPublicKey = bs58PublicKeyToCompressedBytes(params.TargetUserPublicKeyBase58Check);
    return metadata;
};
export const constructCreateUserAssociationTransaction = (params) => {
    return constructBalanceModelTx(params.TransactorPublicKeyBase58Check, buildCreateUserAssociationMetadata(params), {
        ExtraData: params.ExtraData,
        MinFeeRateNanosPerKB: params.MinFeeRateNanosPerKB,
        TransactionFees: params.TransactionFees,
    });
};
export const deleteUserAssociation = async (params, options) => {
    return handleSignAndSubmit('api/v0/user-associations/delete', params, {
        ...options,
        constructionFunction: constructDeleteUserAssociationTransaction,
    });
};
const buildDeleteUserAssociationMetadata = (params) => {
    const metadata = new TransactionMetadataDeleteUserAssociation();
    metadata.associationID = encodeUTF8ToBytes(params.AssociationID);
    return metadata;
};
export const constructDeleteUserAssociationTransaction = (params) => {
    return constructBalanceModelTx(params.TransactorPublicKeyBase58Check, buildDeleteUserAssociationMetadata(params), {
        ExtraData: params.ExtraData,
        MinFeeRateNanosPerKB: params.MinFeeRateNanosPerKB,
        TransactionFees: params.TransactionFees,
    });
};
export const createPostAssociation = async (params, options) => {
    const txWithFee = getTxWithFeeNanos(params.TransactorPublicKeyBase58Check, buildCreatePostAssociationMetadata(params), {
        ExtraData: params.ExtraData,
        MinFeeRateNanosPerKB: params.MinFeeRateNanosPerKB,
        TransactionFees: params.TransactionFees,
    });
    if (options?.checkPermissions !== false) {
        await guardTxPermission({
            GlobalDESOLimit: txWithFee.feeNanos + sumTransactionFees(params.TransactionFees),
            AssociationLimitMap: [
                {
                    AssociationClass: 'Post',
                    AssociationType: params.AssociationType,
                    AppScopeType: params.AppPublicKeyBase58Check ? 'Scoped' : 'Any',
                    AppPublicKeyBase58Check: params.AppPublicKeyBase58Check ?? '',
                    AssociationOperation: 'Create',
                    OpCount: options?.txLimitCount ?? 1,
                },
                // NOTE: This is a bit weird, but we don't have AppPublicKeyBase58Check
                // or AssociationType in the delete params, so we just ask for delete
                // permission at the same time the association is created.
                {
                    AssociationClass: 'Post',
                    AssociationType: params.AssociationType,
                    AppScopeType: params.AppPublicKeyBase58Check ? 'Scoped' : 'Any',
                    AppPublicKeyBase58Check: params.AppPublicKeyBase58Check ?? '',
                    AssociationOperation: 'Delete',
                    OpCount: options?.txLimitCount ?? 1,
                },
            ],
        });
    }
    return handleSignAndSubmit('api/v0/post-associations/create', params, {
        ...options,
        constructionFunction: constructCreatePostAssociationTransaction,
    });
};
const buildCreatePostAssociationMetadata = (params) => {
    const metadata = new TransactionMetadataCreatePostAssociation();
    metadata.appPublicKey = bs58PublicKeyToCompressedBytes(params.AppPublicKeyBase58Check || '');
    metadata.associationType = encodeUTF8ToBytes(params.AssociationType);
    metadata.associationValue = encodeUTF8ToBytes(params.AssociationValue);
    metadata.postHash = hexToBytes(params.PostHashHex);
    return metadata;
};
export const constructCreatePostAssociationTransaction = (params) => {
    return constructBalanceModelTx(params.TransactorPublicKeyBase58Check, buildCreatePostAssociationMetadata(params), {
        ExtraData: params.ExtraData,
        MinFeeRateNanosPerKB: params.MinFeeRateNanosPerKB,
        TransactionFees: params.TransactionFees,
    });
};
export const deletePostAssociation = (params, options) => {
    return handleSignAndSubmit('api/v0/post-associations/delete', params, {
        ...options,
        constructionFunction: constructDeletePostAssociationTransaction,
    });
};
export const constructDeletePostAssociationTransaction = (params) => {
    const metadata = new TransactionMetadataDeletePostAssociation();
    metadata.associationID = encodeUTF8ToBytes(params.AssociationID);
    return constructBalanceModelTx(params.TransactorPublicKeyBase58Check, metadata, {
        ExtraData: params.ExtraData,
        MinFeeRateNanosPerKB: params.MinFeeRateNanosPerKB,
        TransactionFees: params.TransactionFees,
    });
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXNzb2NpYXRpb25zLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vc3JjL3RyYW5zYWN0aW9ucy9hc3NvY2lhdGlvbnMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLHFCQUFxQixDQUFDO0FBV2pELE9BQU8sRUFDTCx3Q0FBd0MsRUFDeEMsd0NBQXdDLEVBQ3hDLHdDQUF3QyxFQUN4Qyx3Q0FBd0MsRUFDeEMsOEJBQThCLEVBQzlCLGlCQUFpQixHQUNsQixNQUFNLHNCQUFzQixDQUFDO0FBQzlCLE9BQU8sRUFDTCx1QkFBdUIsRUFDdkIsaUJBQWlCLEVBQ2pCLG1CQUFtQixFQUNuQixrQkFBa0IsR0FDbkIsTUFBTSxnQkFBZ0IsQ0FBQztBQUV4QixPQUFPLEVBQUUsaUJBQWlCLEVBQUUsTUFBTSxZQUFZLENBQUM7QUFnQi9DLE1BQU0sQ0FBQyxNQUFNLHFCQUFxQixHQUFHLEtBQUssRUFDeEMsTUFBMEMsRUFDMUMsT0FBMEIsRUFDa0MsRUFBRTtJQUM5RCxNQUFNLFNBQVMsR0FBRyxpQkFBaUIsQ0FDakMsTUFBTSxDQUFDLDhCQUE4QixFQUNyQyxrQ0FBa0MsQ0FBQyxNQUFNLENBQUMsRUFDMUM7UUFDRSxTQUFTLEVBQUUsTUFBTSxDQUFDLFNBQVM7UUFDM0Isb0JBQW9CLEVBQUUsTUFBTSxDQUFDLG9CQUFvQjtRQUNqRCxlQUFlLEVBQUUsTUFBTSxDQUFDLGVBQWU7S0FDeEMsQ0FDRixDQUFDO0lBRUYsSUFBSSxPQUFPLEVBQUUsZ0JBQWdCLEtBQUssS0FBSyxFQUFFO1FBQ3ZDLE1BQU0saUJBQWlCLENBQUM7WUFDdEIsZUFBZSxFQUNiLFNBQVMsQ0FBQyxRQUFRLEdBQUcsa0JBQWtCLENBQUMsTUFBTSxDQUFDLGVBQWUsQ0FBQztZQUNqRSxtQkFBbUIsRUFBRTtnQkFDbkI7b0JBQ0UsZ0JBQWdCLEVBQUUsTUFBTTtvQkFDeEIsZUFBZSxFQUFFLE1BQU0sQ0FBQyxlQUFlO29C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LG9CQUFvQjtRQUNqRCxlQUFlLEVBQUUsTUFBTSxDQUFDLGVBQWU7S0FDeEMsQ0FDRixDQUFDO0FBQ0osQ0FBQyxDQUFDO0FBYUYsTUFBTSxDQUFDLE1BQU0scUJBQXFCLEdBQUcsQ0FDbkMsTUFBMEMsRUFDMUMsT0FBd0IsRUFDb0MsRUFBRTtJQUM5RCxPQUFPLG1CQUFtQixDQUFDLGlDQUFpQyxFQUFFLE1BQU0sRUFBRTtRQUNwRSxHQUFHLE9BQU87UUFDVixvQkFBb0IsRUFBRSx5Q0FBeUM7S0FDaEUsQ0FBQyxDQUFDO0FBQ0wsQ0FBQyxDQUFDO0FBRUYsTUFBTSxDQUFDLE1BQU0seUNBQXlDLEdBQUcsQ0FDdkQsTUFBMEMsRUFDRCxFQUFFO0lBQzNDLE1BQU0sUUFBUSxHQUFHLElBQUksd0NBQXdDLEVBQUUsQ0FBQztJQUNoRSxRQUFRLENBQUMsYUFBYSxHQUFHLGlCQUFpQixDQUFDLE1BQU0sQ0FBQyxhQUFhLENBQUMsQ0FBQztJQUNqRSxPQUFPLHVCQUF1QixDQUM1QixNQUFNLENBQUMsOEJBQThCLEVBQ3JDLFFBQVEsRUFDUjtRQUNFLFNBQVMsRUFBRSxNQUFNLENBQUMsU0FBUztRQUMzQixvQkFBb0IsRUFBRSxNQUFNLENBQUMsb0JBQW9CO1FBQ2pELGVBQWUsRUFBRSxNQUFNLENBQUMsZUFBZTtLQUN4QyxDQUNGLENBQUM7QUFDSixDQUFDLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBoZXhUb0J5dGVzIH0gZnJvbSAnQG5vYmxlL2hhc2hlcy91dGlscyc7XG5pbXBvcnQge1xuICBBc3NvY2lhdGlvblR4blJlc3BvbnNlLFxuICBDb25zdHJ1Y3RlZFRyYW5zYWN0aW9uUmVzcG9uc2UsXG4gIENyZWF0ZVBvc3RBc3NvY2lhdGlvblJlcXVlc3QsXG4gIENyZWF0ZVVzZXJBc3NvY2lhdGlvblJlcXVlc3QsXG4gIERlbGV0ZUFzc29jaWF0aW9uUmVxdWVzdCxcbiAgUmVxdWVzdE9wdGlvbnMsXG4gIFR4UmVxdWVzdFdpdGhPcHRpb25hbEZlZXNBbmRFeHRyYURhdGEsXG59IGZyb20gJy4uL2JhY2tlbmQtdHlwZXMvaW5kZXguanMnO1xuaW1wb3J0IHsgUGFydGlhbFdpdGhSZXF1aXJlZEZpZWxkcyB9IGZyb20gJy4uL2RhdGEvaW5kZXguanMnO1xuaW1wb3J0IHtcbiAgVHJhbnNhY3Rpb25NZXRhZGF0YUNyZWF0ZVBvc3RBc3NvY2lhdGlvbixcbiAgVHJhbnNhY3Rpb25NZXRhZGF0YUNyZWF0ZVVzZXJBc3NvY2lhdGlvbixcbiAgVHJhbnNhY3Rpb25NZXRhZGF0YURlbGV0ZVBvc3RBc3NvY2lhdGlvbixcbiAgVHJhbnNhY3Rpb25NZXRhZGF0YURlbGV0ZVVzZXJBc3NvY2lhdGlvbixcbiAgYnM1OFB1YmxpY0tleVRvQ29tcHJlc3NlZEJ5dGVzLFxuICBlbmNvZGVVVEY4VG9CeXRlcyxcbn0gZnJvbSAnLi4vaWRlbnRpdHkvaW5kZXguanMnO1xuaW1wb3J0IHtcbiAgY29uc3RydWN0QmFsYW5jZU1vZGVsVHgsXG4gIGdldFR4V2l0aEZlZU5hbm9zLFxuICBoYW5kbGVTaWduQW5kU3VibWl0LFxuICBzdW1UcmFuc2FjdGlvbkZlZXMsXG59IGZyb20gJy4uL2ludGVybmFsLmpzJztcbmltcG9ydCB7IENvbnN0cnVjdGVkQW5kU3VibWl0dGVkVHgsIFR4UmVxdWVzdE9wdGlvbnMgfSBmcm9tICcuLi90eXBlcy5qcyc7XG5pbXBvcnQgeyBndWFyZFR4UGVybWlzc2lvbiB9IGZyb20gJy4vdXRpbHMuanMnO1xuXG4vKipcbiAqIGh0dHBzOi8vZG9jcy5kZXNvLm9yZy9kZXNvLWJhY2tlbmQvY29uc3RydWN0LXRyYW5zYWN0aW9ucy9hc3NvY2lhdGlvbnMtdHJhbnNhY3Rpb25zLWFwaSNjcmVhdGUtdXNlci1hc3NvY2lhdGlvblxuICovXG5cbmV4cG9ydCB0eXBlIENyZWF0ZVVzZXJBc3NvY2lhdGlvblJlcXVlc3RQYXJhbXMgPVxuICBUeFJlcXVlc3RXaXRoT3B0aW9uYWxGZWVzQW5kRXh0cmFEYXRhPFxuICAgIFBhcnRpYWxXaXRoUmVxdWlyZWRGaWVsZHM8XG4gICAgICBDcmVhdGVVc2VyQXNzb2NpYXRpb25SZXF1ZXN0LFxuICAgICAgfCAnVGFyZ2V0VXNlclB1YmxpY0tleUJhc2U1OENoZWNrJ1xuICAgICAgfCAnVHJhbnNhY3RvclB1YmxpY0tleUJhc2U1OENoZWNrJ1xuICAgICAgfCAnQXNzb2NpYXRpb25UeXBlJ1xuICAgICAgfCAnQXNzb2NpYXRpb25WYWx1ZSdcbiAgICA+XG4gID47XG5leHBvcnQgY29uc3QgY3JlYXRlVXNlckFzc29jaWF0aW9uID0gYXN5bmMgKFxuICBwYXJhbXM6IENyZWF0ZVVzZXJBc3NvY2lhdGlvblJlcXVlc3RQYXJhbXMsXG4gIG9wdGlvbnM/OiBUeFJlcXVlc3RPcHRpb25zXG4pOiBQcm9taXNlPENvbnN0cnVjdGVkQW5kU3VibWl0dGVkVHg8QXNzb2NpYXRpb25UeG5SZXNwb25zZT4+ID0+IHtcbiAgY29uc3QgdHhXaXRoRmVlID0gZ2V0VHhXaXRoRmVlTmFub3MoXG4gICAgcGFyYW1zLlRyYW5zYWN0b3JQdWJsaWNLZXlCYXNlNThDaGVjayxcbiAgICBidWlsZENyZWF0ZVVzZXJBc3NvY2lhdGlvbk1ldGFkYXRhKHBhcmFtcyksXG4gICAge1xuICAgICAgRXh0cmFEYXRhOiBwYXJhbXMuRXh0cmFEYXRhLFxuICAgICAgTWluRmVlUmF0ZU5hbm9zUGVyS0I6IHBhcmFtcy5NaW5GZWVSYXRlTmFub3NQZXJLQixcbiAgICAgIFRyYW5zYWN0aW9uRmVlczogcGFyYW1zLlRyYW5zYWN0aW9uRmVlcyxcbiAgICB9XG4gICk7XG5cbiAgaWYgKG9wdGlvbnM/LmNoZWNrUGVybWlzc2lvbnMgIT09IGZhbHNlKSB7XG4gICAgYXdhaXQgZ3VhcmRUeFBlcm1pc3Npb24oe1xuICAgICAgR2xvYmFsREVTT0xpbWl0OlxuICAgICAgICB0eFdpdGhGZWUuZmVlTmFub3MgKyBzdW1UcmFuc2FjdGlvbkZlZXMocGFyYW1zLlRyYW5zYWN0aW9uRmVlcyksXG4gICAgICBBc3NvY2lhdGlvbkxpbWl0TWFwOiBbXG4gICAgICAgIHtcbiAgICAgICAgICBBc3NvY2lhdGlvbkNsYXNzOiAnVXNlcicsXG4gICAgICAgICAgQXNzb2NpYXRpb25UeXBlOiBwYXJhbXMuQXNzb2NpYXRpb25UeXBlLFxuICAgICAgICAgIEFwcFNjb3BlVHlwZTogcGFyYW1zLkFwcFB1YmxpY0tleUJhc2U1OENoZWNrID8gJ1Njb3BlZCcgOiAnQW55JyxcbiAgICAgICAgICBBcHBQdWJsaWNLZXlCYXNlNThDaGVjazogcGFyYW1zLkFwcFB1YmxpY0tleUJhc2U1OENoZWNrID8/ICcnLFxuICAgICAgICAgIEFzc29jaWF0aW9uT3BlcmF0aW9uOiAnQ3JlYXRlJyxcbiAgICAgICAgICBPcENvdW50OiBvcHRpb25zPy50eExpbWl0Q291bnQgPz8gMSxcbiAgICAgICAgfSxcbiAgICAgICAgLy8gTk9URTogVGhpcyBpcyBhIGJpdCB3ZWlyZCwgYnV0IHdlIGRvbid0IGhhdmUgQXBwUHVibGljS2V5QmFzZTU4Q2hlY2tcbiAgICAgICAgLy8gb3IgQXNzb2NpYXRpb25UeXBlIGluIHRoZSBkZWxldGUgcGFyYW1zLCBzbyB3ZSBqdXN0IGFzayBmb3IgZGVsZXRlXG4gICAgICAgIC8vIHBlcm1pc3Npb24gYXQgdGhlIHNhbWUgdGltZSB0aGUgYXNzb2NpYXRpb24gaXMgY3JlYXRlZC5cbiAgICAgICAge1xuICAgICAgICAgIEFzc29jaWF0aW9uQ2xhc3M6ICdVc2VyJyxcbiAgICAgICAgICBBc3NvY2lhdGlvblR5cGU6IHBhcmFtcy5Bc3NvY2lhdGlvblR5cGUsXG4gICAgICAgICAgQXBwU2NvcGVUeXBlOiBwYXJhbXMuQXBwUHVibGljS2V5QmFzZTU4Q2hlY2sgPyAnU2NvcGVkJyA6ICdBbnknLFxuICAgICAgICAgIEFwcFB1YmxpY0tleUJhc2U1OENoZWNrOiBwYXJhbXMuQXBwUHVibGljS2V5QmFzZTU4Q2hlY2sgPz8gJycsXG4gICAgICAgICAgQXNzb2NpYXRpb25PcGVyYXRpb246ICdEZWxldGUnLFxuICAgICAgICAgIE9wQ291bnQ6IG9wdGlvbnM/LnR4TGltaXRDb3VudCA/PyAxLFxuICAgICAgICB9LFxuICAgICAgXSxcbiAgICB9KTtcbiAgfVxuXG4gIHJldHVybiBoYW5kbGVTaWduQW5kU3VibWl0KCdhcGkvdjAvdXNlci1hc3NvY2lhdGlvbnMvY3JlYXRlJywgcGFyYW1zLCB7XG4gICAgLi4ub3B0aW9ucyxcbiAgICBjb25zdHJ1Y3Rpb25GdW5jdGlvbjogY29uc3RydWN0Q3JlYXRlVXNlckFzc29jaWF0aW9uVHJhbnNhY3Rpb24sXG4gIH0pO1xufTtcblxuY29uc3QgYnVpbGRDcmVhdGVVc2VyQXNzb2NpYXRpb25NZXRhZGF0YSA9IChcbiAgcGFyYW1zOiBDcmVhdGVVc2VyQXNzb2NpYXRpb25SZXF1ZXN0UGFyYW1zXG4pID0+IHtcbiAgY29uc3QgbWV0YWRhdGEgPSBuZXcgVHJhbnNhY3Rpb25NZXRhZGF0YUNyZWF0ZVVzZXJBc3NvY2lhdGlvbigpO1xuICBtZXRhZGF0YS5hcHBQdWJsaWNLZXkgPSBiczU4UHVibGljS2V5VG9Db21wcmVzc2VkQnl0ZXMoXG4gICAgcGFyYW1zLkFwcFB1YmxpY0tleUJhc2U1OENoZWNrIHx8ICcnXG4gICk7XG4gIG1ldGFkYXRhLmFzc29jaWF0aW9uVHlwZSA9IGVuY29kZVVURjhUb0J5dGVzKHBhcmFtcy5Bc3NvY2lhdGlvblR5cGUpO1xuICBtZXRhZGF0YS5hc3NvY2lhdGlvblZhbHVlID0gZW5jb2RlVVRGOFRvQnl0ZXMocGFyYW1zLkFzc29jaWF0aW9uVmFsdWUpO1xuICBtZXRhZGF0YS50YXJnZXRVc2VyUHVibGljS2V5ID0gYnM1OFB1YmxpY0tleVRvQ29tcHJlc3NlZEJ5dGVzKFxuICAgIHBhcmFtcy5UYXJnZXRVc2VyUHVibGljS2V5QmFzZTU4Q2hlY2tcbiAgKTtcblxuICByZXR1cm4gbWV0YWRhdGE7XG59O1xuXG5leHBvcnQgY29uc3QgY29uc3RydWN0Q3JlYXRlVXNlckFzc29jaWF0aW9uVHJhbnNhY3Rpb24gPSAoXG4gIHBhcmFtczogQ3JlYXRlVXNlckFzc29jaWF0aW9uUmVxdWVzdFBhcmFtc1xuKTogUHJvbWlzZTxDb25zdHJ1Y3RlZFRyYW5zYWN0aW9uUmVzcG9uc2U+ID0+IHtcbiAgcmV0dXJuIGNvbnN0cnVjdEJhbGFuY2VNb2RlbFR4KFxuICAgIHBhcmFtcy5UcmFuc2FjdG9yUHVibGljS2V5QmFzZTU4Q2hlY2ssXG4gICAgYnVpbGRDcmVhdGVVc2VyQXNzb2NpYXRpb25NZXRhZGF0YShwYXJhbXMpLFxuICAgIHtcbiAgICAgIEV4dHJhRGF0YTogcGFyYW1zLkV4dHJhRGF0YSxcbiAgICAgIE1pbkZlZVJhdGVOYW5vc1BlcktCOiBwYXJhbXMuTWluRmVlUmF0ZU5hbm9zUGVyS0IsXG4gICAgICBUcmFuc2FjdGlvbkZlZXM6IHBhcmFtcy5UcmFuc2FjdGlvbkZlZXMsXG4gICAgfVxuICApO1xufTtcblxuLyoqXG4gKiBodHRwczovL2RvY3MuZGVzby5vcmcvZGVzby1iYWNrZW5kL2NvbnN0cnVjdC10cmFuc2FjdGlvbnMvYXNzb2NpYXRpb25zLXRyYW5zYWN0aW9ucy1hcGkjZGVsZXRlLXVzZXItYXNzb2NpYXRpb25cbiAqL1xuXG5leHBvcnQgdHlwZSBEZWxldGVVc2VyQXNzb2NpYXRpb25SZXF1ZXN0UGFyYW1zID1cbiAgVHhSZXF1ZXN0V2l0aE9wdGlvbmFsRmVlc0FuZEV4dHJhRGF0YTxcbiAgICBQYXJ0aWFsV2l0aFJlcXVpcmVkRmllbGRzPFxuICAgICAgRGVsZXRlQXNzb2NpYXRpb25SZXF1ZXN0LFxuICAgICAgJ1RyYW5zYWN0b3JQdWJsaWNLZXlCYXNlNThDaGVjaycgfCAnQXNzb2NpYXRpb25JRCdcbiAgICA+XG4gID47XG5cbmV4cG9ydCBjb25zdCBkZWxldGVVc2VyQXNzb2NpYXRpb24gPSBhc3luYyAoXG4gIHBhcmFtczogRGVsZXRlVXNlckFzc29jaWF0aW9uUmVxdWVzdFBhcmFtcyxcbiAgb3B0aW9ucz86IFR4UmVxdWVzdE9wdGlvbnNcbik6IFByb21pc2U8Q29uc3RydWN0ZWRBbmRTdWJtaXR0ZWRUeDxBc3NvY2lhdGlvblR4blJlc3BvbnNlPj4gPT4ge1xuICByZXR1cm4gaGFuZGxlU2lnbkFuZFN1Ym1pdCgnYXBpL3YwL3VzZXItYXNzb2NpYXRpb25zL2RlbGV0ZScsIHBhcmFtcywge1xuICAgIC4uLm9wdGlvbnMsXG4gICAgY29uc3RydWN0aW9uRnVuY3Rpb246IGNvbnN0cnVjdERlbGV0ZVVzZXJBc3NvY2lhdGlvblRyYW5zYWN0aW9uLFxuICB9KTtcbn07XG5cbmNvbnN0IGJ1aWxkRGVsZXRlVXNlckFzc29jaWF0aW9uTWV0YWRhdGEgPSAoXG4gIHBhcmFtczogRGVsZXRlUG9zdEFzc29jaWF0aW9uUmVxdWVzdFBhcmFtc1xuKSA9PiB7XG4gIGNvbnN0IG1ldGFkYXRhID0gbmV3IFRyYW5zYWN0aW9uTWV0YWRhdGFEZWxldGVVc2VyQXNzb2NpYXRpb24oKTtcbiAgbWV0YWRhdGEuYXNzb2NpYXRpb25JRCA9IGVuY29kZVVURjhUb0J5dGVzKHBhcmFtcy5Bc3NvY2lhdGlvbklEKTtcbiAgcmV0dXJuIG1ldGFkYXRhO1xufTtcblxuZXhwb3J0IGNvbnN0IGNvbnN0cnVjdERlbGV0ZVVzZXJBc3NvY2lhdGlvblRyYW5zYWN0aW9uID0gKFxuICBwYXJhbXM6IERlbGV0ZVVzZXJBc3NvY2lhdGlvblJlcXVlc3RQYXJhbXNcbik6IFByb21pc2U8Q29uc3RydWN0ZWRUcmFuc2FjdGlvblJlc3BvbnNlPiA9PiB7XG4gIHJldHVybiBjb25zdHJ1Y3RCYWxhbmNlTW9kZWxUeChcbiAgICBwYXJhbXMuVHJhbnNhY3RvclB1YmxpY0tleUJhc2U1OENoZWNrLFxuICAgIGJ1aWxkRGVsZXRlVXNlckFzc29jaWF0aW9uTWV0YWRhdGEocGFyYW1zKSxcbiAgICB7XG4gICAgICBFeHRyYURhdGE6IHBhcmFtcy5FeHRyYURhdGEsXG4gICAgICBNaW5GZWVSYXRlTmFub3NQZXJLQjogcGFyYW1zLk1pbkZlZVJhdGVOYW5vc1BlcktCLFxuICAgICAgVHJhbnNhY3Rpb25GZWVzOiBwYXJhbXMuVHJhbnNhY3Rpb25GZWVzLFxuICAgIH1cbiAgKTtcbn07XG5cbi8qKlxuICogaHR0cHM6Ly9kb2NzLmRlc28ub3JnL2Rlc28tYmFja2VuZC9jb25zdHJ1Y3QtdHJhbnNhY3Rpb25zL2Fzc29jaWF0aW9ucy10cmFuc2FjdGlvbnMtYXBpI2NyZWF0ZS1wb3N0LWFzc29jaWF0aW9uXG4gKi9cbmV4cG9ydCB0eXBlIENyZWF0ZVBvc3RBc3NvY2lhdGlvblJlcXVlc3RQYXJhbXMgPVxuICBUeFJlcXVlc3RXaXRoT3B0aW9uYWxGZWVzQW5kRXh0cmFEYXRhPFxuICAgIFBhcnRpYWxXaXRoUmVxdWlyZWRGaWVsZHM8XG4gICAgICBDcmVhdGVQb3N0QXNzb2NpYXRpb25SZXF1ZXN0LFxuICAgICAgfCAnUG9zdEhhc2hIZXgnXG4gICAgICB8ICdUcmFuc2FjdG9yUHVibGljS2V5QmFzZTU4Q2hlY2snXG4gICAgICB8ICdBc3NvY2lhdGlvblR5cGUnXG4gICAgICB8ICdBc3NvY2lhdGlvblZhbHVlJ1xuICAgID5cbiAgPjtcbmV4cG9ydCBjb25zdCBjcmVhdGVQb3N0QXNzb2NpYXRpb24gPSBhc3luYyAoXG4gIHBhcmFtczogQ3JlYXRlUG9zdEFzc29jaWF0aW9uUmVxdWVzdFBhcmFtcyxcbiAgb3B0aW9ucz86IFR4UmVxdWVzdE9wdGlvbnNcbik6IFByb21pc2U8Q29uc3RydWN0ZWRBbmRTdWJtaXR0ZWRUeDxBc3NvY2lhdGlvblR4blJlc3BvbnNlPj4gPT4ge1xuICBjb25zdCB0eFdpdGhGZWUgPSBnZXRUeFdpdGhGZWVOYW5vcyhcbiAgICBwYXJhbXMuVHJhbnNhY3RvclB1YmxpY0tleUJhc2U1OENoZWNrLFxuICAgIGJ1aWxkQ3JlYXRlUG9zdEFzc29jaWF0aW9uTWV0YWRhdGEocGFyYW1zKSxcbiAgICB7XG4gICAgICBFeHRyYURhdGE6IHBhcmFtcy5FeHRyYURhdGEsXG4gICAgICBNaW5GZWVSYXRlTmFub3NQZXJLQjogcGFyYW1zLk1pbkZlZVJhdGVOYW5vc1BlcktCLFxuICAgICAgVHJhbnNhY3Rpb25GZWVzOiBwYXJhbXMuVHJhbnNhY3Rpb25GZWVzLFxuICAgIH1cbiAgKTtcblxuICBpZiAob3B0aW9ucz8uY2hlY2tQZXJtaXNzaW9ucyAhPT0gZmFsc2UpIHtcbiAgICBhd2FpdCBndWFyZFR4UGVybWlzc2lvbih7XG4gICAgICBHbG9iYWxERVNPTGltaXQ6XG4gICAgICAgIHR4V2l0aEZlZS5mZWVOYW5vcyArIHN1bVRyYW5zYWN0aW9uRmVlcyhwYXJhbXMuVHJhbnNhY3Rpb25GZWVzKSxcbiAgICAgIEFzc29jaWF0aW9uTGltaXRNYXA6IFtcbiAgICAgICAge1xuICAgICAgICAgIEFzc29jaWF0aW9uQ2xhc3M6ICdQb3N0JyxcbiAgICAgICAgICBBc3NvY2lhdGlvblR5cGU6IHBhcmFtcy5Bc3NvY2lhdGlvblR5cGUsXG4gICAgICAgICAgQXBwU2NvcGVUeXBlOiBwYXJhbXMuQXBwUHVibGljS2V5QmFzZTU4Q2hlY2sgPyAnU2NvcGVkJyA6ICdBbnknLFxuICAgICAgICAgIEFwcFB1YmxpY0tleUJhc2U1OENoZWNrOiBwYXJhbXMuQXBwUHVibGljS2V5QmFzZTU4Q2hlY2sgPz8gJycsXG4gICAgICAgICAgQXNzb2NpYXRpb25PcGVyYXRpb246ICdDcmVhdGUnLFxuICAgICAgICAgIE9wQ291bnQ6IG9wdGlvbnM/LnR4TGltaXRDb3VudCA/PyAxLFxuICAgICAgICB9LFxuICAgICAgICAvLyBOT1RFOiBUaGlzIGlzIGEgYml0IHdlaXJkLCBidXQgd2UgZG9uJ3QgaGF2ZSBBcHBQdWJsaWNLZXlCYXNlNThDaGVja1xuICAgICAgICAvLyBvciBBc3NvY2lhdGlvblR5cGUgaW4gdGhlIGRlbGV0ZSBwYXJhbXMsIHNvIHdlIGp1c3QgYXNrIGZvciBkZWxldGVcbiAgICAgICAgLy8gcGVybWlzc2lvbiBhdCB0aGUgc2FtZSB0aW1lIHRoZSBhc3NvY2lhdGlvbiBpcyBjcmVhdGVkLlxuICAgICAgICB7XG4gICAgICAgICAgQXNzb2NpYXRpb25DbGFzczogJ1Bvc3QnLFxuICAgICAgICAgIEFzc29jaWF0aW9uVHlwZTogcGFyYW1zLkFzc29jaWF0aW9uVHlwZSxcbiAgICAgICAgICBBcHBTY29wZVR5cGU6IHBhcmFtcy5BcHBQdWJsaWNLZXlCYXNlNThDaGVjayA/ICdTY29wZWQnIDogJ0FueScsXG4gICAgICAgICAgQXBwUHVibGljS2V5QmFzZTU4Q2hlY2s6IHBhcmFtcy5BcHBQdWJsaWNLZXlCYXNlNThDaGVjayA/PyAnJyxcbiAgICAgICAgICBBc3NvY2lhdGlvbk9wZXJhdGlvbjogJ0RlbGV0ZScsXG4gICAgICAgICAgT3BDb3VudDogb3B0aW9ucz8udHhMaW1pdENvdW50ID8/IDEsXG4gICAgICAgIH0sXG4gICAgICBdLFxuICAgIH0pO1xuICB9XG5cbiAgcmV0dXJuIGhhbmRsZVNpZ25BbmRTdWJtaXQoJ2FwaS92MC9wb3N0LWFzc29jaWF0aW9ucy9jcmVhdGUnLCBwYXJhbXMsIHtcbiAgICAuLi5vcHRpb25zLFxuICAgIGNvbnN0cnVjdGlvbkZ1bmN0aW9uOiBjb25zdHJ1Y3RDcmVhdGVQb3N0QXNzb2NpYXRpb25UcmFuc2FjdGlvbixcbiAgfSk7XG59O1xuXG5jb25zdCBidWlsZENyZWF0ZVBvc3RBc3NvY2lhdGlvbk1ldGFkYXRhID0gKFxuICBwYXJhbXM6IENyZWF0ZVBvc3RBc3NvY2lhdGlvblJlcXVlc3RQYXJhbXNcbikgPT4ge1xuICBjb25zdCBtZXRhZGF0YSA9IG5ldyBUcmFuc2FjdGlvbk1ldGFkYXRhQ3JlYXRlUG9zdEFzc29jaWF0aW9uKCk7XG4gIG1ldGFkYXRhLmFwcFB1YmxpY0tleSA9IGJzNThQdWJsaWNLZXlUb0NvbXByZXNzZWRCeXRlcyhcbiAgICBwYXJhbXMuQXBwUHVibGljS2V5QmFzZTU4Q2hlY2sgfHwgJydcbiAgKTtcbiAgbWV0YWRhdGEuYXNzb2NpYXRpb25UeXBlID0gZW5jb2RlVVRGOFRvQnl0ZXMocGFyYW1zLkFzc29jaWF0aW9uVHlwZSk7XG4gIG1ldGFkYXRhLmFzc29jaWF0aW9uVmFsdWUgPSBlbmNvZGVVVEY4VG9CeXRlcyhwYXJhbXMuQXNzb2NpYXRpb25WYWx1ZSk7XG4gIG1ldGFkYXRhLnBvc3RIYXNoID0gaGV4VG9CeXRlcyhwYXJhbXMuUG9zdEhhc2hIZXgpO1xuXG4gIHJldHVybiBtZXRhZGF0YTtcbn07XG5cbmV4cG9ydCBjb25zdCBjb25zdHJ1Y3RDcmVhdGVQb3N0QXNzb2NpYXRpb25UcmFuc2FjdGlvbiA9IChcbiAgcGFyYW1zOiBDcmVhdGVQb3N0QXNzb2NpYXRpb25SZXF1ZXN0UGFyYW1zXG4pOiBQcm9taXNlPENvbnN0cnVjdGVkVHJhbnNhY3Rpb25SZXNwb25zZT4gPT4ge1xuICByZXR1cm4gY29uc3RydWN0QmFsYW5jZU1vZGVsVHgoXG4gICAgcGFyYW1zLlRyYW5zYWN0b3JQdWJsaWNLZXlCYXNlNThDaGVjayxcbiAgICBidWlsZENyZWF0ZVBvc3RBc3NvY2lhdGlvbk1ldGFkYXRhKHBhcmFtcyksXG4gICAge1xuICAgICAgRXh0cmFEYXRhOiBwYXJhbXMuRXh0cmFEYXRhLFxuICAgICAgTWluRmVlUmF0ZU5hbm9zUGVyS0I6IHBhcmFtcy5NaW5GZWVSYXRlTmFub3NQZXJLQixcbiAgICAgIFRyYW5zYWN0aW9uRmVlczogcGFyYW1zLlRyYW5zYWN0aW9uRmVlcyxcbiAgICB9XG4gICk7XG59O1xuXG4vKipcbiAqIGh0dHBzOi8vZG9jcy5kZXNvLm9yZy9kZXNvLWJhY2tlbmQvY29uc3RydWN0LXRyYW5zYWN0aW9ucy9hc3NvY2lhdGlvbnMtdHJhbnNhY3Rpb25zLWFwaSNkZWxldGUtcG9zdC1hc3NvY2lhdGlvblxuICovXG5leHBvcnQgdHlwZSBEZWxldGVQb3N0QXNzb2NpYXRpb25SZXF1ZXN0UGFyYW1zID1cbiAgVHhSZXF1ZXN0V2l0aE9wdGlvbmFsRmVlc0FuZEV4dHJhRGF0YTxcbiAgICBQYXJ0aWFsV2l0aFJlcXVpcmVkRmllbGRzPFxuICAgICAgRGVsZXRlQXNzb2NpYXRpb25SZXF1ZXN0LFxuICAgICAgJ1RyYW5zYWN0b3JQdWJsaWNLZXlCYXNlNThDaGVjaycgfCAnQXNzb2NpYXRpb25JRCdcbiAgICA+XG4gID47XG5cbmV4cG9ydCBjb25zdCBkZWxldGVQb3N0QXNzb2NpYXRpb24gPSAoXG4gIHBhcmFtczogRGVsZXRlUG9zdEFzc29jaWF0aW9uUmVxdWVzdFBhcmFtcyxcbiAgb3B0aW9ucz86IFJlcXVlc3RPcHRpb25zXG4pOiBQcm9taXNlPENvbnN0cnVjdGVkQW5kU3VibWl0dGVkVHg8QXNzb2NpYXRpb25UeG5SZXNwb25zZT4+ID0+IHtcbiAgcmV0dXJuIGhhbmRsZVNpZ25BbmRTdWJtaXQoJ2FwaS92MC9wb3N0LWFzc29jaWF0aW9ucy9kZWxldGUnLCBwYXJhbXMsIHtcbiAgICAuLi5vcHRpb25zLFxuICAgIGNvbnN0cnVjdGlvbkZ1bmN0aW9uOiBjb25zdHJ1Y3REZWxldGVQb3N0QXNzb2NpYXRpb25UcmFuc2FjdGlvbixcbiAgfSk7XG59O1xuXG5leHBvcnQgY29uc3QgY29uc3RydWN0RGVsZXRlUG9zdEFzc29jaWF0aW9uVHJhbnNhY3Rpb24gPSAoXG4gIHBhcmFtczogRGVsZXRlUG9zdEFzc29jaWF0aW9uUmVxdWVzdFBhcmFtc1xuKTogUHJvbWlzZTxDb25zdHJ1Y3RlZFRyYW5zYWN0aW9uUmVzcG9uc2U+ID0+IHtcbiAgY29uc3QgbWV0YWRhdGEgPSBuZXcgVHJhbnNhY3Rpb25NZXRhZGF0YURlbGV0ZVBvc3RBc3NvY2lhdGlvbigpO1xuICBtZXRhZGF0YS5hc3NvY2lhdGlvbklEID0gZW5jb2RlVVRGOFRvQnl0ZXMocGFyYW1zLkFzc29jaWF0aW9uSUQpO1xuICByZXR1cm4gY29uc3RydWN0QmFsYW5jZU1vZGVsVHgoXG4gICAgcGFyYW1zLlRyYW5zYWN0b3JQdWJsaWNLZXlCYXNlNThDaGVjayxcbiAgICBtZXRhZGF0YSxcbiAgICB7XG4gICAgICBFeHRyYURhdGE6IHBhcmFtcy5FeHRyYURhdGEsXG4gICAgICBNaW5GZWVSYXRlTmFub3NQZXJLQjogcGFyYW1zLk1pbkZlZVJhdGVOYW5vc1BlcktCLFxuICAgICAgVHJhbnNhY3Rpb25GZWVzOiBwYXJhbXMuVHJhbnNhY3Rpb25GZWVzLFxuICAgIH1cbiAgKTtcbn07XG4iXX0=