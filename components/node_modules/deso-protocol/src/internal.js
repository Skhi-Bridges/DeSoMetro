import { bytesToHex } from '@noble/hashes/utils';
import { TransactionType, } from './backend-types/index.js';
import { api, cleanURL, getAppState, } from './data/index.js';
import { Transaction, TransactionExtraData, TransactionExtraDataKV, TransactionNonce, TransactionOutput, TransactionToMsgDeSoTxn, bs58PublicKeyToCompressedBytes, encodeUTF8ToBytes, identity, publicKeyToBase58Check, sha256X2, } from './identity/index.js';
////////////////////////////////////////////////////////////////////////////////
// This is all the stuff we don't export to consumers of the library. If
// anything here needs to be exported, it should be moved to another file.
////////////////////////////////////////////////////////////////////////////////
// This can be mutated by the user of the library via the configure function,
// but it's not exported explicitly. Whatever changes are made externally will
// be reflected in the library.
export const globalConfigOptions = {
    MinFeeRateNanosPerKB: 1500,
    LocalConstruction: false,
};
/**
 * Wraps signing and submit to include the configurable fee, and add defaults
 * for optional params.
 *
 * @param endpoint the endpoint for constructing the transaction
 * @param params tx specific params for the endpoint + optional fees and extra data
 * @param options options for the request, including whether to broadcast
 */
export const handleSignAndSubmit = async (endpoint, params, 
// we always broadcast by default, but consumers can optionally disable it.
options = { broadcast: true }) => {
    const constructedTransactionResponse = await ((options.localConstruction ||
        globalConfigOptions.LocalConstruction) &&
        options.constructionFunction
        ? options.constructionFunction(params)
        : api.post(options.nodeURI ? `${cleanURL(options.nodeURI, endpoint)}` : endpoint, {
            ...params,
            MinFeeRateNanosPerKB: params.MinFeeRateNanosPerKB ??
                globalConfigOptions.MinFeeRateNanosPerKB,
        }));
    if ((options.localConstruction || globalConfigOptions.LocalConstruction) &&
        options.constructionFunction) {
        console.log(constructedTransactionResponse);
    }
    const submittedTransactionResponse = options.broadcast !== false
        ? await identity.signAndSubmit(constructedTransactionResponse)
        : null;
    return {
        constructedTransactionResponse,
        submittedTransactionResponse,
    };
};
export const convertExtraData = (extraData, consensusExtraDataKVs) => {
    const sortedExtraData = (consensusExtraDataKVs || [])
        .concat(Object.entries(extraData || {}).map(([k, v]) => new TransactionExtraDataKV(encodeUTF8ToBytes(k), encodeUTF8ToBytes(v))))
        .sort((a, b) => a.key.toString().localeCompare(b.key.toString()));
    const realExtraData = new TransactionExtraData();
    realExtraData.kvs = sortedExtraData;
    return realExtraData;
};
const makeTransactionNonce = (desoNonce) => {
    const nonce = new TransactionNonce();
    nonce.expirationBlockHeight =
        desoNonce?.ExpirationBlockHeight || Number.MAX_SAFE_INTEGER;
    // TODO: cache partial IDs so we don't generate the same one twice.
    nonce.partialId = desoNonce?.PartialID || Math.floor(Math.random() * 1e18);
    return nonce;
};
export const getTxWithFeeNanos = (pubKey, metadata, txFields) => {
    const nonce = makeTransactionNonce(txFields?.Nonce);
    const transactionFeeOutputs = (txFields?.TransactionFees || []).map((tf) => {
        const newOutput = new TransactionOutput();
        newOutput.publicKey = bs58PublicKeyToCompressedBytes(tf.PublicKeyBase58Check);
        newOutput.amountNanos = tf.AmountNanos;
        return newOutput;
    });
    const transaction = new Transaction({
        version: 1,
        feeNanos: 0,
        nonce,
        metadata,
        outputs: transactionFeeOutputs.concat(txFields?.Outputs || []),
        inputs: [],
        extraData: convertExtraData(txFields?.ExtraData, txFields?.ConsensusExtraDataKVs),
        publicKey: bs58PublicKeyToCompressedBytes(pubKey),
        signature: new Uint8Array(0),
    });
    return computeFee(transaction, txFields?.MinFeeRateNanosPerKB ?? globalConfigOptions.MinFeeRateNanosPerKB);
};
export const constructBalanceModelTx = async (pubKey, metadata, txFields) => {
    // TODO: cache block height somewhere.
    if (!txFields?.Nonce) {
        const { BlockHeight } = await getAppState();
        if (!txFields) {
            txFields = {};
        }
        txFields.Nonce = {
            ExpirationBlockHeight: BlockHeight + 275,
        };
    }
    const txnWithFee = getTxWithFeeNanos(pubKey, metadata, txFields);
    const txnBytes = txnWithFee.toBytes();
    const TransactionHex = bytesToHex(txnBytes);
    // TODO: maintain backward compatibility with everything returned in the constructed transaction
    // response object for each type. this will be a headache no doubt.
    const fees = txnWithFee.feeNanos;
    const outputSum = txnWithFee.outputs.reduce((a, b) => a + b.amountNanos, 0);
    // TODO: sum extra spend for creator coins, dao coin limit orders (ugh), create NFTs, create profile
    // NFT buys. Probably not necessarily, but would be best to have this.
    const txnHash = sha256X2(txnBytes);
    const txnType = txnWithFee.getTxnTypeString();
    return {
        Transaction: TransactionToMsgDeSoTxn(txnWithFee),
        FeeNanos: fees,
        TransactionHex,
        ChangeAmountNanos: 0,
        TotalInputNanos: fees + outputSum,
        SpendAmountNanos: fees + outputSum,
        TransactionIDBase58Check: publicKeyToBase58Check(txnHash),
        TxnHashHex: bytesToHex(txnHash),
        PostHashHex: txnType === TransactionType.SubmitPost ? bytesToHex(txnHash) : undefined,
        TstampNanos: txnType === TransactionType.SubmitPost
            ? metadata.timestampNanos
            : undefined,
        NFTPostHashHex: txnType === TransactionType.CreateNFT ||
            txnType === TransactionType.UpdateNFT ||
            txnType === TransactionType.NFTBid ||
            txnType === TransactionType.AcceptNFTBid
            ? bytesToHex(metadata.nftPostHash)
            : undefined,
        SerialNumber: txnType === TransactionType.UpdateNFT ||
            txnType === TransactionType.NFTBid ||
            txnType === TransactionType.AcceptNFTBid
            ? metadata.serialNumber
            : undefined,
        UpdaterPublicKeyBase58Check: txnType === TransactionType.NFTBid ? pubKey : undefined,
        BidAmountNanos: txnType === TransactionType.NFTBid ||
            txnType === TransactionType.AcceptNFTBid
            ? metadata.bidAmountNanos
            : undefined,
        BidderPublicKeyBase58Check: txnType === TransactionType.AcceptNFTBid
            ? publicKeyToBase58Check(metadata.bidderPKID)
            : undefined,
    };
};
export const computeFee = (txn, feeRate) => {
    if (!feeRate)
        return txn;
    let prevFee = 0;
    let fee = 0;
    while (prevFee == 0 || prevFee != fee) {
        prevFee = fee;
        const size = computeTxSize(txn) + 71;
        fee = Math.ceil((size * feeRate) / 1000);
        txn.feeNanos = fee;
    }
    return txn;
};
export const computeTxSize = (txn) => {
    return txn.toBytes().length;
};
export const isMaybeDeSoPublicKey = (query) => {
    return ((query.length === 55 && query.startsWith('BC')) ||
        (query.length === 54 && query.startsWith('tBC')));
};
export const sumTransactionFees = (txFees) => {
    if (!txFees?.length)
        return 0;
    return txFees.reduce((acc, curr) => acc + curr.AmountNanos, 0);
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW50ZXJuYWwuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvaW50ZXJuYWwudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLHFCQUFxQixDQUFDO0FBQ2pELE9BQU8sRUFPTCxlQUFlLEdBQ2hCLE1BQU0sMEJBQTBCLENBQUM7QUFDbEMsT0FBTyxFQUVMLEdBQUcsRUFDSCxRQUFRLEVBQ1IsV0FBVyxHQUNaLE1BQU0saUJBQWlCLENBQUM7QUFDekIsT0FBTyxFQUNMLFdBQVcsRUFDWCxvQkFBb0IsRUFDcEIsc0JBQXNCLEVBT3RCLGdCQUFnQixFQUNoQixpQkFBaUIsRUFDakIsdUJBQXVCLEVBQ3ZCLDhCQUE4QixFQUM5QixpQkFBaUIsRUFDakIsUUFBUSxFQUNSLHNCQUFzQixFQUN0QixRQUFRLEdBQ1QsTUFBTSxxQkFBcUIsQ0FBQztBQUM3QixnRkFBZ0Y7QUFDaEYsd0VBQXdFO0FBQ3hFLDBFQUEwRTtBQUMxRSxnRkFBZ0Y7QUFFaEYsNkVBQTZFO0FBQzdFLDhFQUE4RTtBQUM5RSwrQkFBK0I7QUFDL0IsTUFBTSxDQUFDLE1BQU0sbUJBQW1CLEdBQUc7SUFDakMsb0JBQW9CLEVBQUUsSUFBSTtJQUMxQixpQkFBaUIsRUFBRSxLQUFLO0NBQ3pCLENBQUM7QUFFRjs7Ozs7OztHQU9HO0FBQ0gsTUFBTSxDQUFDLE1BQU0sbUJBQW1CLEdBQUcsS0FBSyxFQUN0QyxRQUFnQixFQUNoQixNQUFzQztBQUN0QywyRUFBMkU7QUFDM0UsVUFBMEIsRUFBRSxTQUFTLEVBQUUsSUFBSSxFQUFFLEVBSTVDLEVBQUU7SUFDSCxNQUFNLDhCQUE4QixHQUFHLE1BQU0sQ0FBQyxDQUFDLE9BQU8sQ0FBQyxpQkFBaUI7UUFDdEUsbUJBQW1CLENBQUMsaUJBQWlCLENBQUM7UUFDeEMsT0FBTyxDQUFDLG9CQUFvQjtRQUMxQixDQUFDLENBQUMsT0FBTyxDQUFDLG9CQUFvQixDQUFDLE1BQU0sQ0FBQztR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QWEsQ0FBQyxHQUFHLENBQUMsR0FBRyxFQUFFLENBQUM7UUFDckMsR0FBRyxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQyxJQUFJLEdBQUcsT0FBTyxDQUFDLEdBQUcsSUFBSSxDQUFDLENBQUM7UUFDekMsR0FBRyxDQUFDLFFBQVEsR0FBRyxHQUFHLENBQUM7S0FDcEI7SUFDRCxPQUFPLEdBQUcsQ0FBQztBQUNiLENBQUMsQ0FBQztBQUVGLE1BQU0sQ0FBQyxNQUFNLGFBQWEsR0FBRyxDQUFDLEdBQWdCLEVBQVUsRUFBRTtJQUN4RCxPQUFPLEdBQUcsQ0FBQyxPQUFPLEVBQUUsQ0FBQyxNQUFNLENBQUM7QUFDOUIsQ0FBQyxDQUFDO0FBRUYsTUFBTSxDQUFDLE1BQU0sb0JBQW9CLEdBQUcsQ0FBQyxLQUFhLEVBQVcsRUFBRTtJQUM3RCxPQUFPLENBQ0wsQ0FBQyxLQUFLLENBQUMsTUFBTSxLQUFLLEVBQUUsSUFBSSxLQUFLLENBQUMsVUFBVSxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQy9DLENBQUMsS0FBSyxDQUFDLE1BQU0sS0FBSyxFQUFFLElBQUksS0FBSyxDQUFDLFVBQVUsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUNqRCxDQUFDO0FBQ0osQ0FBQyxDQUFDO0FBRUYsTUFBTSxDQUFDLE1BQU0sa0JBQWtCLEdBQUcsQ0FDaEMsTUFBZ0MsRUFDeEIsRUFBRTtJQUNWLElBQUksQ0FBQyxNQUFNLEVBQUUsTUFBTTtRQUFFLE9BQU8sQ0FBQyxDQUFDO0lBQzlCLE9BQU8sTUFBTSxDQUFDLE1BQU0sQ0FBQyxDQUFDLEdBQUcsRUFBRSxJQUFJLEVBQUUsRUFBRSxDQUFDLEdBQUcsR0FBRyxJQUFJLENBQUMsV0FBVyxFQUFFLENBQVcsQ0FBQyxDQUFDO0FBQzNFLENBQUMsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGJ5dGVzVG9IZXggfSBmcm9tICdAbm9ibGUvaGFzaGVzL3V0aWxzJztcbmltcG9ydCB7XG4gIENvbnN0cnVjdGVkVHJhbnNhY3Rpb25SZXNwb25zZSxcbiAgRGVTb05vbmNlLFxuICBPcHRpb25hbEZlZXNBbmRFeHRyYURhdGEsXG4gIFJlcXVlc3RPcHRpb25zLFxuICBTdWJtaXRUcmFuc2FjdGlvblJlc3BvbnNlLFxuICBUcmFuc2FjdGlvbkZlZSxcbiAgVHJhbnNhY3Rpb25UeXBlLFxufSBmcm9tICcuL2JhY2tlbmQtdHlwZXMvaW5kZXguanMnO1xuaW1wb3J0IHtcbiAgUGFydGlhbFdpdGhSZXF1aXJlZEZpZWxkcyxcbiAgYXBpLFxuICBjbGVhblVSTCxcbiAgZ2V0QXBwU3RhdGUsXG59IGZyb20gJy4vZGF0YS9pbmRleC5qcyc7XG5pbXBvcnQge1xuICBUcmFuc2FjdGlvbixcbiAgVHJhbnNhY3Rpb25FeHRyYURhdGEsXG4gIFRyYW5zYWN0aW9uRXh0cmFEYXRhS1YsXG4gIFRyYW5zYWN0aW9uTWV0YWRhdGFBY2NlcHRORlRCaWQsXG4gIFRyYW5zYWN0aW9uTWV0YWRhdGFDcmVhdGVORlQsXG4gIFRyYW5zYWN0aW9uTWV0YWRhdGFORlRCaWQsXG4gIFRyYW5zYWN0aW9uTWV0YWRhdGFSZWNvcmQsXG4gIFRyYW5zYWN0aW9uTWV0YWRhdGFTdWJtaXRQb3N0LFxuICBUcmFuc2FjdGlvbk1ldGFkYXRhVXBkYXRlTkZULFxuICBUcmFuc2FjdGlvbk5vbmNlLFxuICBUcmFuc2FjdGlvbk91dHB1dCxcbiAgVHJhbnNhY3Rpb25Ub01zZ0RlU29UeG4sXG4gIGJzNThQdWJsaWNLZXlUb0NvbXByZXNzZWRCeXRlcyxcbiAgZW5jb2RlVVRGOFRvQnl0ZXMsXG4gIGlkZW50aXR5LFxuICBwdWJsaWNLZXlUb0Jhc2U1OENoZWNrLFxuICBzaGEyNTZYMixcbn0gZnJvbSAnLi9pZGVudGl0eS9pbmRleC5qcyc7XG4vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vL1xuLy8gVGhpcyBpcyBhbGwgdGhlIHN0dWZmIHdlIGRvbid0IGV4cG9ydCB0byBjb25zdW1lcnMgb2YgdGhlIGxpYnJhcnkuIElmXG4vLyBhbnl0aGluZyBoZXJlIG5lZWRzIHRvIGJlIGV4cG9ydGVkLCBpdCBzaG91bGQgYmUgbW92ZWQgdG8gYW5vdGhlciBmaWxlLlxuLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy9cblxuLy8gVGhpcyBjYW4gYmUgbXV0YXRlZCBieSB0aGUgdXNlciBvZiB0aGUgbGlicmFyeSB2aWEgdGhlIGNvbmZpZ3VyZSBmdW5jdGlvbixcbi8vIGJ1dCBpdCdzIG5vdCBleHBvcnRlZCBleHBsaWNpdGx5LiBXaGF0ZXZlciBjaGFuZ2VzIGFyZSBtYWRlIGV4dGVybmFsbHkgd2lsbFxuLy8gYmUgcmVmbGVjdGVkIGluIHRoZSBsaWJyYXJ5LlxuZXhwb3J0IGNvbnN0IGdsb2JhbENvbmZpZ09wdGlvbnMgPSB7XG4gIE1pbkZlZVJhdGVOYW5vc1BlcktCOiAxNTAwLFxuICBMb2NhbENvbnN0cnVjdGlvbjogZmFsc2UsXG59O1xuXG4vKipcbiAqIFdyYXBzIHNpZ25pbmcgYW5kIHN1Ym1pdCB0byBpbmNsdWRlIHRoZSBjb25maWd1cmFibGUgZmVlLCBhbmQgYWRkIGRlZmF1bHRzXG4gKiBmb3Igb3B0aW9uYWwgcGFyYW1zLlxuICpcbiAqIEBwYXJhbSBlbmRwb2ludCB0aGUgZW5kcG9pbnQgZm9yIGNvbnN0cnVjdGluZyB0aGUgdHJhbnNhY3Rpb25cbiAqIEBwYXJhbSBwYXJhbXMgdHggc3BlY2lmaWMgcGFyYW1zIGZvciB0aGUgZW5kcG9pbnQgKyBvcHRpb25hbCBmZWVzIGFuZCBleHRyYSBkYXRhXG4gKiBAcGFyYW0gb3B0aW9ucyBvcHRpb25zIGZvciB0aGUgcmVxdWVzdCwgaW5jbHVkaW5nIHdoZXRoZXIgdG8gYnJvYWRjYXN0XG4gKi9cbmV4cG9ydCBjb25zdCBoYW5kbGVTaWduQW5kU3VibWl0ID0gYXN5bmMgKFxuICBlbmRwb2ludDogc3RyaW5nLFxuICBwYXJhbXM6IE9wdGlvbmFsRmVlc0FuZEV4dHJhRGF0YSAmIGFueSxcbiAgLy8gd2UgYWx3YXlzIGJyb2FkY2FzdCBieSBkZWZhdWx0LCBidXQgY29uc3VtZXJzIGNhbiBvcHRpb25hbGx5IGRpc2FibGUgaXQuXG4gIG9wdGlvbnM6IFJlcXVlc3RPcHRpb25zID0geyBicm9hZGNhc3Q6IHRydWUgfVxuKTogUHJvbWlzZTx7XG4gIGNvbnN0cnVjdGVkVHJhbnNhY3Rpb25SZXNwb25zZTogQ29uc3RydWN0ZWRUcmFuc2FjdGlvblJlc3BvbnNlO1xuICBzdWJtaXR0ZWRUcmFuc2FjdGlvblJlc3BvbnNlOiBTdWJtaXRUcmFuc2FjdGlvblJlc3BvbnNlIHwgbnVsbDtcbn0+ID0+IHtcbiAgY29uc3QgY29uc3RydWN0ZWRUcmFuc2FjdGlvblJlc3BvbnNlID0gYXdhaXQgKChvcHRpb25zLmxvY2FsQ29uc3RydWN0aW9uIHx8XG4gICAgZ2xvYmFsQ29uZmlnT3B0aW9ucy5Mb2NhbENvbnN0cnVjdGlvbikgJiZcbiAgb3B0aW9ucy5jb25zdHJ1Y3Rpb25GdW5jdGlvblxuICAgID8gb3B0aW9ucy5jb25zdHJ1Y3Rpb25GdW5jdGlvbihwYXJhbXMpXG4gICAgOiBhcGkucG9zdChcbiAgICAgICAgb3B0aW9ucy5ub2RlVVJJID8gYCR7Y2xlYW5VUkwob3B0aW9ucy5ub2RlVVJJLCBlbmRwb2ludCl9YCA6IGVuZHBvaW50LFxuICAgICAgICB7XG4gICAgICAgICAgLi4ucGFyYW1zLFxuICAgICAgICAgIE1pbkZlZVJhdGVOYW5vc1BlcktCOlxuICAgICAgICAgICAgcGFyYW1zLk1pbkZlZVJhdGVOYW5vc1BlcktCID8/XG4gICAgICAgICAgICBnbG9iYWxDb25maWdPcHRpb25zLk1pbkZlZVJhdGVOYW5vc1BlcktCLFxuICAgICAgICB9XG4gICAgICApKTtcbiAgaWYgKFxuICAgIChvcHRpb25zLmxvY2FsQ29uc3RydWN0aW9uIHx8IGdsb2JhbENvbmZpZ09wdGlvbnMuTG9jYWxDb25zdHJ1Y3Rpb24pICYmXG4gICAgb3B0aW9ucy5jb25zdHJ1Y3Rpb25GdW5jdGlvblxuICApIHtcbiAgICBjb25zb2xlLmxvZyhjb25zdHJ1Y3RlZFRyYW5zYWN0aW9uUmVzcG9uc2UpO1xuICB9XG4gIGNvbnN0IHN1Ym1pdHRlZFRyYW5zYWN0aW9uUmVzcG9uc2UgPVxuICAgIG9wdGlvbnMuYnJvYWRjYXN0ICE9PSBmYWxzZVxuICAgICAgPyBhd2FpdCBpZGVudGl0eS5zaWduQW5kU3VibWl0KGNvbnN0cnVjdGVkVHJhbnNhY3Rpb25SZXNwb25zZSlcbiAgICAgIDogbnVsbDtcblxuICByZXR1cm4ge1xuICAgIGNvbnN0cnVjdGVkVHJhbnNhY3Rpb25SZXNwb25zZSxcbiAgICBzdWJtaXR0ZWRUcmFuc2FjdGlvblJlc3BvbnNlLFxuICB9O1xufTtcblxuZXhwb3J0IHR5cGUgQmFsYW5jZU1vZGVsVHJhbnNhY3Rpb25GaWVsZHMgPSB7XG4gIE91dHB1dHM/OiBUcmFuc2FjdGlvbk91dHB1dFtdO1xuICBFeHRyYURhdGE/OiB7IFtrOiBzdHJpbmddOiBzdHJpbmcgfTtcbiAgQ29uc2Vuc3VzRXh0cmFEYXRhS1ZzPzogVHJhbnNhY3Rpb25FeHRyYURhdGFLVltdO1xuICBNaW5GZWVSYXRlTmFub3NQZXJLQj86IG51bWJlcjtcbiAgVHJhbnNhY3Rpb25GZWVzPzogVHJhbnNhY3Rpb25GZWVbXSB8IG51bGw7XG4gIE5vbmNlPzogUGFydGlhbFdpdGhSZXF1aXJlZEZpZWxkczxEZVNvTm9uY2UsICdFeHBpcmF0aW9uQmxvY2tIZWlnaHQnPjtcbn07XG5cbmV4cG9ydCBjb25zdCBjb252ZXJ0RXh0cmFEYXRhID0gKFxuICBleHRyYURhdGE/OiB7IFtrOiBzdHJpbmddOiBzdHJpbmcgfSxcbiAgY29uc2Vuc3VzRXh0cmFEYXRhS1ZzPzogVHJhbnNhY3Rpb25FeHRyYURhdGFLVltdXG4pOiBUcmFuc2FjdGlvbkV4dHJhRGF0YSA9PiB7XG4gIGNvbnN0IHNvcnRlZEV4dHJhRGF0YSA9IChjb25zZW5zdXNFeHRyYURhdGFLVnMgfHwgW10pXG4gICAgLmNvbmNhdChcbiAgICAgIE9iamVjdC5lbnRyaWVzKGV4dHJhRGF0YSB8fCB7fSkubWFwKFxuICAgICAgICAoW2ssIHZdKSA9PlxuICAgICAgICAgIG5ldyBUcmFuc2FjdGlvbkV4dHJhRGF0YUtWKGVuY29kZVVURjhUb0J5dGVzKGspLCBlbmNvZGVVVEY4VG9CeXRlcyh2KSlcbiAgICAgIClcbiAgICApXG4gICAgLnNvcnQoKGEsIGIpID0+IGEua2V5LnRvU3RyaW5nKCkubG9jYWxlQ29tcGFyZShiLmtleS50b1N0cmluZygpKSk7XG4gIGNvbnN0IHJlYWxFeHRyYURhdGEgPSBuZXcgVHJhbnNhY3Rpb25FeHRyYURhdGEoKTtcbiAgcmVhbEV4dHJhRGF0YS5rdnMgPSBzb3J0ZWRFeHRyYURhdGE7XG4gIHJldHVybiByZWFsRXh0cmFEYXRhO1xufTtcblxuY29uc3QgbWFrZVRyYW5zYWN0aW9uTm9uY2UgPSAoXG4gIGRlc29Ob25jZTpcbiAgICB8IFBhcnRpYWxXaXRoUmVxdWlyZWRGaWVsZHM8RGVTb05vbmNlLCAnRXhwaXJhdGlvbkJsb2NrSGVpZ2h0Jz5cbiAgICB8IHVuZGVmaW5lZFxuKTogVHJhbnNhY3Rpb25Ob25jZSA9PiB7XG4gIGNvbnN0IG5vbmNlID0gbmV3IFRyYW5zYWN0aW9uTm9uY2UoKTtcbiAgbm9uY2UuZXhwaXJhdGlvbkJsb2NrSGVpZ2h0ID1cbiAgICBkZXNvTm9uY2U/LkV4cGlyYXRpb25CbG9ja0hlaWdodCB8fCBOdW1iZXIuTUFYX1NBRkVfSU5URUdFUjtcbiAgLy8gVE9ETzogY2FjaGUgcGFydGlhbCBJRHMgc28gd2UgZG9uJ3QgZ2VuZXJhdGUgdGhlIHNhbWUgb25lIHR3aWNlLlxuICBub25jZS5wYXJ0aWFsSWQgPSBkZXNvTm9uY2U/LlBhcnRpYWxJRCB8fCBNYXRoLmZsb29yKE1hdGgucmFuZG9tKCkgKiAxZTE4KTtcbiAgcmV0dXJuIG5vbmNlO1xufTtcblxuZXhwb3J0IGNvbnN0IGdldFR4V2l0aEZlZU5hbm9zID0gKFxuICBwdWJLZXk6IHN0cmluZyxcbiAgbWV0YWRhdGE6IFRyYW5zYWN0aW9uTWV0YWRhdGFSZWNvcmQsXG4gIHR4RmllbGRzPzogQmFsYW5jZU1vZGVsVHJhbnNhY3Rpb25GaWVsZHNcbikgPT4ge1xuICBjb25zdCBub25jZSA9IG1ha2VUcmFuc2FjdGlvbk5vbmNlKHR4RmllbGRzPy5Ob25jZSk7XG5cbiAgY29uc3QgdHJhbnNhY3Rpb25GZWVPdXRwdXRzID0gKHR4RmllbGRzPy5UcmFuc2FjdGlvbkZlZXMgfHwgW10pLm1hcCgodGYpID0+IHtcbiAgICBjb25zdCBuZXdPdXRwdXQgPSBuZXcgVHJhbnNhY3Rpb25PdXRwdXQoKTtcbiAgICBuZXdPdXRwdXQucHVibGljS2V5ID0gYnM1OFB1YmxpY0tleVRvQ29tcHJlc3NlZEJ5dGVzKFxuICAgICAgdGYuUHVibGljS2V5QmFzZTU4Q2hlY2tcbiAgICApO1xuICAgIG5ld091dHB1dC5hbW91bnROYW5vcyA9IHRmLkFtb3VudE5hbm9zO1xuICAgIHJldHVybiBuZXdPdXRwdXQ7XG4gIH0pO1xuICBjb25zdCB0cmFuc2FjdGlvbiA9IG5ldyBUcmFuc2FjdGlvbih7XG4gICAgdmVyc2lvbjogMSxcbiAgICBmZWVOYW5vczogMCxcbiAgICBub25jZSxcbiAgICBtZXRhZGF0YSxcbiAgICBvdXRwdXRzOiB0cmFuc2FjdGlvbkZlZU91dHB1dHMuY29uY2F0KHR4RmllbGRzPy5PdXRwdXRzIHx8IFtdKSxcbiAgICBpbnB1dHM6IFtdLFxuICAgIGV4dHJhRGF0YTogY29udmVydEV4dHJhRGF0YShcbiAgICAgIHR4RmllbGRzPy5FeHRyYURhdGEsXG4gICAgICB0eEZpZWxkcz8uQ29uc2Vuc3VzRXh0cmFEYXRhS1ZzXG4gICAgKSxcbiAgICBwdWJsaWNLZXk6IGJzNThQdWJsaWNLZXlUb0NvbXByZXNzZWRCeXRlcyhwdWJLZXkpLFxuICAgIHNpZ25hdHVyZTogbmV3IFVpbnQ4QXJyYXkoMCksXG4gIH0pO1xuXG4gIHJldHVybiBjb21wdXRlRmVlKFxuICAgIHRyYW5zYWN0aW9uLFxuICAgIHR4RmllbGRzPy5NaW5GZWVSYXRlTmFub3NQZXJLQiA/PyBnbG9iYWxDb25maWdPcHRpb25zLk1pbkZlZVJhdGVOYW5vc1BlcktCXG4gICk7XG59O1xuXG5leHBvcnQgY29uc3QgY29uc3RydWN0QmFsYW5jZU1vZGVsVHggPSBhc3luYyAoXG4gIHB1YktleTogc3RyaW5nLFxuICBtZXRhZGF0YTogVHJhbnNhY3Rpb25NZXRhZGF0YVJlY29yZCxcbiAgdHhGaWVsZHM/OiBCYWxhbmNlTW9kZWxUcmFuc2FjdGlvbkZpZWxkc1xuKTogUHJvbWlzZTxDb25zdHJ1Y3RlZFRyYW5zYWN0aW9uUmVzcG9uc2U+ID0+IHtcbiAgLy8gVE9ETzogY2FjaGUgYmxvY2sgaGVpZ2h0IHNvbWV3aGVyZS5cbiAgaWYgKCF0eEZpZWxkcz8uTm9uY2UpIHtcbiAgICBjb25zdCB7IEJsb2NrSGVpZ2h0IH0gPSBhd2FpdCBnZXRBcHBTdGF0ZSgpO1xuICAgIGlmICghdHhGaWVsZHMpIHtcbiAgICAgIHR4RmllbGRzID0ge307XG4gICAgfVxuICAgIHR4RmllbGRzLk5vbmNlID0ge1xuICAgICAgRXhwaXJhdGlvbkJsb2NrSGVpZ2h0OiBCbG9ja0hlaWdodCArIDI3NSxcbiAgICB9O1xuICB9XG5cbiAgY29uc3QgdHhuV2l0aEZlZSA9IGdldFR4V2l0aEZlZU5hbm9zKHB1YktleSwgbWV0YWRhdGEsIHR4RmllbGRzKTtcblxuICBjb25zdCB0eG5CeXRlcyA9IHR4bldpdGhGZWUudG9CeXRlcygpO1xuICBjb25zdCBUcmFuc2FjdGlvbkhleCA9IGJ5dGVzVG9IZXgodHhuQnl0ZXMpO1xuXG4gIC8vIFRPRE86IG1haW50YWluIGJhY2t3YXJkIGNvbXBhdGliaWxpdHkgd2l0aCBldmVyeXRoaW5nIHJldHVybmVkIGluIHRoZSBjb25zdHJ1Y3RlZCB0cmFuc2FjdGlvblxuICAvLyByZXNwb25zZSBvYmplY3QgZm9yIGVhY2ggdHlwZS4gdGhpcyB3aWxsIGJlIGEgaGVhZGFjaGUgbm8gZG91YnQuXG4gIGNvbnN0IGZlZXMgPSB0eG5XaXRoRmVlLmZlZU5hbm9zO1xuICBjb25zdCBvdXRwdXRTdW0gPSB0eG5XaXRoRmVlLm91dHB1dHMucmVkdWNlKChhLCBiKSA9PiBhICsgYi5hbW91bnROYW5vcywgMCk7XG4gIC8vIFRPRE86IHN1bSBleHRyYSBzcGVuZCBmb3IgY3JlYXRvciBjb2lucywgZGFvIGNvaW4gbGltaXQgb3JkZXJzICh1Z2gpLCBjcmVhdGUgTkZUcywgY3JlYXRlIHByb2ZpbGVcbiAgLy8gTkZUIGJ1eXMuIFByb2JhYmx5IG5vdCBuZWNlc3NhcmlseSwgYnV0IHdvdWxkIGJlIGJlc3QgdG8gaGF2ZSB0aGlzLlxuICBjb25zdCB0eG5IYXNoID0gc2hhMjU2WDIodHhuQnl0ZXMpO1xuICBjb25zdCB0eG5UeXBlID0gdHhuV2l0aEZlZS5nZXRUeG5UeXBlU3RyaW5nKCk7XG4gIHJldHVybiB7XG4gICAgVHJhbnNhY3Rpb246IFRyYW5zYWN0aW9uVG9Nc2dEZVNvVHhuKHR4bldpdGhGZWUpLFxuICAgIEZlZU5hbm9zOiBmZWVzLFxuICAgIFRyYW5zYWN0aW9uSGV4LFxuICAgIENoYW5nZUFtb3VudE5hbm9zOiAwLFxuICAgIFRvdGFsSW5wdXROYW5vczogZmVlcyArIG91dHB1dFN1bSxcbiAgICBTcGVuZEFtb3VudE5hbm9zOiBmZWVzICsgb3V0cHV0U3VtLFxuICAgIFRyYW5zYWN0aW9uSURCYXNlNThDaGVjazogcHVibGljS2V5VG9CYXNlNThDaGVjayh0eG5IYXNoKSxcbiAgICBUeG5IYXNoSGV4OiBieXRlc1RvSGV4KHR4bkhhc2gpLFxuICAgIFBvc3RIYXNoSGV4OlxuICAgICAgdHhuVHlwZSA9PT0gVHJhbnNhY3Rpb25UeXBlLlN1Ym1pdFBvc3QgPyBieXRlc1RvSGV4KHR4bkhhc2gpIDogdW5kZWZpbmVkLFxuICAgIFRzdGFtcE5hbm9zOlxuICAgICAgdHhuVHlwZSA9PT0gVHJhbnNhY3Rpb25UeXBlLlN1Ym1pdFBvc3RcbiAgICAgICAgPyAobWV0YWRhdGEgYXMgVHJhbnNhY3Rpb25NZXRhZGF0YVN1Ym1pdFBvc3QpLnRpbWVzdGFtcE5hbm9zXG4gICAgICAgIDogdW5kZWZpbmVkLFxuICAgIE5GVFBvc3RIYXNoSGV4OlxuICAgICAgdHhuVHlwZSA9PT0gVHJhbnNhY3Rpb25UeXBlLkNyZWF0ZU5GVCB8fFxuICAgICAgdHhuVHlwZSA9PT0gVHJhbnNhY3Rpb25UeXBlLlVwZGF0ZU5GVCB8fFxuICAgICAgdHhuVHlwZSA9PT0gVHJhbnNhY3Rpb25UeXBlLk5GVEJpZCB8fFxuICAgICAgdHhuVHlwZSA9PT0gVHJhbnNhY3Rpb25UeXBlLkFjY2VwdE5GVEJpZFxuICAgICAgICA/IGJ5dGVzVG9IZXgoXG4gICAgICAgICAgICAoXG4gICAgICAgICAgICAgIG1ldGFkYXRhIGFzXG4gICAgICAgICAgICAgICAgfCBUcmFuc2FjdGlvbk1ldGFkYXRhQ3JlYXRlTkZUXG4gICAgICAgICAgICAgICAgfCBUcmFuc2FjdGlvbk1ldGFkYXRhVXBkYXRlTkZUXG4gICAgICAgICAgICAgICAgfCBUcmFuc2FjdGlvbk1ldGFkYXRhTkZUQmlkXG4gICAgICAgICAgICAgICAgfCBUcmFuc2FjdGlvbk1ldGFkYXRhQWNjZXB0TkZUQmlkXG4gICAgICAgICAgICApLm5mdFBvc3RIYXNoXG4gICAgICAgICAgKVxuICAgICAgICA6IHVuZGVmaW5lZCxcbiAgICBTZXJpYWxOdW1iZXI6XG4gICAgICB0eG5UeXBlID09PSBUcmFuc2FjdGlvblR5cGUuVXBkYXRlTkZUIHx8XG4gICAgICB0eG5UeXBlID09PSBUcmFuc2FjdGlvblR5cGUuTkZUQmlkIHx8XG4gICAgICB0eG5UeXBlID09PSBUcmFuc2FjdGlvblR5cGUuQWNjZXB0TkZUQmlkXG4gICAgICAgID8gKFxuICAgICAgICAgICAgbWV0YWRhdGEgYXNcbiAgICAgICAgICAgICAgfCBUcmFuc2FjdGlvbk1ldGFkYXRhVXBkYXRlTkZUXG4gICAgICAgICAgICAgIHwgVHJhbnNhY3Rpb25NZXRhZGF0YU5GVEJpZFxuICAgICAgICAgICAgICB8IFRyYW5zYWN0aW9uTWV0YWRhdGFBY2NlcHRORlRCaWRcbiAgICAgICAgICApLnNlcmlhbE51bWJlclxuICAgICAgICA6IHVuZGVmaW5lZCxcbiAgICBVcGRhdGVyUHVibGljS2V5QmFzZTU4Q2hlY2s6XG4gICAgICB0eG5UeXBlID09PSBUcmFuc2FjdGlvblR5cGUuTkZUQmlkID8gcHViS2V5IDogdW5kZWZpbmVkLFxuICAgIEJpZEFtb3VudE5hbm9zOlxuICAgICAgdHhuVHlwZSA9PT0gVHJhbnNhY3Rpb25UeXBlLk5GVEJpZCB8fFxuICAgICAgdHhuVHlwZSA9PT0gVHJhbnNhY3Rpb25UeXBlLkFjY2VwdE5GVEJpZFxuICAgICAgICA/IChcbiAgICAgICAgICAgIG1ldGFkYXRhIGFzXG4gICAgICAgICAgICAgIHwgVHJhbnNhY3Rpb25NZXRhZGF0YUFjY2VwdE5GVEJpZFxuICAgICAgICAgICAgICB8IFRyYW5zYWN0aW9uTWV0YWRhdGFORlRCaWRcbiAgICAgICAgICApLmJpZEFtb3VudE5hbm9zXG4gICAgICAgIDogdW5kZWZpbmVkLFxuICAgIEJpZGRlclB1YmxpY0tleUJhc2U1OENoZWNrOlxuICAgICAgdHhuVHlwZSA9PT0gVHJhbnNhY3Rpb25UeXBlLkFjY2VwdE5GVEJpZFxuICAgICAgICA/IHB1YmxpY0tleVRvQmFzZTU4Q2hlY2soXG4gICAgICAgICAgICAobWV0YWRhdGEgYXMgVHJhbnNhY3Rpb25NZXRhZGF0YUFjY2VwdE5GVEJpZCkuYmlkZGVyUEtJRFxuICAgICAgICAgIClcbiAgICAgICAgOiB1bmRlZmluZWQsXG4gIH07XG59O1xuXG5leHBvcnQgY29uc3QgY29tcHV0ZUZlZSA9ICh0eG46IFRyYW5zYWN0aW9uLCBmZWVSYXRlOiBudW1iZXIpOiBUcmFuc2FjdGlvbiA9PiB7XG4gIGlmICghZmVlUmF0ZSkgcmV0dXJuIHR4bjtcbiAgbGV0IHByZXZGZWUgPSAwO1xuICBsZXQgZmVlID0gMDtcbiAgd2hpbGUgKHByZXZGZWUgPT0gMCB8fCBwcmV2RmVlICE9IGZlZSkge1xuICAgIHByZXZGZWUgPSBmZWU7XG4gICAgY29uc3Qgc2l6ZSA9IGNvbXB1dGVUeFNpemUodHhuKSArIDcxO1xuICAgIGZlZSA9IE1hdGguY2VpbCgoc2l6ZSAqIGZlZVJhdGUpIC8gMTAwMCk7XG4gICAgdHhuLmZlZU5hbm9zID0gZmVlO1xuICB9XG4gIHJldHVybiB0eG47XG59O1xuXG5leHBvcnQgY29uc3QgY29tcHV0ZVR4U2l6ZSA9ICh0eG46IFRyYW5zYWN0aW9uKTogbnVtYmVyID0+IHtcbiAgcmV0dXJuIHR4bi50b0J5dGVzKCkubGVuZ3RoO1xufTtcblxuZXhwb3J0IGNvbnN0IGlzTWF5YmVEZVNvUHVibGljS2V5ID0gKHF1ZXJ5OiBzdHJpbmcpOiBib29sZWFuID0+IHtcbiAgcmV0dXJuIChcbiAgICAocXVlcnkubGVuZ3RoID09PSA1NSAmJiBxdWVyeS5zdGFydHNXaXRoKCdCQycpKSB8fFxuICAgIChxdWVyeS5sZW5ndGggPT09IDU0ICYmIHF1ZXJ5LnN0YXJ0c1dpdGgoJ3RCQycpKVxuICApO1xufTtcblxuZXhwb3J0IGNvbnN0IHN1bVRyYW5zYWN0aW9uRmVlcyA9IChcbiAgdHhGZWVzPzogVHJhbnNhY3Rpb25GZWVbXSB8IG51bGxcbik6IG51bWJlciA9PiB7XG4gIGlmICghdHhGZWVzPy5sZW5ndGgpIHJldHVybiAwO1xuICByZXR1cm4gdHhGZWVzLnJlZHVjZSgoYWNjLCBjdXJyKSA9PiBhY2MgKyBjdXJyLkFtb3VudE5hbm9zLCAwIGFzIG51bWJlcik7XG59O1xuIl19