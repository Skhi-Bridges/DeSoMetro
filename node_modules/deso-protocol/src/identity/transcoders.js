import 'reflect-metadata';
import { bufToUvarint64, concatUint8Arrays, uvarint64ToBuf, } from './crypto-utils.js';
import { TransactionNonce } from './transaction-transcoders.js';
export class BinaryRecord {
    static fromBytes(bytes) {
        const result = new this();
        let buffer = bytes;
        const transcoders = Reflect.getMetadata('transcoders', result) || [];
        transcoders.forEach(({ name, transcoder }) => {
            let value;
            [value, buffer] = transcoder.read.call(result, buffer);
            result[name] = value;
        });
        return [result, buffer];
    }
    toBytes() {
        const transcoders = Reflect.getMetadata('transcoders', this) || [];
        let buffer = new Uint8Array(0);
        transcoders.forEach(({ name, transcoder }) => {
            buffer = concatUint8Arrays([
                buffer,
                transcoder.write.call(this, this[name]),
            ]);
        });
        return buffer;
    }
}
export function Transcode(transcoder) {
    return (target, name) => {
        const transcoders = Reflect.getMetadata('transcoders', target) || [];
        transcoders.push({ name, transcoder });
        Reflect.defineMetadata('transcoders', transcoders, target);
    };
}
export const Uvarint64 = {
    read: (bytes) => bufToUvarint64(bytes),
    write: (uint) => uvarint64ToBuf(uint),
};
export const Boolean = {
    read: (bytes) => [bytes.at(0) != 0, bytes.slice(1)],
    write: (bool) => {
        return Uint8Array.from([bool ? 1 : 0]);
    },
};
export const Uint8 = {
    read: (bytes) => [bytes.at(0), bytes.slice(1)],
    write: (uint) => {
        return Uint8Array.from([uint]);
    },
};
export const FixedBuffer = (size) => ({
    read: (bytes) => [bytes.slice(0, size), bytes.slice(size)],
    write: (bytes) => bytes,
});
export const VarBuffer = {
    read: (bytes) => {
        const [size, buffer] = bufToUvarint64(bytes);
        return [buffer.slice(0, size), buffer.slice(size)];
    },
    write: (bytes) => concatUint8Arrays([uvarint64ToBuf(bytes.length), bytes]),
};
export const TransactionNonceTranscoder = {
    read: (bytes) => {
        return TransactionNonce.fromBytes(bytes);
    },
    write: (nonce) => {
        if (nonce) {
            return concatUint8Arrays([nonce.toBytes()]);
        }
        return new Uint8Array(0);
    },
};
export function Optional(transcoder) {
    return {
        read: (bytes) => !bytes.length ? [null, bytes] : transcoder.read(bytes),
        write: (value) => value === null ? new Uint8Array(0) : transcoder.write(value),
    };
}
export const ChunkBuffer = (width) => ({
    read: (bytes) => {
        const countAndBuffer = bufToUvarint64(bytes);
        const count = countAndBuffer[0];
        let buffer = countAndBuffer[1];
        const result = [];
        for (let i = 0; i < count; i++) {
            result.push(buffer.slice(0, 33));
            buffer = buffer.slice(33);
        }
        return [result, buffer];
    },
    write: (chunks) => concatUint8Arrays([uvarint64ToBuf(chunks.length), ...chunks]),
});
export const ArrayOf = (klass) => ({
    read: (bytes) => {
        const countAndBuffer = bufToUvarint64(bytes);
        const count = countAndBuffer[0];
        let buffer = countAndBuffer[1];
        const result = [];
        for (let i = 0; i < count; i++) {
            let obj;
            [obj, buffer] = klass.fromBytes(buffer);
            result.push(obj);
        }
        return [result, buffer];
    },
    write: (objects) => {
        const count = uvarint64ToBuf(objects.length);
        return concatUint8Arrays([
            count,
            ...objects.map((object) => object.toBytes()),
        ]);
    },
});
export const Record = (klass) => ({
    read: (bytes) => klass.fromBytes(bytes),
    write: (object) => object.toBytes(),
});
export const instanceToType = (object, klassMap) => {
    for (const [key, value] of Object.entries(klassMap)) {
        if (object instanceof value)
            return parseInt(key);
    }
    return -1;
};
export const Enum = (klassMap) => {
    return {
        read: (bytes) => {
            let buffer = bytes;
            const typeAndBuffer = bufToUvarint64(buffer);
            const type = typeAndBuffer[0];
            buffer = typeAndBuffer[1];
            const sizeAndBuffer = bufToUvarint64(buffer);
            const size = sizeAndBuffer[0];
            buffer = sizeAndBuffer[1];
            return [
                klassMap[type].fromBytes(buffer.slice(0, size))[0],
                buffer.slice(size),
            ];
        },
        write: (object) => {
            const type = uvarint64ToBuf(instanceToType(object, klassMap));
            const bytes = object.toBytes();
            const size = uvarint64ToBuf(bytes.length);
            return concatUint8Arrays([type, size, bytes]);
        },
    };
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidHJhbnNjb2RlcnMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvaWRlbnRpdHkvdHJhbnNjb2RlcnMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxrQkFBa0IsQ0FBQztBQUMxQixPQUFPLEVBQ0wsY0FBYyxFQUNkLGlCQUFpQixFQUNqQixjQUFjLEdBQ2YsTUFBTSxtQkFBbUIsQ0FBQztBQUMzQixPQUFPLEVBQUUsZ0JBQWdCLEVBQUUsTUFBTSw4QkFBOEIsQ0FBQztBQUNoRSxNQUFNLE9BQU8sWUFBWTtJQUN2QixNQUFNLENBQUMsU0FBUyxDQUFDLEtBQWlCO1FBQ2hDLE1BQU0sTUFBTSxHQUFHLElBQUksSUFBSSxFQUFFLENBQUM7UUFDMUIsSUFBSSxNQUFNLEdBQUcsS0FBSyxDQUFDO1FBRW5CLE1BQU0sV0FBVyxHQUNmLE9BQU8sQ0FBQyxXQUFXLENBQUMsYUFBYSxFQUFFLE1BQU0sQ0FBQyxJQUFJLEVBQUUsQ0FBQztRQUVuRCxXQUFXLENBQUMsT0FBTyxDQUFDLENBQUMsRUFBRSxJQUFJLEVBQUUsVUFBVSxFQUFFLEVBQUUsRUFBRTtZQUMzQyxJQUFJLEtBQUssQ0FBQztZQUNWLENBQUMsS0FBSyxFQUFFLE1BQU0sQ0FBQyxHQUFHLFVBQVUsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLE1BQU0sRUFBRSxNQUFNLENBQUMsQ0FBQztZQUN0RCxNQUFjLENBQUMsSUFBSSxDQUFDLEdBQUcsS0FBSyxDQUFDO1FBQ2hDLENBQUMsQ0FBQyxDQUFDO1FBRUgsT0FBTyxDQUFDLE1BQU0sRUFBRSxNQUFNLENBQUMsQ0FBQztJQUMxQixDQUFDO0lBRUQsT0FBTztRQUNMLE1BQU0sV0FBVyxHQUNmLE9BQU8sQ0FBQyxXQUFXLENBQUMsYUFBYSxFQUFFLElBQUksQ0FBQyxJQUFJLEVBQUUsQ0FBQztRQUVqRCxJQUFJLE1BQU0sR0FBRyxJQUFJLFVBQVUsQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUMvQixXQUFXLENB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QyxLQUFLLEVBQUUsRUFBRTtZQUNkLElBQUksTUFBTSxHQUFHLEtBQUssQ0FBQztZQUNuQixNQUFNLGFBQWEsR0FBRyxjQUFjLENBQUMsTUFBTSxDQUFDLENBQUM7WUFDN0MsTUFBTSxJQUFJLEdBQUcsYUFBYSxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQzlCLE1BQU0sR0FBRyxhQUFhLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFFMUIsTUFBTSxhQUFhLEdBQUcsY0FBYyxDQUFDLE1BQU0sQ0FBQyxDQUFDO1lBQzdDLE1BQU0sSUFBSSxHQUFHLGFBQWEsQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUM5QixNQUFNLEdBQUcsYUFBYSxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBRTFCLE9BQU87Z0JBQ0wsUUFBUSxDQUFDLElBQUksQ0FBQyxDQUFDLFNBQVMsQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLENBQUMsRUFBRSxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztnQkFDbEQsTUFBTSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUM7YUFDbkIsQ0FBQztRQUNKLENBQUM7UUFDRCxLQUFLLEVBQUUsQ0FBQyxNQUFNLEVBQUUsRUFBRTtZQUNoQixNQUFNLElBQUksR0FBRyxjQUFjLENBQUMsY0FBYyxDQUFDLE1BQU0sRUFBRSxRQUFRLENBQUMsQ0FBQyxDQUFDO1lBQzlELE1BQU0sS0FBSyxHQUFHLE1BQU0sQ0FBQyxPQUFPLEVBQUUsQ0FBQztZQUMvQixNQUFNLElBQUksR0FBRyxjQUFjLENBQUMsS0FBSyxDQUFDLE1BQU0sQ0FBQyxDQUFDO1lBRTFDLE9BQU8saUJBQWlCLENBQUMsQ0FBQyxJQUFJLEVBQUUsSUFBSSxFQUFFLEtBQUssQ0FBQyxDQUFDLENBQUM7UUFDaEQsQ0FBQztLQUNGLENBQUM7QUFDSixDQUFDLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgJ3JlZmxlY3QtbWV0YWRhdGEnO1xuaW1wb3J0IHtcbiAgYnVmVG9VdmFyaW50NjQsXG4gIGNvbmNhdFVpbnQ4QXJyYXlzLFxuICB1dmFyaW50NjRUb0J1Zixcbn0gZnJvbSAnLi9jcnlwdG8tdXRpbHMuanMnO1xuaW1wb3J0IHsgVHJhbnNhY3Rpb25Ob25jZSB9IGZyb20gJy4vdHJhbnNhY3Rpb24tdHJhbnNjb2RlcnMuanMnO1xuZXhwb3J0IGNsYXNzIEJpbmFyeVJlY29yZCB7XG4gIHN0YXRpYyBmcm9tQnl0ZXMoYnl0ZXM6IFVpbnQ4QXJyYXkpOiBbQmluYXJ5UmVjb3JkLCBVaW50OEFycmF5XSB7XG4gICAgY29uc3QgcmVzdWx0ID0gbmV3IHRoaXMoKTtcbiAgICBsZXQgYnVmZmVyID0gYnl0ZXM7XG5cbiAgICBjb25zdCB0cmFuc2NvZGVyczogVHJhbnNjb2Rlck1ldGFkYXRhW10gPVxuICAgICAgUmVmbGVjdC5nZXRNZXRhZGF0YSgndHJhbnNjb2RlcnMnLCByZXN1bHQpIHx8IFtdO1xuXG4gICAgdHJhbnNjb2RlcnMuZm9yRWFjaCgoeyBuYW1lLCB0cmFuc2NvZGVyIH0pID0+IHtcbiAgICAgIGxldCB2YWx1ZTtcbiAgICAgIFt2YWx1ZSwgYnVmZmVyXSA9IHRyYW5zY29kZXIucmVhZC5jYWxsKHJlc3VsdCwgYnVmZmVyKTtcbiAgICAgIChyZXN1bHQgYXMgYW55KVtuYW1lXSA9IHZhbHVlO1xuICAgIH0pO1xuXG4gICAgcmV0dXJuIFtyZXN1bHQsIGJ1ZmZlcl07XG4gIH1cblxuICB0b0J5dGVzKCk6IFVpbnQ4QXJyYXkge1xuICAgIGNvbnN0IHRyYW5zY29kZXJzOiBUcmFuc2NvZGVyTWV0YWRhdGFbXSA9XG4gICAgICBSZWZsZWN0LmdldE1ldGFkYXRhKCd0cmFuc2NvZGVycycsIHRoaXMpIHx8IFtdO1xuXG4gICAgbGV0IGJ1ZmZlciA9IG5ldyBVaW50OEFycmF5KDApO1xuICAgIHRyYW5zY29kZXJzLmZvckVhY2goKHsgbmFtZSwgdHJhbnNjb2RlciB9KSA9PiB7XG4gICAgICBidWZmZXIgPSBjb25jYXRVaW50OEFycmF5cyhbXG4gICAgICAgIGJ1ZmZlcixcbiAgICAgICAgdHJhbnNjb2Rlci53cml0ZS5jYWxsKHRoaXMsICh0aGlzIGFzIGFueSlbbmFtZV0pLFxuICAgICAgXSk7XG4gICAgfSk7XG5cbiAgICByZXR1cm4gYnVmZmVyO1xuICB9XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgVHJhbnNjb2Rlck1ldGFkYXRhPFQgPSBhbnk+IHtcbiAgbmFtZTogc3RyaW5nO1xuICB0cmFuc2NvZGVyOiBUcmFuc2NvZGVyPFQ+O1xufVxuXG5leHBvcnQgZnVuY3Rpb24gVHJhbnNjb2RlPFQ+KHRyYW5zY29kZXI6IFRyYW5zY29kZXI8VD4pIHtcbiAgcmV0dXJuICh0YXJnZXQ6IGFueSwgbmFtZTogc3RyaW5nIHwgc3ltYm9sKSA9PiB7XG4gICAgY29uc3QgdHJhbnNjb2RlcnMgPSBSZWZsZWN0LmdldE1ldGFkYXRhKCd0cmFuc2NvZGVycycsIHRhcmdldCkgfHwgW107XG4gICAgdHJhbnNjb2RlcnMucHVzaCh7IG5hbWUsIHRyYW5zY29kZXIgfSk7XG4gICAgUmVmbGVjdC5kZWZpbmVNZXRhZGF0YSgndHJhbnNjb2RlcnMnLCB0cmFuc2NvZGVycywgdGFyZ2V0KTtcbiAgfTtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBUcmFuc2NvZGVyPFQ+IHtcbiAgcmVhZDogKGJ5dGVzOiBVaW50OEFycmF5KSA9PiBbVCwgVWludDhBcnJheV07XG4gIHdyaXRlOiAob2JqZWN0OiBUKSA9PiBVaW50OEFycmF5O1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIFNlcmlhbGl6YWJsZSB7XG4gIHRvQnl0ZXM6ICgpID0+IFVpbnQ4QXJyYXk7XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgRGVzZXJpYWxpemFibGU8VD4ge1xuICBmcm9tQnl0ZXM6IChieXRlczogVWludDhBcnJheSkgPT4gW1QsIFVpbnQ4QXJyYXldO1xufVxuXG5leHBvcnQgY29uc3QgVXZhcmludDY0OiBUcmFuc2NvZGVyPG51bWJlcj4gPSB7XG4gIHJlYWQ6IChieXRlcykgPT4gYnVmVG9VdmFyaW50NjQoYnl0ZXMpLFxuICB3cml0ZTogKHVpbnQpID0+IHV2YXJpbnQ2NFRvQnVmKHVpbnQpLFxufTtcblxuZXhwb3J0IGNvbnN0IEJvb2xlYW46IFRyYW5zY29kZXI8Ym9vbGVhbj4gPSB7XG4gIHJlYWQ6IChieXRlcykgPT4gW2J5dGVzLmF0KDApICE9IDAsIGJ5dGVzLnNsaWNlKDEpXSxcbiAgd3JpdGU6IChib29sKSA9PiB7XG4gICAgcmV0dXJuIFVpbnQ4QXJyYXkuZnJvbShbYm9vbCA/IDEgOiAwXSk7XG4gIH0sXG59O1xuXG5leHBvcnQgY29uc3QgVWludDg6IFRyYW5zY29kZXI8bnVtYmVyPiA9IHtcbiAgcmVhZDogKGJ5dGVzKSA9PiBbYnl0ZXMuYXQoMCkgYXMgbnVtYmVyLCBieXRlcy5zbGljZSgxKV0sXG4gIHdyaXRlOiAodWludCkgPT4ge1xuICAgIHJldHVybiBVaW50OEFycmF5LmZyb20oW3VpbnRdKTtcbiAgfSxcbn07XG5cbmV4cG9ydCBjb25zdCBGaXhlZEJ1ZmZlciA9IChzaXplOiBudW1iZXIpOiBUcmFuc2NvZGVyPFVpbnQ4QXJyYXk+ID0+ICh7XG4gIHJlYWQ6IChieXRlcykgPT4gW2J5dGVzLnNsaWNlKDAsIHNpemUpLCBieXRlcy5zbGljZShzaXplKV0sXG4gIHdyaXRlOiAoYnl0ZXMpID0+IGJ5dGVzLFxufSk7XG5cbmV4cG9ydCBjb25zdCBWYXJCdWZmZXI6IFRyYW5zY29kZXI8VWludDhBcnJheT4gPSB7XG4gIHJlYWQ6IChieXRlcykgPT4ge1xuICAgIGNvbnN0IFtzaXplLCBidWZmZXJdID0gYnVmVG9VdmFyaW50NjQoYnl0ZXMpO1xuICAgIHJldHVybiBbYnVmZmVyLnNsaWNlKDAsIHNpemUpLCBidWZmZXIuc2xpY2Uoc2l6ZSldO1xuICB9LFxuICB3cml0ZTogKGJ5dGVzKSA9PiBjb25jYXRVaW50OEFycmF5cyhbdXZhcmludDY0VG9CdWYoYnl0ZXMubGVuZ3RoKSwgYnl0ZXNdKSxcbn07XG5leHBvcnQgY29uc3QgVHJhbnNhY3Rpb25Ob25jZVRyYW5zY29kZXI6IFRyYW5zY29kZXI8VHJhbnNhY3Rpb25Ob25jZSB8IG51bGw+ID0ge1xuICByZWFkOiAoYnl0ZXMpID0+IHtcbiAgICByZXR1cm4gVHJhbnNhY3Rpb25Ob25jZS5mcm9tQnl0ZXMoYnl0ZXMpIGFzIFtUcmFuc2FjdGlvbk5vbmNlLCBVaW50OEFycmF5XTtcbiAgfSxcbiAgd3JpdGU6IChub25jZSkgPT4ge1xuICAgIGlmIChub25jZSkge1xuICAgICAgcmV0dXJuIGNvbmNhdFVpbnQ4QXJyYXlzKFtub25jZS50b0J5dGVzKCldKTtcbiAgICB9XG4gICAgcmV0dXJuIG5ldyBVaW50OEFycmF5KDApO1xuICB9LFxufTtcblxuZXhwb3J0IGZ1bmN0aW9uIE9wdGlvbmFsPFQ+KHRyYW5zY29kZXI6IFRyYW5zY29kZXI8VD4pOiBUcmFuc2NvZGVyPFQgfCBudWxsPiB7XG4gIHJldHVybiB7XG4gICAgcmVhZDogKGJ5dGVzOiBVaW50OEFycmF5KSA9PlxuICAgICAgIWJ5dGVzLmxlbmd0aCA/IFtudWxsLCBieXRlc10gOiB0cmFuc2NvZGVyLnJlYWQoYnl0ZXMpLFxuICAgIHdyaXRlOiAodmFsdWU6IFQgfCBudWxsKSA9PlxuICAgICAgdmFsdWUgPT09IG51bGwgPyBuZXcgVWludDhBcnJheSgwKSA6IHRyYW5zY29kZXIud3JpdGUodmFsdWUpLFxuICB9O1xufVxuXG5leHBvcnQgY29uc3QgQ2h1bmtCdWZmZXIgPSAod2lkdGg6IG51bWJlcik6IFRyYW5zY29kZXI8VWludDhBcnJheVtdPiA9PiAoe1xuICByZWFkOiAoYnl0ZXMpID0+IHtcbiAgICBjb25zdCBjb3VudEFuZEJ1ZmZlciA9IGJ1ZlRvVXZhcmludDY0KGJ5dGVzKTtcbiAgICBjb25zdCBjb3VudCA9IGNvdW50QW5kQnVmZmVyWzBdO1xuICAgIGxldCBidWZmZXIgPSBjb3VudEFuZEJ1ZmZlclsxXTtcbiAgICBjb25zdCByZXN1bHQgPSBbXTtcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGNvdW50OyBpKyspIHtcbiAgICAgIHJlc3VsdC5wdXNoKGJ1ZmZlci5zbGljZSgwLCAzMykpO1xuICAgICAgYnVmZmVyID0gYnVmZmVyLnNsaWNlKDMzKTtcbiAgICB9XG5cbiAgICByZXR1cm4gW3Jlc3VsdCwgYnVmZmVyXTtcbiAgfSxcbiAgd3JpdGU6IChjaHVua3MpID0+XG4gICAgY29uY2F0VWludDhBcnJheXMoW3V2YXJpbnQ2NFRvQnVmKGNodW5rcy5sZW5ndGgpLCAuLi5jaHVua3NdKSxcbn0pO1xuXG5leHBvcnQgY29uc3QgQXJyYXlPZiA9IDxcbiAgVCBleHRlbmRzIFNlcmlhbGl6YWJsZSxcbiAgQyBleHRlbmRzIERlc2VyaWFsaXphYmxlPFQ+ICYgeyBuZXcgKCk6IFQgfVxuPihcbiAga2xhc3M6IENcbik6IFRyYW5zY29kZXI8VFtdPiA9PiAoe1xuICByZWFkOiAoYnl0ZXMpID0+IHtcbiAgICBjb25zdCBjb3VudEFuZEJ1ZmZlciA9IGJ1ZlRvVXZhcmludDY0KGJ5dGVzKTtcbiAgICBjb25zdCBjb3VudCA9IGNvdW50QW5kQnVmZmVyWzBdO1xuICAgIGxldCBidWZmZXIgPSBjb3VudEFuZEJ1ZmZlclsxXTtcblxuICAgIGNvbnN0IHJlc3VsdCA9IFtdO1xuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgY291bnQ7IGkrKykge1xuICAgICAgbGV0IG9iajtcbiAgICAgIFtvYmosIGJ1ZmZlcl0gPSBrbGFzcy5mcm9tQnl0ZXMoYnVmZmVyKTtcbiAgICAgIHJlc3VsdC5wdXNoKG9iaik7XG4gICAgfVxuXG4gICAgcmV0dXJuIFtyZXN1bHQsIGJ1ZmZlcl07XG4gIH0sXG4gIHdyaXRlOiAob2JqZWN0cykgPT4ge1xuICAgIGNvbnN0IGNvdW50ID0gdXZhcmludDY0VG9CdWYob2JqZWN0cy5sZW5ndGgpO1xuICAgIHJldHVybiBjb25jYXRVaW50OEFycmF5cyhbXG4gICAgICBjb3VudCxcbiAgICAgIC4uLm9iamVjdHMubWFwKChvYmplY3QpID0+IG9iamVjdC50b0J5dGVzKCkpLFxuICAgIF0pO1xuICB9LFxufSk7XG5cbmV4cG9ydCBjb25zdCBSZWNvcmQgPSA8XG4gIFQgZXh0ZW5kcyBTZXJpYWxpemFibGUsXG4gIEMgZXh0ZW5kcyBEZXNlcmlhbGl6YWJsZTxUPiAmIHsgbmV3ICgpOiBUIH1cbj4oXG4gIGtsYXNzOiBDXG4pOiBUcmFuc2NvZGVyPFQ+ID0+ICh7XG4gIHJlYWQ6IChieXRlcykgPT4ga2xhc3MuZnJvbUJ5dGVzKGJ5dGVzKSxcbiAgd3JpdGU6IChvYmplY3QpID0+IG9iamVjdC50b0J5dGVzKCksXG59KTtcblxuZXhwb3J0IGNvbnN0IGluc3RhbmNlVG9UeXBlID0gPFxuICBUIGV4dGVuZHMgU2VyaWFsaXphYmxlLFxuICBDIGV4dGVuZHMgRGVzZXJpYWxpemFibGU8VD4gJiB7IG5ldyAoKTogVCB9XG4+KFxuICBvYmplY3Q6IFQsXG4gIGtsYXNzTWFwOiB7IFtpbmRleDogc3RyaW5nXTogQyB9XG4pOiBudW1iZXIgPT4ge1xuICBmb3IgKGNvbnN0IFtrZXksIHZhbHVlXSBvZiBPYmplY3QuZW50cmllcyhrbGFzc01hcCkpIHtcbiAgICBpZiAob2JqZWN0IGluc3RhbmNlb2YgdmFsdWUpIHJldHVybiBwYXJzZUludChrZXkpO1xuICB9XG4gIHJldHVybiAtMTtcbn07XG5cbmV4cG9ydCBjb25zdCBFbnVtID0gPFxuICBUIGV4dGVuZHMgU2VyaWFsaXphYmxlLFxuICBDIGV4dGVuZHMgRGVzZXJpYWxpemFibGU8VD4gJiB7IG5ldyAoKTogVCB9XG4+KGtsYXNzTWFwOiB7XG4gIFtpbmRleDogc3RyaW5nXTogQztcbn0pOiBUcmFuc2NvZGVyPFQ+ID0+IHtcbiAgcmV0dXJuIHtcbiAgICByZWFkOiAoYnl0ZXMpID0+IHtcbiAgICAgIGxldCBidWZmZXIgPSBieXRlcztcbiAgICAgIGNvbnN0IHR5cGVBbmRCdWZmZXIgPSBidWZUb1V2YXJpbnQ2NChidWZmZXIpO1xuICAgICAgY29uc3QgdHlwZSA9IHR5cGVBbmRCdWZmZXJbMF07XG4gICAgICBidWZmZXIgPSB0eXBlQW5kQnVmZmVyWzFdO1xuXG4gICAgICBjb25zdCBzaXplQW5kQnVmZmVyID0gYnVmVG9VdmFyaW50NjQoYnVmZmVyKTtcbiAgICAgIGNvbnN0IHNpemUgPSBzaXplQW5kQnVmZmVyWzBdO1xuICAgICAgYnVmZmVyID0gc2l6ZUFuZEJ1ZmZlclsxXTtcblxuICAgICAgcmV0dXJuIFtcbiAgICAgICAga2xhc3NNYXBbdHlwZV0uZnJvbUJ5dGVzKGJ1ZmZlci5zbGljZSgwLCBzaXplKSlbMF0sXG4gICAgICAgIGJ1ZmZlci5zbGljZShzaXplKSxcbiAgICAgIF07XG4gICAgfSxcbiAgICB3cml0ZTogKG9iamVjdCkgPT4ge1xuICAgICAgY29uc3QgdHlwZSA9IHV2YXJpbnQ2NFRvQnVmKGluc3RhbmNlVG9UeXBlKG9iamVjdCwga2xhc3NNYXApKTtcbiAgICAgIGNvbnN0IGJ5dGVzID0gb2JqZWN0LnRvQnl0ZXMoKTtcbiAgICAgIGNvbnN0IHNpemUgPSB1dmFyaW50NjRUb0J1ZihieXRlcy5sZW5ndGgpO1xuXG4gICAgICByZXR1cm4gY29uY2F0VWludDhBcnJheXMoW3R5cGUsIHNpemUsIGJ5dGVzXSk7XG4gICAgfSxcbiAgfTtcbn07XG4iXX0=