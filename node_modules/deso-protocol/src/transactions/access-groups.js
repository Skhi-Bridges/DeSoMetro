import { AccessGroupMemberRecord, TransactionExtraData, TransactionMetadataAccessGroup, TransactionMetadataAccessGroupMembers, bs58PublicKeyToCompressedBytes, encodeUTF8ToBytes, } from '../identity/index.js';
import { constructBalanceModelTx, convertExtraData, getTxWithFeeNanos, handleSignAndSubmit, sumTransactionFees, } from '../internal.js';
import { guardTxPermission } from './utils.js';
const buildAccessGroupMetadata = (params) => {
    const metadata = new TransactionMetadataAccessGroup();
    metadata.accessGroupPublicKey = bs58PublicKeyToCompressedBytes(params.AccessGroupPublicKeyBase58Check);
    metadata.accessGroupOwnerPublicKey = bs58PublicKeyToCompressedBytes(params.AccessGroupOwnerPublicKeyBase58Check);
    metadata.accessGroupOperationType = 2;
    metadata.accessGroupKeyName = encodeUTF8ToBytes(params.AccessGroupKeyName);
    return metadata;
};
export const constructCreateAccessGroupTransaction = (params) => {
    return constructBalanceModelTx(params.AccessGroupOwnerPublicKeyBase58Check, buildAccessGroupMetadata(params), {
        ExtraData: params.ExtraData,
        MinFeeRateNanosPerKB: params.MinFeeRateNanosPerKB,
        TransactionFees: params.TransactionFees,
    });
};
export const createAccessGroup = async (params, options) => {
    const txWithFee = getTxWithFeeNanos(params.AccessGroupOwnerPublicKeyBase58Check, buildAccessGroupMetadata(params), {
        ExtraData: params.ExtraData,
        MinFeeRateNanosPerKB: params.MinFeeRateNanosPerKB,
        TransactionFees: params.TransactionFees,
    });
    if (options?.checkPermissions !== false) {
        await guardTxPermission({
            GlobalDESOLimit: txWithFee.feeNanos + sumTransactionFees(params.TransactionFees),
            // NOTE: This is more permissive than we actually need it to be, but I
            // couldn't get it to work when specifying the AccessGroupKeyName and
            // AccessGroupOwnerPublicKeyBase58Check. If anyone complains, we can
            // revisit it, but this is not a terribly sensitive permission to grant.
            AccessGroupLimitMap: [
                {
                    AccessGroupOwnerPublicKeyBase58Check: '',
                    ScopeType: 'Any',
                    AccessGroupKeyName: '',
                    OperationType: 'Any',
                    OpCount: options?.txLimitCount ?? 1,
                },
            ],
            AccessGroupMemberLimitMap: [
                {
                    AccessGroupOwnerPublicKeyBase58Check: '',
                    ScopeType: 'Any',
                    AccessGroupKeyName: '',
                    OperationType: 'Any',
                    OpCount: options?.txLimitCount ?? 1,
                },
            ],
        });
    }
    return handleSignAndSubmit('api/v0/create-access-group', params, {
        ...options,
        constructionFunction: constructCreateAccessGroupTransaction,
    });
};
export const updateAccessGroup = (params, options) => {
    return handleSignAndSubmit('api/v0/update-access-group', params, {
        ...options,
        constructionFunction: constructUpdateAccessGroupTransaction,
    });
};
export const constructUpdateAccessGroupTransaction = (params) => {
    const metadata = new TransactionMetadataAccessGroup();
    metadata.accessGroupPublicKey = bs58PublicKeyToCompressedBytes(params.AccessGroupPublicKeyBase58Check);
    metadata.accessGroupOwnerPublicKey = bs58PublicKeyToCompressedBytes(params.AccessGroupOwnerPublicKeyBase58Check);
    metadata.accessGroupOperationType = 3;
    metadata.accessGroupKeyName = encodeUTF8ToBytes(params.AccessGroupKeyName);
    return constructBalanceModelTx(params.AccessGroupOwnerPublicKeyBase58Check, metadata, {
        ExtraData: params.ExtraData,
        MinFeeRateNanosPerKB: params.MinFeeRateNanosPerKB,
        TransactionFees: params.TransactionFees,
    });
};
/**
 * https://docs.deso.org/deso-backend/construct-transactions/access-groups-api#add-access-group-members
 */
export const addAccessGroupMembers = async (params, options) => {
    const txWithFee = getTxWithFeeNanos(params.AccessGroupOwnerPublicKeyBase58Check, buildAddAccessGroupMemberMetadata(params), {
        ExtraData: params.ExtraData,
        MinFeeRateNanosPerKB: params.MinFeeRateNanosPerKB,
        TransactionFees: params.TransactionFees,
    });
    if (options?.checkPermissions !== false) {
        await guardTxPermission({
            GlobalDESOLimit: txWithFee.feeNanos + sumTransactionFees(params.TransactionFees),
            // NOTE: This is more permissive than we actually need it to be, but I
            // couldn't get it to work when specifying the AccessGroupKeyName and
            // AccessGroupOwnerPublicKeyBase58Check. If anyone complains, we can
            // revisit it, but this is not a terribly sensitive permission to grant.
            AccessGroupLimitMap: [
                {
                    AccessGroupOwnerPublicKeyBase58Check: '',
                    ScopeType: 'Any',
                    AccessGroupKeyName: '',
                    OperationType: 'Any',
                    OpCount: options?.txLimitCount ?? 1,
                },
            ],
            AccessGroupMemberLimitMap: [
                {
                    AccessGroupOwnerPublicKeyBase58Check: '',
                    ScopeType: 'Any',
                    AccessGroupKeyName: '',
                    OperationType: 'Any',
                    OpCount: options?.txLimitCount ?? 1,
                },
            ],
        });
    }
    return handleSignAndSubmit('api/v0/add-access-group-members', params, {
        ...options,
        constructionFunction: constructAddAccessGroupMembersTransaction,
    });
};
const buildAddAccessGroupMemberMetadata = (params) => {
    const metadata = new TransactionMetadataAccessGroupMembers();
    metadata.accessGroupOwnerPublicKey = bs58PublicKeyToCompressedBytes(params.AccessGroupOwnerPublicKeyBase58Check);
    metadata.accessGroupMemberOperationType = 2;
    metadata.accessGroupKeyName = encodeUTF8ToBytes(params.AccessGroupKeyName);
    metadata.accessGroupMembersList = params.AccessGroupMemberList.map((member) => {
        const newAccessGroupMember = new AccessGroupMemberRecord();
        newAccessGroupMember.accessGroupMemberPublicKey =
            bs58PublicKeyToCompressedBytes(member.AccessGroupMemberPublicKeyBase58Check);
        newAccessGroupMember.accessGroupMemberKeyName = encodeUTF8ToBytes(member.AccessGroupMemberKeyName);
        newAccessGroupMember.encryptedKey = encodeUTF8ToBytes(member.EncryptedKey);
        newAccessGroupMember.extraData = convertExtraData(member.ExtraData);
        return newAccessGroupMember;
    });
    return metadata;
};
export const constructAddAccessGroupMembersTransaction = (params) => {
    return constructBalanceModelTx(params.AccessGroupOwnerPublicKeyBase58Check, buildAddAccessGroupMemberMetadata(params), {
        ExtraData: params.ExtraData,
        MinFeeRateNanosPerKB: params.MinFeeRateNanosPerKB,
        TransactionFees: params.TransactionFees,
    });
};
/**
 * https://docs.deso.org/deso-backend/construct-transactions/access-groups-api#remove-access-group-members
 */
export const removeAccessGroupMembers = async (params, options) => {
    const txWithFee = getTxWithFeeNanos(params.AccessGroupOwnerPublicKeyBase58Check, buildRemoveAccessGroupMemberMetadata(params), {
        ExtraData: params.ExtraData,
        MinFeeRateNanosPerKB: params.MinFeeRateNanosPerKB,
        TransactionFees: params.TransactionFees,
    });
    if (options?.checkPermissions !== false) {
        await guardTxPermission({
            GlobalDESOLimit: txWithFee.feeNanos + sumTransactionFees(params.TransactionFees),
            // NOTE: This is more permissive than we actually need it to be, but I
            // couldn't get it to work when specifying the AccessGroupKeyName and
            // AccessGroupOwnerPublicKeyBase58Check. If anyone complains, we can
            // revisit it, but this is not a terribly sensitive permission to grant.
            AccessGroupLimitMap: [
                {
                    AccessGroupOwnerPublicKeyBase58Check: '',
                    ScopeType: 'Any',
                    AccessGroupKeyName: '',
                    OperationType: 'Any',
                    OpCount: options?.txLimitCount ?? 1,
                },
            ],
            AccessGroupMemberLimitMap: [
                {
                    AccessGroupOwnerPublicKeyBase58Check: '',
                    ScopeType: 'Any',
                    AccessGroupKeyName: '',
                    OperationType: 'Any',
                    OpCount: options?.txLimitCount ?? 1,
                },
            ],
        });
    }
    return handleSignAndSubmit('api/v0/remove-access-group-members', params, {
        ...options,
        constructionFunction: constructRemoveAccessGroupMembersTransaction,
    });
};
const buildRemoveAccessGroupMemberMetadata = (params) => {
    const metadata = new TransactionMetadataAccessGroupMembers();
    metadata.accessGroupOwnerPublicKey = bs58PublicKeyToCompressedBytes(params.AccessGroupOwnerPublicKeyBase58Check);
    metadata.accessGroupMemberOperationType = 3;
    metadata.accessGroupKeyName = encodeUTF8ToBytes(params.AccessGroupKeyName);
    metadata.accessGroupMembersList = params.AccessGroupMemberList.map((member) => {
        const newAccessGroupMember = new AccessGroupMemberRecord();
        newAccessGroupMember.accessGroupMemberPublicKey =
            bs58PublicKeyToCompressedBytes(member.AccessGroupMemberPublicKeyBase58Check);
        newAccessGroupMember.accessGroupMemberKeyName = encodeUTF8ToBytes(params.AccessGroupKeyName);
        newAccessGroupMember.encryptedKey = new Uint8Array(0);
        newAccessGroupMember.extraData = new TransactionExtraData();
        return newAccessGroupMember;
    });
    return metadata;
};
export const constructRemoveAccessGroupMembersTransaction = (params) => {
    return constructBalanceModelTx(params.AccessGroupOwnerPublicKeyBase58Check, buildRemoveAccessGroupMemberMetadata(params), {
        ExtraData: params.ExtraData,
        MinFeeRateNanosPerKB: params.MinFeeRateNanosPerKB,
        TransactionFees: params.TransactionFees,
    });
};
/**
 * https://docs.deso.org/deso-backend/construct-transactions/access-groups-api#update-access-group-members
 */
export const updateAccessGroupMembers = async (params, options) => {
    const txWithFee = getTxWithFeeNanos(params.AccessGroupOwnerPublicKeyBase58Check, buildUpdateAccessGroupMembersMetadata(params), {
        ExtraData: params.ExtraData,
        MinFeeRateNanosPerKB: params.MinFeeRateNanosPerKB,
        TransactionFees: params.TransactionFees,
    });
    if (options?.checkPermissions !== false) {
        await guardTxPermission({
            GlobalDESOLimit: txWithFee.feeNanos + sumTransactionFees(params.TransactionFees),
            // NOTE: This is more permissive than we actually need it to be, but I
            // couldn't get it to work when specifying the AccessGroupKeyName and
            // AccessGroupOwnerPublicKeyBase58Check. If anyone complains, we can
            // revisit it, but this is not a terribly sensitive permission to grant.
            AccessGroupLimitMap: [
                {
                    AccessGroupOwnerPublicKeyBase58Check: '',
                    ScopeType: 'Any',
                    AccessGroupKeyName: '',
                    OperationType: 'Any',
                    OpCount: options?.txLimitCount ?? 1,
                },
            ],
            AccessGroupMemberLimitMap: [
                {
                    AccessGroupOwnerPublicKeyBase58Check: '',
                    ScopeType: 'Any',
                    AccessGroupKeyName: '',
                    OperationType: 'Any',
                    OpCount: options?.txLimitCount ?? 1,
                },
            ],
        });
    }
    return handleSignAndSubmit('api/v0/update-access-group-members', params, {
        ...options,
        constructionFunction: constructUpdateAccessGroupMembersTransaction,
    });
};
const buildUpdateAccessGroupMembersMetadata = (params) => {
    const metadata = new TransactionMetadataAccessGroupMembers();
    metadata.accessGroupOwnerPublicKey = bs58PublicKeyToCompressedBytes(params.AccessGroupOwnerPublicKeyBase58Check);
    metadata.accessGroupMemberOperationType = 4;
    metadata.accessGroupKeyName = encodeUTF8ToBytes(params.AccessGroupKeyName);
    metadata.accessGroupMembersList = params.AccessGroupMemberList.map((member) => {
        const newAccessGroupMember = new AccessGroupMemberRecord();
        newAccessGroupMember.accessGroupMemberPublicKey =
            bs58PublicKeyToCompressedBytes(member.AccessGroupMemberPublicKeyBase58Check);
        newAccessGroupMember.accessGroupMemberKeyName = encodeUTF8ToBytes(member.AccessGroupMemberKeyName);
        newAccessGroupMember.encryptedKey = encodeUTF8ToBytes(member.EncryptedKey);
        newAccessGroupMember.extraData = convertExtraData(member.ExtraData);
        return newAccessGroupMember;
    });
    return metadata;
};
export const constructUpdateAccessGroupMembersTransaction = (params) => {
    return constructBalanceModelTx(params.AccessGroupOwnerPublicKeyBase58Check, buildUpdateAccessGroupMembersMetadata(params), {
        ExtraData: params.ExtraData,
        MinFeeRateNanosPerKB: params.MinFeeRateNanosPerKB,
        TransactionFees: params.TransactionFees,
    });
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYWNjZXNzLWdyb3Vwcy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy90cmFuc2FjdGlvbnMvYWNjZXNzLWdyb3Vwcy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFVQSxPQUFPLEVBQ0wsdUJBQXVCLEVBQ3ZCLG9CQUFvQixFQUNwQiw4QkFBOEIsRUFDOUIscUNBQXFDLEVBQ3JDLDhCQUE4QixFQUM5QixpQkFBaUIsR0FDbEIsTUFBTSxzQkFBc0IsQ0FBQztBQUM5QixPQUFPLEVBQ0wsdUJBQXVCLEVBQ3ZCLGdCQUFnQixFQUNoQixpQkFBaUIsRUFDakIsbUJBQW1CLEVBQ25CLGtCQUFrQixHQUNuQixNQUFNLGdCQUFnQixDQUFDO0FBRXhCLE9BQU8sRUFBRSxpQkFBaUIsRUFBRSxNQUFNLFlBQVksQ0FBQztBQUUvQyxNQUFNLHdCQUF3QixHQUFHLENBQUMsTUFBc0MsRUFBRSxFQUFFO0lBQzFFLE1BQU0sUUFBUSxHQUFHLElBQUksOEJBQThCLEVBQUUsQ0FBQztJQUN0RCxRQUFRLENBQUMsb0JBQW9CLEdBQUcsOEJBQThCLENBQzVELE1BQU0sQ0FBQywrQkFBK0IsQ0FDdkMsQ0FBQztJQUNGLFFBQVEsQ0FBQyx5QkFBeUIsR0FBRyw4QkFBOEIsQ0FDakUsTUFBTSxDQUFDLG9DQUFvQyxDQUM1QyxDQUFDO0lBQ0YsUUFBUSxDQUFDLHdCQUF3QixHQUFHLENBQUMsQ0FBQztJQUN0QyxRQUFRLENBQUMsa0JBQWtCLEdBQUcsaUJBQWlCLENBQUMsTUFBTSxDQUFDLGtCQUFrQixDQUFDLENBQUM7SUFDM0UsT0FBTyxRQUFRLENBQUM7QUFDbEIsQ0FBQyxDQUFDO0FBRUYsTUFBTSxDQUFDLE1BQU0scUNBQXFDLEdBQUcsQ0FDbkQsTUFBc0MsRUFDRyxFQUFFO0lBQzNDLE9BQU8sdUJBQXVCLENBQzVCLE1BQU0sQ0FBQyxvQ0FBb0MsRUFDM0Msd0JBQXdCLENBQUMsTUFBTSxDQUFDLEVBQ2hDO1FBQ0UsU0FBUyxFQUFFLE1BQU0s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QztJQUM5QixDQUFDLENBQ0YsQ0FBQztJQUNGLE9BQU8sUUFBUSxDQUFDO0FBQ2xCLENBQUMsQ0FBQztBQUVGLE1BQU0sQ0FBQyxNQUFNLDRDQUE0QyxHQUFHLENBQzFELE1BQTJFLEVBQ2xDLEVBQUU7SUFDM0MsT0FBTyx1QkFBdUIsQ0FDNUIsTUFBTSxDQUFDLG9DQUFvQyxFQUMzQyxxQ0FBcUMsQ0FBQyxNQUFNLENBQUMsRUFDN0M7UUFDRSxTQUFTLEVBQUUsTUFBTSxDQUFDLFNBQVM7UUFDM0Isb0JBQW9CLEVBQUUsTUFBTSxDQUFDLG9CQUFvQjtRQUNqRCxlQUFlLEVBQUUsTUFBTSxDQUFDLGVBQWU7S0FDeEMsQ0FDRixDQUFDO0FBQ0osQ0FBQyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcbiAgQWRkQWNjZXNzR3JvdXBNZW1iZXJzUmVxdWVzdCxcbiAgQWRkQWNjZXNzR3JvdXBNZW1iZXJzUmVzcG9uc2UsXG4gIENvbnN0cnVjdGVkVHJhbnNhY3Rpb25SZXNwb25zZSxcbiAgQ3JlYXRlQWNjZXNzR3JvdXBSZXF1ZXN0LFxuICBDcmVhdGVBY2Nlc3NHcm91cFJlc3BvbnNlLFxuICBSZXF1ZXN0T3B0aW9ucyxcbiAgVHhSZXF1ZXN0V2l0aE9wdGlvbmFsRmVlc0FuZEV4dHJhRGF0YSxcbn0gZnJvbSAnLi4vYmFja2VuZC10eXBlcy9pbmRleC5qcyc7XG5pbXBvcnQgeyBQYXJ0aWFsV2l0aFJlcXVpcmVkRmllbGRzIH0gZnJvbSAnLi4vZGF0YS9pbmRleC5qcyc7XG5pbXBvcnQge1xuICBBY2Nlc3NHcm91cE1lbWJlclJlY29yZCxcbiAgVHJhbnNhY3Rpb25FeHRyYURhdGEsXG4gIFRyYW5zYWN0aW9uTWV0YWRhdGFBY2Nlc3NHcm91cCxcbiAgVHJhbnNhY3Rpb25NZXRhZGF0YUFjY2Vzc0dyb3VwTWVtYmVycyxcbiAgYnM1OFB1YmxpY0tleVRvQ29tcHJlc3NlZEJ5dGVzLFxuICBlbmNvZGVVVEY4VG9CeXRlcyxcbn0gZnJvbSAnLi4vaWRlbnRpdHkvaW5kZXguanMnO1xuaW1wb3J0IHtcbiAgY29uc3RydWN0QmFsYW5jZU1vZGVsVHgsXG4gIGNvbnZlcnRFeHRyYURhdGEsXG4gIGdldFR4V2l0aEZlZU5hbm9zLFxuICBoYW5kbGVTaWduQW5kU3VibWl0LFxuICBzdW1UcmFuc2FjdGlvbkZlZXMsXG59IGZyb20gJy4uL2ludGVybmFsLmpzJztcbmltcG9ydCB7IENvbnN0cnVjdGVkQW5kU3VibWl0dGVkVHgsIFR4UmVxdWVzdE9wdGlvbnMgfSBmcm9tICcuLi90eXBlcy5qcyc7XG5pbXBvcnQgeyBndWFyZFR4UGVybWlzc2lvbiB9IGZyb20gJy4vdXRpbHMuanMnO1xuXG5jb25zdCBidWlsZEFjY2Vzc0dyb3VwTWV0YWRhdGEgPSAocGFyYW1zOiBDcmVhdGVBY2Nlc3NHcm91cFJlcXVlc3RQYXJhbXMpID0+IHtcbiAgY29uc3QgbWV0YWRhdGEgPSBuZXcgVHJhbnNhY3Rpb25NZXRhZGF0YUFjY2Vzc0dyb3VwKCk7XG4gIG1ldGFkYXRhLmFjY2Vzc0dyb3VwUHVibGljS2V5ID0gYnM1OFB1YmxpY0tleVRvQ29tcHJlc3NlZEJ5dGVzKFxuICAgIHBhcmFtcy5BY2Nlc3NHcm91cFB1YmxpY0tleUJhc2U1OENoZWNrXG4gICk7XG4gIG1ldGFkYXRhLmFjY2Vzc0dyb3VwT3duZXJQdWJsaWNLZXkgPSBiczU4UHVibGljS2V5VG9Db21wcmVzc2VkQnl0ZXMoXG4gICAgcGFyYW1zLkFjY2Vzc0dyb3VwT3duZXJQdWJsaWNLZXlCYXNlNThDaGVja1xuICApO1xuICBtZXRhZGF0YS5hY2Nlc3NHcm91cE9wZXJhdGlvblR5cGUgPSAyO1xuICBtZXRhZGF0YS5hY2Nlc3NHcm91cEtleU5hbWUgPSBlbmNvZGVVVEY4VG9CeXRlcyhwYXJhbXMuQWNjZXNzR3JvdXBLZXlOYW1lKTtcbiAgcmV0dXJuIG1ldGFkYXRhO1xufTtcblxuZXhwb3J0IGNvbnN0IGNvbnN0cnVjdENyZWF0ZUFjY2Vzc0dyb3VwVHJhbnNhY3Rpb24gPSAoXG4gIHBhcmFtczogQ3JlYXRlQWNjZXNzR3JvdXBSZXF1ZXN0UGFyYW1zXG4pOiBQcm9taXNlPENvbnN0cnVjdGVkVHJhbnNhY3Rpb25SZXNwb25zZT4gPT4ge1xuICByZXR1cm4gY29uc3RydWN0QmFsYW5jZU1vZGVsVHgoXG4gICAgcGFyYW1zLkFjY2Vzc0dyb3VwT3duZXJQdWJsaWNLZXlCYXNlNThDaGVjayxcbiAgICBidWlsZEFjY2Vzc0dyb3VwTWV0YWRhdGEocGFyYW1zKSxcbiAgICB7XG4gICAgICBFeHRyYURhdGE6IHBhcmFtcy5FeHRyYURhdGEsXG4gICAgICBNaW5GZWVSYXRlTmFub3NQZXJLQjogcGFyYW1zLk1pbkZlZVJhdGVOYW5vc1BlcktCLFxuICAgICAgVHJhbnNhY3Rpb25GZWVzOiBwYXJhbXMuVHJhbnNhY3Rpb25GZWVzLFxuICAgIH1cbiAgKTtcbn07XG5cbi8qKlxuICogaHR0cHM6Ly9kb2NzLmRlc28ub3JnL2Rlc28tYmFja2VuZC9jb25zdHJ1Y3QtdHJhbnNhY3Rpb25zL2FjY2Vzcy1ncm91cHMtYXBpI2NyZWF0ZS1hY2Nlc3MtZ3JvdXBcbiAqL1xuZXhwb3J0IHR5cGUgQ3JlYXRlQWNjZXNzR3JvdXBSZXF1ZXN0UGFyYW1zID1cbiAgVHhSZXF1ZXN0V2l0aE9wdGlvbmFsRmVlc0FuZEV4dHJhRGF0YTxcbiAgICBQYXJ0aWFsV2l0aFJlcXVpcmVkRmllbGRzPFxuICAgICAgQ3JlYXRlQWNjZXNzR3JvdXBSZXF1ZXN0LFxuICAgICAgfCAnQWNjZXNzR3JvdXBPd25lclB1YmxpY0tleUJhc2U1OENoZWNrJ1xuICAgICAgfCAnQWNjZXNzR3JvdXBLZXlOYW1lJ1xuICAgICAgfCAnQWNjZXNzR3JvdXBQdWJsaWNLZXlCYXNlNThDaGVjaydcbiAgICA+XG4gID47XG5leHBvcnQgY29uc3QgY3JlYXRlQWNjZXNzR3JvdXAgPSBhc3luYyAoXG4gIHBhcmFtczogQ3JlYXRlQWNjZXNzR3JvdXBSZXF1ZXN0UGFyYW1zLFxuICBvcHRpb25zPzogVHhSZXF1ZXN0T3B0aW9uc1xuKTogUHJvbWlzZTxDb25zdHJ1Y3RlZEFuZFN1Ym1pdHRlZFR4PENyZWF0ZUFjY2Vzc0dyb3VwUmVzcG9uc2U+PiA9PiB7XG4gIGNvbnN0IHR4V2l0aEZlZSA9IGdldFR4V2l0aEZlZU5hbm9zKFxuICAgIHBhcmFtcy5BY2Nlc3NHcm91cE93bmVyUHVibGljS2V5QmFzZTU4Q2hlY2ssXG4gICAgYnVpbGRBY2Nlc3NHcm91cE1ldGFkYXRhKHBhcmFtcyksXG4gICAge1xuICAgICAgRXh0cmFEYXRhOiBwYXJhbXMuRXh0cmFEYXRhLFxuICAgICAgTWluRmVlUmF0ZU5hbm9zUGVyS0I6IHBhcmFtcy5NaW5GZWVSYXRlTmFub3NQZXJLQixcbiAgICAgIFRyYW5zYWN0aW9uRmVlczogcGFyYW1zLlRyYW5zYWN0aW9uRmVlcyxcbiAgICB9XG4gICk7XG5cbiAgaWYgKG9wdGlvbnM/LmNoZWNrUGVybWlzc2lvbnMgIT09IGZhbHNlKSB7XG4gICAgYXdhaXQgZ3VhcmRUeFBlcm1pc3Npb24oe1xuICAgICAgR2xvYmFsREVTT0xpbWl0OlxuICAgICAgICB0eFdpdGhGZWUuZmVlTmFub3MgKyBzdW1UcmFuc2FjdGlvbkZlZXMocGFyYW1zLlRyYW5zYWN0aW9uRmVlcyksXG4gICAgICAvLyBOT1RFOiBUaGlzIGlzIG1vcmUgcGVybWlzc2l2ZSB0aGFuIHdlIGFjdHVhbGx5IG5lZWQgaXQgdG8gYmUsIGJ1dCBJXG4gICAgICAvLyBjb3VsZG4ndCBnZXQgaXQgdG8gd29yayB3aGVuIHNwZWNpZnlpbmcgdGhlIEFjY2Vzc0dyb3VwS2V5TmFtZSBhbmRcbiAgICAgIC8vIEFjY2Vzc0dyb3VwT3duZXJQdWJsaWNLZXlCYXNlNThDaGVjay4gSWYgYW55b25lIGNvbXBsYWlucywgd2UgY2FuXG4gICAgICAvLyByZXZpc2l0IGl0LCBidXQgdGhpcyBpcyBub3QgYSB0ZXJyaWJseSBzZW5zaXRpdmUgcGVybWlzc2lvbiB0byBncmFudC5cbiAgICAgIEFjY2Vzc0dyb3VwTGltaXRNYXA6IFtcbiAgICAgICAge1xuICAgICAgICAgIEFjY2Vzc0dyb3VwT3duZXJQdWJsaWNLZXlCYXNlNThDaGVjazogJycsXG4gICAgICAgICAgU2NvcGVUeXBlOiAnQW55JyxcbiAgICAgICAgICBBY2Nlc3NHcm91cEtleU5hbWU6ICcnLFxuICAgICAgICAgIE9wZXJhdGlvblR5cGU6ICdBbnknLFxuICAgICAgICAgIE9wQ291bnQ6IG9wdGlvbnM/LnR4TGltaXRDb3VudCA/PyAxLFxuICAgICAgICB9LFxuICAgICAgXSxcbiAgICAgIEFjY2Vzc0dyb3VwTWVtYmVyTGltaXRNYXA6IFtcbiAgICAgICAge1xuICAgICAgICAgIEFjY2Vzc0dyb3VwT3duZXJQdWJsaWNLZXlCYXNlNThDaGVjazogJycsXG4gICAgICAgICAgU2NvcGVUeXBlOiAnQW55JyxcbiAgICAgICAgICBBY2Nlc3NHcm91cEtleU5hbWU6ICcnLFxuICAgICAgICAgIE9wZXJhdGlvblR5cGU6ICdBbnknLFxuICAgICAgICAgIE9wQ291bnQ6IG9wdGlvbnM/LnR4TGltaXRDb3VudCA/PyAxLFxuICAgICAgICB9LFxuICAgICAgXSxcbiAgICB9KTtcbiAgfVxuXG4gIHJldHVybiBoYW5kbGVTaWduQW5kU3VibWl0KCdhcGkvdjAvY3JlYXRlLWFjY2Vzcy1ncm91cCcsIHBhcmFtcywge1xuICAgIC4uLm9wdGlvbnMsXG4gICAgY29uc3RydWN0aW9uRnVuY3Rpb246IGNvbnN0cnVjdENyZWF0ZUFjY2Vzc0dyb3VwVHJhbnNhY3Rpb24sXG4gIH0pO1xufTtcblxuLyoqXG4gKiBodHRwczovL2RvY3MuZGVzby5vcmcvZGVzby1iYWNrZW5kL2NvbnN0cnVjdC10cmFuc2FjdGlvbnMvYWNjZXNzLWdyb3Vwcy1hcGkjdXBkYXRlLWFjY2Vzcy1ncm91cFxuICovXG5leHBvcnQgdHlwZSBVcGRhdGVBY2Nlc3NHcm91cFJlcXVlc3RQYXJhbXMgPVxuICBUeFJlcXVlc3RXaXRoT3B0aW9uYWxGZWVzQW5kRXh0cmFEYXRhPFxuICAgIFBhcnRpYWxXaXRoUmVxdWlyZWRGaWVsZHM8XG4gICAgICBDcmVhdGVBY2Nlc3NHcm91cFJlcXVlc3QsXG4gICAgICB8ICdBY2Nlc3NHcm91cE93bmVyUHVibGljS2V5QmFzZTU4Q2hlY2snXG4gICAgICB8ICdBY2Nlc3NHcm91cEtleU5hbWUnXG4gICAgICB8ICdBY2Nlc3NHcm91cFB1YmxpY0tleUJhc2U1OENoZWNrJ1xuICAgID5cbiAgPjtcbmV4cG9ydCBjb25zdCB1cGRhdGVBY2Nlc3NHcm91cCA9IChcbiAgcGFyYW1zOiBVcGRhdGVBY2Nlc3NHcm91cFJlcXVlc3RQYXJhbXMsXG4gIG9wdGlvbnM/OiBSZXF1ZXN0T3B0aW9uc1xuKTogUHJvbWlzZTxDb25zdHJ1Y3RlZEFuZFN1Ym1pdHRlZFR4PENyZWF0ZUFjY2Vzc0dyb3VwUmVzcG9uc2U+PiA9PiB7XG4gIHJldHVybiBoYW5kbGVTaWduQW5kU3VibWl0KCdhcGkvdjAvdXBkYXRlLWFjY2Vzcy1ncm91cCcsIHBhcmFtcywge1xuICAgIC4uLm9wdGlvbnMsXG4gICAgY29uc3RydWN0aW9uRnVuY3Rpb246IGNvbnN0cnVjdFVwZGF0ZUFjY2Vzc0dyb3VwVHJhbnNhY3Rpb24sXG4gIH0pO1xufTtcblxuZXhwb3J0IGNvbnN0IGNvbnN0cnVjdFVwZGF0ZUFjY2Vzc0dyb3VwVHJhbnNhY3Rpb24gPSAoXG4gIHBhcmFtczogVXBkYXRlQWNjZXNzR3JvdXBSZXF1ZXN0UGFyYW1zXG4pOiBQcm9taXNlPENvbnN0cnVjdGVkVHJhbnNhY3Rpb25SZXNwb25zZT4gPT4ge1xuICBjb25zdCBtZXRhZGF0YSA9IG5ldyBUcmFuc2FjdGlvbk1ldGFkYXRhQWNjZXNzR3JvdXAoKTtcbiAgbWV0YWRhdGEuYWNjZXNzR3JvdXBQdWJsaWNLZXkgPSBiczU4UHVibGljS2V5VG9Db21wcmVzc2VkQnl0ZXMoXG4gICAgcGFyYW1zLkFjY2Vzc0dyb3VwUHVibGljS2V5QmFzZTU4Q2hlY2tcbiAgKTtcbiAgbWV0YWRhdGEuYWNjZXNzR3JvdXBPd25lclB1YmxpY0tleSA9IGJzNThQdWJsaWNLZXlUb0NvbXByZXNzZWRCeXRlcyhcbiAgICBwYXJhbXMuQWNjZXNzR3JvdXBPd25lclB1YmxpY0tleUJhc2U1OENoZWNrXG4gICk7XG4gIG1ldGFkYXRhLmFjY2Vzc0dyb3VwT3BlcmF0aW9uVHlwZSA9IDM7XG4gIG1ldGFkYXRhLmFjY2Vzc0dyb3VwS2V5TmFtZSA9IGVuY29kZVVURjhUb0J5dGVzKHBhcmFtcy5BY2Nlc3NHcm91cEtleU5hbWUpO1xuICByZXR1cm4gY29uc3RydWN0QmFsYW5jZU1vZGVsVHgoXG4gICAgcGFyYW1zLkFjY2Vzc0dyb3VwT3duZXJQdWJsaWNLZXlCYXNlNThDaGVjayxcbiAgICBtZXRhZGF0YSxcbiAgICB7XG4gICAgICBFeHRyYURhdGE6IHBhcmFtcy5FeHRyYURhdGEsXG4gICAgICBNaW5GZWVSYXRlTmFub3NQZXJLQjogcGFyYW1zLk1pbkZlZVJhdGVOYW5vc1BlcktCLFxuICAgICAgVHJhbnNhY3Rpb25GZWVzOiBwYXJhbXMuVHJhbnNhY3Rpb25GZWVzLFxuICAgIH1cbiAgKTtcbn07XG5cbi8qKlxuICogaHR0cHM6Ly9kb2NzLmRlc28ub3JnL2Rlc28tYmFja2VuZC9jb25zdHJ1Y3QtdHJhbnNhY3Rpb25zL2FjY2Vzcy1ncm91cHMtYXBpI2FkZC1hY2Nlc3MtZ3JvdXAtbWVtYmVyc1xuICovXG5leHBvcnQgY29uc3QgYWRkQWNjZXNzR3JvdXBNZW1iZXJzID0gYXN5bmMgKFxuICBwYXJhbXM6IFR4UmVxdWVzdFdpdGhPcHRpb25hbEZlZXNBbmRFeHRyYURhdGE8QWRkQWNjZXNzR3JvdXBNZW1iZXJzUmVxdWVzdD4sXG4gIG9wdGlvbnM/OiBUeFJlcXVlc3RPcHRpb25zXG4pOiBQcm9taXNlPENvbnN0cnVjdGVkQW5kU3VibWl0dGVkVHg8QWRkQWNjZXNzR3JvdXBNZW1iZXJzUmVzcG9uc2U+PiA9PiB7XG4gIGNvbnN0IHR4V2l0aEZlZSA9IGdldFR4V2l0aEZlZU5hbm9zKFxuICAgIHBhcmFtcy5BY2Nlc3NHcm91cE93bmVyUHVibGljS2V5QmFzZTU4Q2hlY2ssXG4gICAgYnVpbGRBZGRBY2Nlc3NHcm91cE1lbWJlck1ldGFkYXRhKHBhcmFtcyksXG4gICAge1xuICAgICAgRXh0cmFEYXRhOiBwYXJhbXMuRXh0cmFEYXRhLFxuICAgICAgTWluRmVlUmF0ZU5hbm9zUGVyS0I6IHBhcmFtcy5NaW5GZWVSYXRlTmFub3NQZXJLQixcbiAgICAgIFRyYW5zYWN0aW9uRmVlczogcGFyYW1zLlRyYW5zYWN0aW9uRmVlcyxcbiAgICB9XG4gICk7XG5cbiAgaWYgKG9wdGlvbnM/LmNoZWNrUGVybWlzc2lvbnMgIT09IGZhbHNlKSB7XG4gICAgYXdhaXQgZ3VhcmRUeFBlcm1pc3Npb24oe1xuICAgICAgR2xvYmFsREVTT0xpbWl0OlxuICAgICAgICB0eFdpdGhGZWUuZmVlTmFub3MgKyBzdW1UcmFuc2FjdGlvbkZlZXMocGFyYW1zLlRyYW5zYWN0aW9uRmVlcyksXG4gICAgICAvLyBOT1RFOiBUaGlzIGlzIG1vcmUgcGVybWlzc2l2ZSB0aGFuIHdlIGFjdHVhbGx5IG5lZWQgaXQgdG8gYmUsIGJ1dCBJXG4gICAgICAvLyBjb3VsZG4ndCBnZXQgaXQgdG8gd29yayB3aGVuIHNwZWNpZnlpbmcgdGhlIEFjY2Vzc0dyb3VwS2V5TmFtZSBhbmRcbiAgICAgIC8vIEFjY2Vzc0dyb3VwT3duZXJQdWJsaWNLZXlCYXNlNThDaGVjay4gSWYgYW55b25lIGNvbXBsYWlucywgd2UgY2FuXG4gICAgICAvLyByZXZpc2l0IGl0LCBidXQgdGhpcyBpcyBub3QgYSB0ZXJyaWJseSBzZW5zaXRpdmUgcGVybWlzc2lvbiB0byBncmFudC5cbiAgICAgIEFjY2Vzc0dyb3VwTGltaXRNYXA6IFtcbiAgICAgICAge1xuICAgICAgICAgIEFjY2Vzc0dyb3VwT3duZXJQdWJsaWNLZXlCYXNlNThDaGVjazogJycsXG4gICAgICAgICAgU2NvcGVUeXBlOiAnQW55JyxcbiAgICAgICAgICBBY2Nlc3NHcm91cEtleU5hbWU6ICcnLFxuICAgICAgICAgIE9wZXJhdGlvblR5cGU6ICdBbnknLFxuICAgICAgICAgIE9wQ291bnQ6IG9wdGlvbnM/LnR4TGltaXRDb3VudCA/PyAxLFxuICAgICAgICB9LFxuICAgICAgXSxcbiAgICAgIEFjY2Vzc0dyb3VwTWVtYmVyTGltaXRNYXA6IFtcbiAgICAgICAge1xuICAgICAgICAgIEFjY2Vzc0dyb3VwT3duZXJQdWJsaWNLZXlCYXNlNThDaGVjazogJycsXG4gICAgICAgICAgU2NvcGVUeXBlOiAnQW55JyxcbiAgICAgICAgICBBY2Nlc3NHcm91cEtleU5hbWU6ICcnLFxuICAgICAgICAgIE9wZXJhdGlvblR5cGU6ICdBbnknLFxuICAgICAgICAgIE9wQ291bnQ6IG9wdGlvbnM/LnR4TGltaXRDb3VudCA/PyAxLFxuICAgICAgICB9LFxuICAgICAgXSxcbiAgICB9KTtcbiAgfVxuXG4gIHJldHVybiBoYW5kbGVTaWduQW5kU3VibWl0KCdhcGkvdjAvYWRkLWFjY2Vzcy1ncm91cC1tZW1iZXJzJywgcGFyYW1zLCB7XG4gICAgLi4ub3B0aW9ucyxcbiAgICBjb25zdHJ1Y3Rpb25GdW5jdGlvbjogY29uc3RydWN0QWRkQWNjZXNzR3JvdXBNZW1iZXJzVHJhbnNhY3Rpb24sXG4gIH0pO1xufTtcblxuY29uc3QgYnVpbGRBZGRBY2Nlc3NHcm91cE1lbWJlck1ldGFkYXRhID0gKFxuICBwYXJhbXM6IFR4UmVxdWVzdFdpdGhPcHRpb25hbEZlZXNBbmRFeHRyYURhdGE8QWRkQWNjZXNzR3JvdXBNZW1iZXJzUmVxdWVzdD5cbikgPT4ge1xuICBjb25zdCBtZXRhZGF0YSA9IG5ldyBUcmFuc2FjdGlvbk1ldGFkYXRhQWNjZXNzR3JvdXBNZW1iZXJzKCk7XG4gIG1ldGFkYXRhLmFjY2Vzc0dyb3VwT3duZXJQdWJsaWNLZXkgPSBiczU4UHVibGljS2V5VG9Db21wcmVzc2VkQnl0ZXMoXG4gICAgcGFyYW1zLkFjY2Vzc0dyb3VwT3duZXJQdWJsaWNLZXlCYXNlNThDaGVja1xuICApO1xuICBtZXRhZGF0YS5hY2Nlc3NHcm91cE1lbWJlck9wZXJhdGlvblR5cGUgPSAyO1xuICBtZXRhZGF0YS5hY2Nlc3NHcm91cEtleU5hbWUgPSBlbmNvZGVVVEY4VG9CeXRlcyhwYXJhbXMuQWNjZXNzR3JvdXBLZXlOYW1lKTtcbiAgbWV0YWRhdGEuYWNjZXNzR3JvdXBNZW1iZXJzTGlzdCA9IHBhcmFtcy5BY2Nlc3NHcm91cE1lbWJlckxpc3QubWFwKFxuICAgIChtZW1iZXIpID0+IHtcbiAgICAgIGNvbnN0IG5ld0FjY2Vzc0dyb3VwTWVtYmVyID0gbmV3IEFjY2Vzc0dyb3VwTWVtYmVyUmVjb3JkKCk7XG4gICAgICBuZXdBY2Nlc3NHcm91cE1lbWJlci5hY2Nlc3NHcm91cE1lbWJlclB1YmxpY0tleSA9XG4gICAgICAgIGJzNThQdWJsaWNLZXlUb0NvbXByZXNzZWRCeXRlcyhcbiAgICAgICAgICBtZW1iZXIuQWNjZXNzR3JvdXBNZW1iZXJQdWJsaWNLZXlCYXNlNThDaGVja1xuICAgICAgICApO1xuICAgICAgbmV3QWNjZXNzR3JvdXBNZW1iZXIuYWNjZXNzR3JvdXBNZW1iZXJLZXlOYW1lID0gZW5jb2RlVVRGOFRvQnl0ZXMoXG4gICAgICAgIG1lbWJlci5BY2Nlc3NHcm91cE1lbWJlcktleU5hbWVcbiAgICAgICk7XG4gICAgICBuZXdBY2Nlc3NHcm91cE1lbWJlci5lbmNyeXB0ZWRLZXkgPSBlbmNvZGVVVEY4VG9CeXRlcyhcbiAgICAgICAgbWVtYmVyLkVuY3J5cHRlZEtleVxuICAgICAgKTtcbiAgICAgIG5ld0FjY2Vzc0dyb3VwTWVtYmVyLmV4dHJhRGF0YSA9IGNvbnZlcnRFeHRyYURhdGEobWVtYmVyLkV4dHJhRGF0YSk7XG4gICAgICByZXR1cm4gbmV3QWNjZXNzR3JvdXBNZW1iZXI7XG4gICAgfVxuICApO1xuICByZXR1cm4gbWV0YWRhdGE7XG59O1xuXG5leHBvcnQgY29uc3QgY29uc3RydWN0QWRkQWNjZXNzR3JvdXBNZW1iZXJzVHJhbnNhY3Rpb24gPSAoXG4gIHBhcmFtczogVHhSZXF1ZXN0V2l0aE9wdGlvbmFsRmVlc0FuZEV4dHJhRGF0YTxBZGRBY2Nlc3NHcm91cE1lbWJlcnNSZXF1ZXN0PlxuKTogUHJvbWlzZTxDb25zdHJ1Y3RlZFRyYW5zYWN0aW9uUmVzcG9uc2U+ID0+IHtcbiAgcmV0dXJuIGNvbnN0cnVjdEJhbGFuY2VNb2RlbFR4KFxuICAgIHBhcmFtcy5BY2Nlc3NHcm91cE93bmVyUHVibGljS2V5QmFzZTU4Q2hlY2ssXG4gICAgYnVpbGRBZGRBY2Nlc3NHcm91cE1lbWJlck1ldGFkYXRhKHBhcmFtcyksXG4gICAge1xuICAgICAgRXh0cmFEYXRhOiBwYXJhbXMuRXh0cmFEYXRhLFxuICAgICAgTWluRmVlUmF0ZU5hbm9zUGVyS0I6IHBhcmFtcy5NaW5GZWVSYXRlTmFub3NQZXJLQixcbiAgICAgIFRyYW5zYWN0aW9uRmVlczogcGFyYW1zLlRyYW5zYWN0aW9uRmVlcyxcbiAgICB9XG4gICk7XG59O1xuXG4vKipcbiAqIGh0dHBzOi8vZG9jcy5kZXNvLm9yZy9kZXNvLWJhY2tlbmQvY29uc3RydWN0LXRyYW5zYWN0aW9ucy9hY2Nlc3MtZ3JvdXBzLWFwaSNyZW1vdmUtYWNjZXNzLWdyb3VwLW1lbWJlcnNcbiAqL1xuZXhwb3J0IGNvbnN0IHJlbW92ZUFjY2Vzc0dyb3VwTWVtYmVycyA9IGFzeW5jIChcbiAgcGFyYW1zOiBUeFJlcXVlc3RXaXRoT3B0aW9uYWxGZWVzQW5kRXh0cmFEYXRhPEFkZEFjY2Vzc0dyb3VwTWVtYmVyc1JlcXVlc3Q+LFxuICBvcHRpb25zPzogVHhSZXF1ZXN0T3B0aW9uc1xuKTogUHJvbWlzZTxDb25zdHJ1Y3RlZEFuZFN1Ym1pdHRlZFR4PEFkZEFjY2Vzc0dyb3VwTWVtYmVyc1Jlc3BvbnNlPj4gPT4ge1xuICBjb25zdCB0eFdpdGhGZWUgPSBnZXRUeFdpdGhGZWVOYW5vcyhcbiAgICBwYXJhbXMuQWNjZXNzR3JvdXBPd25lclB1YmxpY0tleUJhc2U1OENoZWNrLFxuICAgIGJ1aWxkUmVtb3ZlQWNjZXNzR3JvdXBNZW1iZXJNZXRhZGF0YShwYXJhbXMpLFxuICAgIHtcbiAgICAgIEV4dHJhRGF0YTogcGFyYW1zLkV4dHJhRGF0YSxcbiAgICAgIE1pbkZlZVJhdGVOYW5vc1BlcktCOiBwYXJhbXMuTWluRmVlUmF0ZU5hbm9zUGVyS0IsXG4gICAgICBUcmFuc2FjdGlvbkZlZXM6IHBhcmFtcy5UcmFuc2FjdGlvbkZlZXMsXG4gICAgfVxuICApO1xuXG4gIGlmIChvcHRpb25zPy5jaGVja1Blcm1pc3Npb25zICE9PSBmYWxzZSkge1xuICAgIGF3YWl0IGd1YXJkVHhQZXJtaXNzaW9uKHtcbiAgICAgIEdsb2JhbERFU09MaW1pdDpcbiAgICAgICAgdHhXaXRoRmVlLmZlZU5hbm9zICsgc3VtVHJhbnNhY3Rpb25GZWVzKHBhcmFtcy5UcmFuc2FjdGlvbkZlZXMpLFxuICAgICAgLy8gTk9URTogVGhpcyBpcyBtb3JlIHBlcm1pc3NpdmUgdGhhbiB3ZSBhY3R1YWxseSBuZWVkIGl0IHRvIGJlLCBidXQgSVxuICAgICAgLy8gY291bGRuJ3QgZ2V0IGl0IHRvIHdvcmsgd2hlbiBzcGVjaWZ5aW5nIHRoZSBBY2Nlc3NHcm91cEtleU5hbWUgYW5kXG4gICAgICAvLyBBY2Nlc3NHcm91cE93bmVyUHVibGljS2V5QmFzZTU4Q2hlY2suIElmIGFueW9uZSBjb21wbGFpbnMsIHdlIGNhblxuICAgICAgLy8gcmV2aXNpdCBpdCwgYnV0IHRoaXMgaXMgbm90IGEgdGVycmlibHkgc2Vuc2l0aXZlIHBlcm1pc3Npb24gdG8gZ3JhbnQuXG4gICAgICBBY2Nlc3NHcm91cExpbWl0TWFwOiBbXG4gICAgICAgIHtcbiAgICAgICAgICBBY2Nlc3NHcm91cE93bmVyUHVibGljS2V5QmFzZTU4Q2hlY2s6ICcnLFxuICAgICAgICAgIFNjb3BlVHlwZTogJ0FueScsXG4gICAgICAgICAgQWNjZXNzR3JvdXBLZXlOYW1lOiAnJyxcbiAgICAgICAgICBPcGVyYXRpb25UeXBlOiAnQW55JyxcbiAgICAgICAgICBPcENvdW50OiBvcHRpb25zPy50eExpbWl0Q291bnQgPz8gMSxcbiAgICAgICAgfSxcbiAgICAgIF0sXG4gICAgICBBY2Nlc3NHcm91cE1lbWJlckxpbWl0TWFwOiBbXG4gICAgICAgIHtcbiAgICAgICAgICBBY2Nlc3NHcm91cE93bmVyUHVibGljS2V5QmFzZTU4Q2hlY2s6ICcnLFxuICAgICAgICAgIFNjb3BlVHlwZTogJ0FueScsXG4gICAgICAgICAgQWNjZXNzR3JvdXBLZXlOYW1lOiAnJyxcbiAgICAgICAgICBPcGVyYXRpb25UeXBlOiAnQW55JyxcbiAgICAgICAgICBPcENvdW50OiBvcHRpb25zPy50eExpbWl0Q291bnQgPz8gMSxcbiAgICAgICAgfSxcbiAgICAgIF0sXG4gICAgfSk7XG4gIH1cbiAgcmV0dXJuIGhhbmRsZVNpZ25BbmRTdWJtaXQoJ2FwaS92MC9yZW1vdmUtYWNjZXNzLWdyb3VwLW1lbWJlcnMnLCBwYXJhbXMsIHtcbiAgICAuLi5vcHRpb25zLFxuICAgIGNvbnN0cnVjdGlvbkZ1bmN0aW9uOiBjb25zdHJ1Y3RSZW1vdmVBY2Nlc3NHcm91cE1lbWJlcnNUcmFuc2FjdGlvbixcbiAgfSk7XG59O1xuXG5jb25zdCBidWlsZFJlbW92ZUFjY2Vzc0dyb3VwTWVtYmVyTWV0YWRhdGEgPSAoXG4gIHBhcmFtczogVHhSZXF1ZXN0V2l0aE9wdGlvbmFsRmVlc0FuZEV4dHJhRGF0YTxBZGRBY2Nlc3NHcm91cE1lbWJlcnNSZXF1ZXN0PlxuKSA9PiB7XG4gIGNvbnN0IG1ldGFkYXRhID0gbmV3IFRyYW5zYWN0aW9uTWV0YWRhdGFBY2Nlc3NHcm91cE1lbWJlcnMoKTtcbiAgbWV0YWRhdGEuYWNjZXNzR3JvdXBPd25lclB1YmxpY0tleSA9IGJzNThQdWJsaWNLZXlUb0NvbXByZXNzZWRCeXRlcyhcbiAgICBwYXJhbXMuQWNjZXNzR3JvdXBPd25lclB1YmxpY0tleUJhc2U1OENoZWNrXG4gICk7XG4gIG1ldGFkYXRhLmFjY2Vzc0dyb3VwTWVtYmVyT3BlcmF0aW9uVHlwZSA9IDM7XG4gIG1ldGFkYXRhLmFjY2Vzc0dyb3VwS2V5TmFtZSA9IGVuY29kZVVURjhUb0J5dGVzKHBhcmFtcy5BY2Nlc3NHcm91cEtleU5hbWUpO1xuICBtZXRhZGF0YS5hY2Nlc3NHcm91cE1lbWJlcnNMaXN0ID0gcGFyYW1zLkFjY2Vzc0dyb3VwTWVtYmVyTGlzdC5tYXAoXG4gICAgKG1lbWJlcikgPT4ge1xuICAgICAgY29uc3QgbmV3QWNjZXNzR3JvdXBNZW1iZXIgPSBuZXcgQWNjZXNzR3JvdXBNZW1iZXJSZWNvcmQoKTtcbiAgICAgIG5ld0FjY2Vzc0dyb3VwTWVtYmVyLmFjY2Vzc0dyb3VwTWVtYmVyUHVibGljS2V5ID1cbiAgICAgICAgYnM1OFB1YmxpY0tleVRvQ29tcHJlc3NlZEJ5dGVzKFxuICAgICAgICAgIG1lbWJlci5BY2Nlc3NHcm91cE1lbWJlclB1YmxpY0tleUJhc2U1OENoZWNrXG4gICAgICAgICk7XG4gICAgICBuZXdBY2Nlc3NHcm91cE1lbWJlci5hY2Nlc3NHcm91cE1lbWJlcktleU5hbWUgPSBlbmNvZGVVVEY4VG9CeXRlcyhcbiAgICAgICAgcGFyYW1zLkFjY2Vzc0dyb3VwS2V5TmFtZVxuICAgICAgKTtcbiAgICAgIG5ld0FjY2Vzc0dyb3VwTWVtYmVyLmVuY3J5cHRlZEtleSA9IG5ldyBVaW50OEFycmF5KDApO1xuICAgICAgbmV3QWNjZXNzR3JvdXBNZW1iZXIuZXh0cmFEYXRhID0gbmV3IFRyYW5zYWN0aW9uRXh0cmFEYXRhKCk7XG4gICAgICByZXR1cm4gbmV3QWNjZXNzR3JvdXBNZW1iZXI7XG4gICAgfVxuICApO1xuICByZXR1cm4gbWV0YWRhdGE7XG59O1xuZXhwb3J0IGNvbnN0IGNvbnN0cnVjdFJlbW92ZUFjY2Vzc0dyb3VwTWVtYmVyc1RyYW5zYWN0aW9uID0gKFxuICBwYXJhbXM6IFR4UmVxdWVzdFdpdGhPcHRpb25hbEZlZXNBbmRFeHRyYURhdGE8QWRkQWNjZXNzR3JvdXBNZW1iZXJzUmVxdWVzdD5cbik6IFByb21pc2U8Q29uc3RydWN0ZWRUcmFuc2FjdGlvblJlc3BvbnNlPiA9PiB7XG4gIHJldHVybiBjb25zdHJ1Y3RCYWxhbmNlTW9kZWxUeChcbiAgICBwYXJhbXMuQWNjZXNzR3JvdXBPd25lclB1YmxpY0tleUJhc2U1OENoZWNrLFxuICAgIGJ1aWxkUmVtb3ZlQWNjZXNzR3JvdXBNZW1iZXJNZXRhZGF0YShwYXJhbXMpLFxuICAgIHtcbiAgICAgIEV4dHJhRGF0YTogcGFyYW1zLkV4dHJhRGF0YSxcbiAgICAgIE1pbkZlZVJhdGVOYW5vc1BlcktCOiBwYXJhbXMuTWluRmVlUmF0ZU5hbm9zUGVyS0IsXG4gICAgICBUcmFuc2FjdGlvbkZlZXM6IHBhcmFtcy5UcmFuc2FjdGlvbkZlZXMsXG4gICAgfVxuICApO1xufTtcblxuLyoqXG4gKiBodHRwczovL2RvY3MuZGVzby5vcmcvZGVzby1iYWNrZW5kL2NvbnN0cnVjdC10cmFuc2FjdGlvbnMvYWNjZXNzLWdyb3Vwcy1hcGkjdXBkYXRlLWFjY2Vzcy1ncm91cC1tZW1iZXJzXG4gKi9cbmV4cG9ydCBjb25zdCB1cGRhdGVBY2Nlc3NHcm91cE1lbWJlcnMgPSBhc3luYyAoXG4gIHBhcmFtczogVHhSZXF1ZXN0V2l0aE9wdGlvbmFsRmVlc0FuZEV4dHJhRGF0YTxBZGRBY2Nlc3NHcm91cE1lbWJlcnNSZXF1ZXN0PixcbiAgb3B0aW9ucz86IFR4UmVxdWVzdE9wdGlvbnNcbik6IFByb21pc2U8Q29uc3RydWN0ZWRBbmRTdWJtaXR0ZWRUeDxBZGRBY2Nlc3NHcm91cE1lbWJlcnNSZXNwb25zZT4+ID0+IHtcbiAgY29uc3QgdHhXaXRoRmVlID0gZ2V0VHhXaXRoRmVlTmFub3MoXG4gICAgcGFyYW1zLkFjY2Vzc0dyb3VwT3duZXJQdWJsaWNLZXlCYXNlNThDaGVjayxcbiAgICBidWlsZFVwZGF0ZUFjY2Vzc0dyb3VwTWVtYmVyc01ldGFkYXRhKHBhcmFtcyksXG4gICAge1xuICAgICAgRXh0cmFEYXRhOiBwYXJhbXMuRXh0cmFEYXRhLFxuICAgICAgTWluRmVlUmF0ZU5hbm9zUGVyS0I6IHBhcmFtcy5NaW5GZWVSYXRlTmFub3NQZXJLQixcbiAgICAgIFRyYW5zYWN0aW9uRmVlczogcGFyYW1zLlRyYW5zYWN0aW9uRmVlcyxcbiAgICB9XG4gICk7XG5cbiAgaWYgKG9wdGlvbnM/LmNoZWNrUGVybWlzc2lvbnMgIT09IGZhbHNlKSB7XG4gICAgYXdhaXQgZ3VhcmRUeFBlcm1pc3Npb24oe1xuICAgICAgR2xvYmFsREVTT0xpbWl0OlxuICAgICAgICB0eFdpdGhGZWUuZmVlTmFub3MgKyBzdW1UcmFuc2FjdGlvbkZlZXMocGFyYW1zLlRyYW5zYWN0aW9uRmVlcyksXG4gICAgICAvLyBOT1RFOiBUaGlzIGlzIG1vcmUgcGVybWlzc2l2ZSB0aGFuIHdlIGFjdHVhbGx5IG5lZWQgaXQgdG8gYmUsIGJ1dCBJXG4gICAgICAvLyBjb3VsZG4ndCBnZXQgaXQgdG8gd29yayB3aGVuIHNwZWNpZnlpbmcgdGhlIEFjY2Vzc0dyb3VwS2V5TmFtZSBhbmRcbiAgICAgIC8vIEFjY2Vzc0dyb3VwT3duZXJQdWJsaWNLZXlCYXNlNThDaGVjay4gSWYgYW55b25lIGNvbXBsYWlucywgd2UgY2FuXG4gICAgICAvLyByZXZpc2l0IGl0LCBidXQgdGhpcyBpcyBub3QgYSB0ZXJyaWJseSBzZW5zaXRpdmUgcGVybWlzc2lvbiB0byBncmFudC5cbiAgICAgIEFjY2Vzc0dyb3VwTGltaXRNYXA6IFtcbiAgICAgICAge1xuICAgICAgICAgIEFjY2Vzc0dyb3VwT3duZXJQdWJsaWNLZXlCYXNlNThDaGVjazogJycsXG4gICAgICAgICAgU2NvcGVUeXBlOiAnQW55JyxcbiAgICAgICAgICBBY2Nlc3NHcm91cEtleU5hbWU6ICcnLFxuICAgICAgICAgIE9wZXJhdGlvblR5cGU6ICdBbnknLFxuICAgICAgICAgIE9wQ291bnQ6IG9wdGlvbnM/LnR4TGltaXRDb3VudCA/PyAxLFxuICAgICAgICB9LFxuICAgICAgXSxcbiAgICAgIEFjY2Vzc0dyb3VwTWVtYmVyTGltaXRNYXA6IFtcbiAgICAgICAge1xuICAgICAgICAgIEFjY2Vzc0dyb3VwT3duZXJQdWJsaWNLZXlCYXNlNThDaGVjazogJycsXG4gICAgICAgICAgU2NvcGVUeXBlOiAnQW55JyxcbiAgICAgICAgICBBY2Nlc3NHcm91cEtleU5hbWU6ICcnLFxuICAgICAgICAgIE9wZXJhdGlvblR5cGU6ICdBbnknLFxuICAgICAgICAgIE9wQ291bnQ6IG9wdGlvbnM/LnR4TGltaXRDb3VudCA/PyAxLFxuICAgICAgICB9LFxuICAgICAgXSxcbiAgICB9KTtcbiAgfVxuXG4gIHJldHVybiBoYW5kbGVTaWduQW5kU3VibWl0KCdhcGkvdjAvdXBkYXRlLWFjY2Vzcy1ncm91cC1tZW1iZXJzJywgcGFyYW1zLCB7XG4gICAgLi4ub3B0aW9ucyxcbiAgICBjb25zdHJ1Y3Rpb25GdW5jdGlvbjogY29uc3RydWN0VXBkYXRlQWNjZXNzR3JvdXBNZW1iZXJzVHJhbnNhY3Rpb24sXG4gIH0pO1xufTtcblxuY29uc3QgYnVpbGRVcGRhdGVBY2Nlc3NHcm91cE1lbWJlcnNNZXRhZGF0YSA9IChcbiAgcGFyYW1zOiBUeFJlcXVlc3RXaXRoT3B0aW9uYWxGZWVzQW5kRXh0cmFEYXRhPEFkZEFjY2Vzc0dyb3VwTWVtYmVyc1JlcXVlc3Q+XG4pID0+IHtcbiAgY29uc3QgbWV0YWRhdGEgPSBuZXcgVHJhbnNhY3Rpb25NZXRhZGF0YUFjY2Vzc0dyb3VwTWVtYmVycygpO1xuICBtZXRhZGF0YS5hY2Nlc3NHcm91cE93bmVyUHVibGljS2V5ID0gYnM1OFB1YmxpY0tleVRvQ29tcHJlc3NlZEJ5dGVzKFxuICAgIHBhcmFtcy5BY2Nlc3NHcm91cE93bmVyUHVibGljS2V5QmFzZTU4Q2hlY2tcbiAgKTtcbiAgbWV0YWRhdGEuYWNjZXNzR3JvdXBNZW1iZXJPcGVyYXRpb25UeXBlID0gNDtcbiAgbWV0YWRhdGEuYWNjZXNzR3JvdXBLZXlOYW1lID0gZW5jb2RlVVRGOFRvQnl0ZXMocGFyYW1zLkFjY2Vzc0dyb3VwS2V5TmFtZSk7XG4gIG1ldGFkYXRhLmFjY2Vzc0dyb3VwTWVtYmVyc0xpc3QgPSBwYXJhbXMuQWNjZXNzR3JvdXBNZW1iZXJMaXN0Lm1hcChcbiAgICAobWVtYmVyKSA9PiB7XG4gICAgICBjb25zdCBuZXdBY2Nlc3NHcm91cE1lbWJlciA9IG5ldyBBY2Nlc3NHcm91cE1lbWJlclJlY29yZCgpO1xuICAgICAgbmV3QWNjZXNzR3JvdXBNZW1iZXIuYWNjZXNzR3JvdXBNZW1iZXJQdWJsaWNLZXkgPVxuICAgICAgICBiczU4UHVibGljS2V5VG9Db21wcmVzc2VkQnl0ZXMoXG4gICAgICAgICAgbWVtYmVyLkFjY2Vzc0dyb3VwTWVtYmVyUHVibGljS2V5QmFzZTU4Q2hlY2tcbiAgICAgICAgKTtcbiAgICAgIG5ld0FjY2Vzc0dyb3VwTWVtYmVyLmFjY2Vzc0dyb3VwTWVtYmVyS2V5TmFtZSA9IGVuY29kZVVURjhUb0J5dGVzKFxuICAgICAgICBtZW1iZXIuQWNjZXNzR3JvdXBNZW1iZXJLZXlOYW1lXG4gICAgICApO1xuICAgICAgbmV3QWNjZXNzR3JvdXBNZW1iZXIuZW5jcnlwdGVkS2V5ID0gZW5jb2RlVVRGOFRvQnl0ZXMoXG4gICAgICAgIG1lbWJlci5FbmNyeXB0ZWRLZXlcbiAgICAgICk7XG4gICAgICBuZXdBY2Nlc3NHcm91cE1lbWJlci5leHRyYURhdGEgPSBjb252ZXJ0RXh0cmFEYXRhKG1lbWJlci5FeHRyYURhdGEpO1xuICAgICAgcmV0dXJuIG5ld0FjY2Vzc0dyb3VwTWVtYmVyO1xuICAgIH1cbiAgKTtcbiAgcmV0dXJuIG1ldGFkYXRhO1xufTtcblxuZXhwb3J0IGNvbnN0IGNvbnN0cnVjdFVwZGF0ZUFjY2Vzc0dyb3VwTWVtYmVyc1RyYW5zYWN0aW9uID0gKFxuICBwYXJhbXM6IFR4UmVxdWVzdFdpdGhPcHRpb25hbEZlZXNBbmRFeHRyYURhdGE8QWRkQWNjZXNzR3JvdXBNZW1iZXJzUmVxdWVzdD5cbik6IFByb21pc2U8Q29uc3RydWN0ZWRUcmFuc2FjdGlvblJlc3BvbnNlPiA9PiB7XG4gIHJldHVybiBjb25zdHJ1Y3RCYWxhbmNlTW9kZWxUeChcbiAgICBwYXJhbXMuQWNjZXNzR3JvdXBPd25lclB1YmxpY0tleUJhc2U1OENoZWNrLFxuICAgIGJ1aWxkVXBkYXRlQWNjZXNzR3JvdXBNZW1iZXJzTWV0YWRhdGEocGFyYW1zKSxcbiAgICB7XG4gICAgICBFeHRyYURhdGE6IHBhcmFtcy5FeHRyYURhdGEsXG4gICAgICBNaW5GZWVSYXRlTmFub3NQZXJLQjogcGFyYW1zLk1pbkZlZVJhdGVOYW5vc1BlcktCLFxuICAgICAgVHJhbnNhY3Rpb25GZWVzOiBwYXJhbXMuVHJhbnNhY3Rpb25GZWVzLFxuICAgIH1cbiAgKTtcbn07XG4iXX0=