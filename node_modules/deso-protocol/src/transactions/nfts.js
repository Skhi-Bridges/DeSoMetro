import { hexToBytes } from '@noble/hashes/utils';
import { TransactionExtraDataKV, TransactionMetadataAcceptNFTBid, TransactionMetadataAcceptNFTTransfer, TransactionMetadataBurnNFT, TransactionMetadataCreateNFT, TransactionMetadataNFTBid, TransactionMetadataNFTTransfer, TransactionMetadataUpdateNFT, bs58PublicKeyToCompressedBytes, concatUint8Arrays, encodeUTF8ToBytes, uvarint64ToBuf, } from '../identity/index.js';
import { constructBalanceModelTx, getTxWithFeeNanos, handleSignAndSubmit, sumTransactionFees, } from '../internal.js';
import { guardTxPermission } from './utils.js';
export const createNFT = async (params, options) => {
    const txWithFee = getTxWithFeeNanos(params.UpdaterPublicKeyBase58Check, buildCreateNFTMetadata(params), {
        ExtraData: params.ExtraData,
        MinFeeRateNanosPerKB: params.MinFeeRateNanosPerKB,
        TransactionFees: params.TransactionFees,
        ConsensusExtraDataKVs: buildCreateNFTConsensusKVs(params),
    });
    if (options?.checkPermissions !== false) {
        await guardTxPermission({
            GlobalDESOLimit: txWithFee.feeNanos + sumTransactionFees(params.TransactionFees),
            TransactionCountLimitMap: {
                CREATE_NFT: options?.txLimitCount ?? 1,
            },
        });
    }
    return handleSignAndSubmit('api/v0/create-nft', params, {
        ...options,
        constructionFunction: constructCreateNFTTransaction,
    });
};
const buildCreateNFTMetadata = (params) => {
    const metadata = new TransactionMetadataCreateNFT();
    metadata.hasUnlockable = params.HasUnlockable;
    metadata.isForSale = params.IsForSale;
    metadata.minBidAmountNanos = params.MinBidAmountNanos || 0;
    metadata.nftPostHash = hexToBytes(params.NFTPostHashHex);
    metadata.nftRoyaltyToCoinBasisPoints = params.NFTRoyaltyToCoinBasisPoints;
    metadata.nftRoyaltyToCreatorBasisPoints =
        params.NFTRoyaltyToCreatorBasisPoints;
    metadata.numCopies = params.NumCopies;
    return metadata;
};
const buildCreateNFTConsensusKVs = (params) => {
    const consensusExtraDataKVs = [];
    if (params.IsBuyNow && params.BuyNowPriceNanos !== undefined) {
        consensusExtraDataKVs.push(new TransactionExtraDataKV(encodeUTF8ToBytes('BuyNowPriceNanos'), uvarint64ToBuf(params.BuyNowPriceNanos)));
    }
    if (params.AdditionalDESORoyaltiesMap &&
        Object.keys(params.AdditionalDESORoyaltiesMap).length) {
        const royaltyMap = params.AdditionalDESORoyaltiesMap;
        let buf = uvarint64ToBuf(Object.keys(royaltyMap).length);
        Object.keys(royaltyMap)
            .sort((a, b) => a.localeCompare(b))
            .forEach((publicKey) => {
            buf = concatUint8Arrays([
                buf,
                bs58PublicKeyToCompressedBytes(publicKey),
                uvarint64ToBuf(royaltyMap[publicKey]),
            ]);
        });
        consensusExtraDataKVs.push(new TransactionExtraDataKV(encodeUTF8ToBytes('DESORoyaltiesMap'), buf));
    }
    if (params.AdditionalCoinRoyaltiesMap &&
        Object.keys(params.AdditionalCoinRoyaltiesMap).length) {
        const royaltyMap = params.AdditionalCoinRoyaltiesMap;
        let buf = uvarint64ToBuf(Object.keys(royaltyMap).length);
        Object.keys(royaltyMap)
            .sort((a, b) => a.localeCompare(b))
            .forEach((publicKey) => {
            buf = concatUint8Arrays([
                buf,
                bs58PublicKeyToCompressedBytes(publicKey),
                uvarint64ToBuf(royaltyMap[publicKey]),
            ]);
        });
        consensusExtraDataKVs.push(new TransactionExtraDataKV(encodeUTF8ToBytes('CoinRoyaltiesMap'), buf));
    }
    return consensusExtraDataKVs;
};
export const constructCreateNFTTransaction = (params) => {
    return constructBalanceModelTx(params.UpdaterPublicKeyBase58Check, buildCreateNFTMetadata(params), {
        ExtraData: params.ExtraData,
        ConsensusExtraDataKVs: buildCreateNFTConsensusKVs(params),
        MinFeeRateNanosPerKB: params.MinFeeRateNanosPerKB,
        TransactionFees: params.TransactionFees,
    });
};
export const updateNFT = async (params, options) => {
    const txWithFee = getTxWithFeeNanos(params.UpdaterPublicKeyBase58Check, buildUpdateNFTMetadata(params), {
        ExtraData: params.ExtraData,
        MinFeeRateNanosPerKB: params.MinFeeRateNanosPerKB,
        TransactionFees: params.TransactionFees,
        ConsensusExtraDataKVs: buildUpdateNFTConsensusKVs(params),
    });
    if (options?.checkPermissions !== false) {
        await guardTxPermission({
            GlobalDESOLimit: txWithFee.feeNanos + sumTransactionFees(params.TransactionFees),
            TransactionCountLimitMap: {
                UPDATE_NFT: options?.txLimitCount ?? 1,
            },
        });
    }
    return handleSignAndSubmit('api/v0/update-nft', params, {
        ...options,
        constructionFunction: constructUpdateNFTTransaction,
    });
};
const buildUpdateNFTMetadata = (params) => {
    const metadata = new TransactionMetadataUpdateNFT();
    metadata.isForSale = !!params.IsForSale;
    metadata.minBidAmountNanos = params.MinBidAmountNanos;
    metadata.nftPostHash = hexToBytes(params.NFTPostHashHex);
    metadata.serialNumber = params.SerialNumber;
    return metadata;
};
const buildUpdateNFTConsensusKVs = (params) => {
    const consensusExtraDataKVs = [];
    if (params.IsBuyNow && params.BuyNowPriceNanos !== undefined) {
        consensusExtraDataKVs.push(new TransactionExtraDataKV(encodeUTF8ToBytes('BuyNowPriceNanos'), uvarint64ToBuf(params.BuyNowPriceNanos)));
    }
    return consensusExtraDataKVs;
};
export const constructUpdateNFTTransaction = (params) => {
    return constructBalanceModelTx(params.UpdaterPublicKeyBase58Check, buildUpdateNFTMetadata(params), {
        ExtraData: params.ExtraData,
        MinFeeRateNanosPerKB: params.MinFeeRateNanosPerKB,
        TransactionFees: params.TransactionFees,
        ConsensusExtraDataKVs: buildUpdateNFTConsensusKVs(params),
    });
};
export const createNFTBid = async (params, options) => {
    const txWithFee = getTxWithFeeNanos(params.UpdaterPublicKeyBase58Check, buildCreateNFTBidMetadata(params), {
        ExtraData: params.ExtraData,
        MinFeeRateNanosPerKB: params.MinFeeRateNanosPerKB,
        TransactionFees: params.TransactionFees,
    });
    if (options?.checkPermissions !== false) {
        await guardTxPermission({
            GlobalDESOLimit: params.BidAmountNanos +
                txWithFee.feeNanos +
                sumTransactionFees(params.TransactionFees),
            NFTOperationLimitMap: {
                [params.NFTPostHashHex]: {
                    [params.SerialNumber]: {
                        nft_bid: options?.txLimitCount ?? 1,
                    },
                },
            },
        });
    }
    return handleSignAndSubmit('api/v0/create-nft-bid', params, {
        ...options,
        constructionFunction: constructNFTBidTransaction,
    });
};
const buildCreateNFTBidMetadata = (params) => {
    const metadata = new TransactionMetadataNFTBid();
    metadata.bidAmountNanos = params.BidAmountNanos;
    metadata.nftPostHash = hexToBytes(params.NFTPostHashHex);
    metadata.serialNumber = params.SerialNumber;
    return metadata;
};
export const constructNFTBidTransaction = (params) => {
    return constructBalanceModelTx(params.UpdaterPublicKeyBase58Check, buildCreateNFTBidMetadata(params), {
        MinFeeRateNanosPerKB: params.MinFeeRateNanosPerKB,
        ExtraData: params.ExtraData,
        TransactionFees: params.TransactionFees,
    });
};
export const acceptNFTBid = async (params, options) => {
    const txWithFee = getTxWithFeeNanos(params.UpdaterPublicKeyBase58Check, buildAcceptNFTBidMetadata(params), {
        ExtraData: params.ExtraData,
        MinFeeRateNanosPerKB: params.MinFeeRateNanosPerKB,
        TransactionFees: params.TransactionFees,
    });
    if (options?.checkPermissions !== false) {
        await guardTxPermission({
            GlobalDESOLimit: params.BidAmountNanos +
                txWithFee.feeNanos +
                sumTransactionFees(params.TransactionFees),
            NFTOperationLimitMap: {
                [params.NFTPostHashHex]: {
                    [params.SerialNumber]: {
                        accept_nft_bid: options?.txLimitCount ?? 1,
                    },
                },
            },
        });
    }
    return handleSignAndSubmit('api/v0/accept-nft-bid', params, {
        ...options,
        constructionFunction: constructAcceptNFTBidTransaction,
    });
};
const buildAcceptNFTBidMetadata = (params) => {
    const metadata = new TransactionMetadataAcceptNFTBid();
    metadata.bidAmountNanos = params.BidAmountNanos;
    metadata.bidderInputs = [];
    // TODO: this won't work if they've had their identity swapped.
    metadata.bidderPKID = bs58PublicKeyToCompressedBytes(params.BidderPublicKeyBase58Check);
    metadata.encryptedUnlockableText = hexToBytes(params.EncryptedUnlockableText || '');
    metadata.nftPostHash = hexToBytes(params.NFTPostHashHex);
    metadata.serialNumber = params.SerialNumber;
    return metadata;
};
export const constructAcceptNFTBidTransaction = (params) => {
    return constructBalanceModelTx(params.UpdaterPublicKeyBase58Check, buildAcceptNFTBidMetadata(params), {
        MinFeeRateNanosPerKB: params.MinFeeRateNanosPerKB,
        ExtraData: params.ExtraData,
        TransactionFees: params.TransactionFees,
    });
};
export const transferNFT = async (params, options) => {
    const txWithFee = getTxWithFeeNanos(params.SenderPublicKeyBase58Check, buildTransferNFTMetadata(params), {
        ExtraData: params.ExtraData,
        MinFeeRateNanosPerKB: params.MinFeeRateNanosPerKB,
        TransactionFees: params.TransactionFees,
    });
    if (options?.checkPermissions !== false) {
        await guardTxPermission({
            GlobalDESOLimit: txWithFee.feeNanos + sumTransactionFees(params.TransactionFees),
            NFTOperationLimitMap: {
                [params.NFTPostHashHex]: {
                    [params.SerialNumber]: {
                        transfer: options?.txLimitCount ?? 1,
                    },
                },
            },
        });
    }
    return handleSignAndSubmit('api/v0/transfer-nft', params, {
        ...options,
        constructionFunction: constructTransferNFT,
    });
};
const buildTransferNFTMetadata = (params) => {
    const metadata = new TransactionMetadataNFTTransfer();
    metadata.encryptedUnlockableText = hexToBytes(params.EncryptedUnlockableText || '');
    metadata.nftPostHash = hexToBytes(params.NFTPostHashHex);
    metadata.receiverPublicKey = bs58PublicKeyToCompressedBytes(params.ReceiverPublicKeyBase58Check);
    metadata.serialNumber = params.SerialNumber;
    return metadata;
};
export const constructTransferNFT = (params) => {
    return constructBalanceModelTx(params.SenderPublicKeyBase58Check, buildTransferNFTMetadata(params), {
        MinFeeRateNanosPerKB: params.MinFeeRateNanosPerKB,
        ExtraData: params.ExtraData,
        TransactionFees: params.TransactionFees,
    });
};
export const acceptNFTTransfer = async (params, options) => {
    const txWithFee = getTxWithFeeNanos(params.UpdaterPublicKeyBase58Check, buildAcceptNFTTransferMetadata(params), {
        ExtraData: params.ExtraData,
        MinFeeRateNanosPerKB: params.MinFeeRateNanosPerKB,
        TransactionFees: params.TransactionFees,
    });
    if (options?.checkPermissions !== false) {
        await guardTxPermission({
            GlobalDESOLimit: txWithFee.feeNanos + sumTransactionFees(params.TransactionFees),
            NFTOperationLimitMap: {
                [params.NFTPostHashHex]: {
                    [params.SerialNumber]: {
                        accept_nft_transfer: options?.txLimitCount ?? 1,
                    },
                },
            },
        });
    }
    return handleSignAndSubmit('api/v0/accept-nft-transfer', params, {
        ...options,
        constructionFunction: constructAcceptNFTTransfer,
    });
};
export const buildAcceptNFTTransferMetadata = (params) => {
    const metadata = new TransactionMetadataAcceptNFTTransfer();
    metadata.nftPostHash = hexToBytes(params.NFTPostHashHex);
    metadata.serialNumber = params.SerialNumber;
    return metadata;
};
export const constructAcceptNFTTransfer = (params) => {
    return constructBalanceModelTx(params.UpdaterPublicKeyBase58Check, buildAcceptNFTTransferMetadata(params), {
        ExtraData: params.ExtraData,
        MinFeeRateNanosPerKB: params.MinFeeRateNanosPerKB,
        TransactionFees: params.TransactionFees,
    });
};
export const burnNFT = async (params, options) => {
    const txWithFee = getTxWithFeeNanos(params.UpdaterPublicKeyBase58Check, buildBurnNFTMetadata(params), {
        ExtraData: params.ExtraData,
        MinFeeRateNanosPerKB: params.MinFeeRateNanosPerKB,
        TransactionFees: params.TransactionFees,
    });
    if (options?.checkPermissions !== false) {
        await guardTxPermission({
            GlobalDESOLimit: txWithFee.feeNanos + sumTransactionFees(params.TransactionFees),
            NFTOperationLimitMap: {
                [params.NFTPostHashHex]: {
                    [params.SerialNumber]: {
                        burn: options?.txLimitCount ?? 1,
                    },
                },
            },
        });
    }
    return handleSignAndSubmit('api/v0/burn-nft', params, {
        ...options,
        constructionFunction: constructBurnNFTTransation,
    });
};
const buildBurnNFTMetadata = (params) => {
    const metadata = new TransactionMetadataBurnNFT();
    metadata.nftPostHash = hexToBytes(params.NFTPostHashHex);
    metadata.serialNumber = params.SerialNumber;
    return metadata;
};
export const constructBurnNFTTransation = (params) => {
    return constructBalanceModelTx(params.UpdaterPublicKeyBase58Check, buildBurnNFTMetadata(params), {
        ExtraData: params.ExtraData,
        MinFeeRateNanosPerKB: params.MinFeeRateNanosPerKB,
        TransactionFees: params.TransactionFees,
    });
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibmZ0cy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy90cmFuc2FjdGlvbnMvbmZ0cy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0scUJBQXFCLENBQUM7QUFvQmpELE9BQU8sRUFDTCxzQkFBc0IsRUFDdEIsK0JBQStCLEVBQy9CLG9DQUFvQyxFQUNwQywwQkFBMEIsRUFDMUIsNEJBQTRCLEVBQzVCLHlCQUF5QixFQUN6Qiw4QkFBOEIsRUFDOUIsNEJBQTRCLEVBQzVCLDhCQUE4QixFQUM5QixpQkFBaUIsRUFDakIsaUJBQWlCLEVBQ2pCLGNBQWMsR0FDZixNQUFNLHNCQUFzQixDQUFDO0FBQzlCLE9BQU8sRUFDTCx1QkFBdUIsRUFDdkIsaUJBQWlCLEVBQ2pCLG1CQUFtQixFQUNuQixrQkFBa0IsR0FDbkIsTUFBTSxnQkFBZ0IsQ0FBQztBQUV4QixPQUFPLEVBQUUsaUJBQWlCLEVBQUUsTUFBTSxZQUFZLENBQUM7QUFpQi9DLE1BQU0sQ0FBQyxNQUFNLFNBQVMsR0FBRyxLQUFLLEVBQzVCLE1BQThCLEVBQzlCLE9BQTBCLEVBRzFCLEVBQUU7SUFDRixNQUFNLFNBQVMsR0FBRyxpQkFBaUIsQ0FDakMsTUFBTSxDQUFDLDJCQUEyQixFQUNsQyxzQkFBc0IsQ0FBQyxNQUFNLENBQUMsRUFDOUI7UUFDRSxTQUFTLEVBQUUsTUFBTSxDQUFDLFNBQVM7UUFDM0Isb0JBQW9CLEVBQUUsTUFBTSxDQUFDLG9CQUFvQjtRQUNqRCxlQUFlLEVBQUUsTUFBTSxDQUFDLGVBQWU7UUFDdkMscUJBQXFCLEVBQUUsMEJBQTBCLENBQUMsTUFBTSxDQUFDO0tBQzFELENBQ0YsQ0FBQztJQUVGLElBQUksT0FBTyxFQUFFLGdCQUFnQixLQUFLLEtBQUssRUFBRTtRQUN2QyxNQUFNLGlCQUFpQixDQUFDO1lBQ3RCLGVBQWUsRUFDYixTQUFTLENBQUMsUUFBUSxHQUFHLGtCQUFrQixDQUFDLE1BQU0s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QUUsTUFBTSxFQUFFO1FBQ3BELEdBQUcsT0FBTztRQUNWLG9CQUFvQixFQUFFLDBCQUEwQjtLQUNqRCxDQUFDLENBQUM7QUFDTCxDQUFDLENBQUM7QUFFRixNQUFNLG9CQUFvQixHQUFHLENBQUMsTUFBNEIsRUFBRSxFQUFFO0lBQzVELE1BQU0sUUFBUSxHQUFHLElBQUksMEJBQTBCLEVBQUUsQ0FBQztJQUNsRCxRQUFRLENBQUMsV0FBVyxHQUFHLFVBQVUsQ0FBQyxNQUFNLENBQUMsY0FBYyxDQUFDLENBQUM7SUFDekQsUUFBUSxDQUFDLFlBQVksR0FBRyxNQUFNLENBQUMsWUFBWSxDQUFDO0lBRTVDLE9BQU8sUUFBUSxDQUFDO0FBQ2xCLENBQUMsQ0FBQztBQUVGLE1BQU0sQ0FBQyxNQUFNLDBCQUEwQixHQUFHLENBQ3hDLE1BQTRCLEVBQ2EsRUFBRTtJQUMzQyxPQUFPLHVCQUF1QixDQUM1QixNQUFNLENBQUMsMkJBQTJCLEVBQ2xDLG9CQUFvQixDQUFDLE1BQU0sQ0FBQyxFQUM1QjtRQUNFLFNBQVMsRUFBRSxNQUFNLENBQUMsU0FBUztRQUMzQixvQkFBb0IsRUFBRSxNQUFNLENBQUMsb0JBQW9CO1FBQ2pELGVBQWUsRUFBRSxNQUFNLENBQUMsZUFBZTtLQUN4QyxDQUNGLENBQUM7QUFDSixDQUFDLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBoZXhUb0J5dGVzIH0gZnJvbSAnQG5vYmxlL2hhc2hlcy91dGlscyc7XG5pbXBvcnQge1xuICBBY2NlcHRORlRCaWRSZXF1ZXN0LFxuICBBY2NlcHRORlRCaWRSZXNwb25zZSxcbiAgQWNjZXB0TkZUVHJhbnNmZXJSZXF1ZXN0LFxuICBBY2NlcHRORlRUcmFuc2ZlclJlc3BvbnNlLFxuICBCdXJuTkZUUmVxdWVzdCxcbiAgQnVybk5GVFJlc3BvbnNlLFxuICBDb25zdHJ1Y3RlZFRyYW5zYWN0aW9uUmVzcG9uc2UsXG4gIENyZWF0ZU5GVEJpZFJlcXVlc3QsXG4gIENyZWF0ZU5GVEJpZFJlc3BvbnNlLFxuICBDcmVhdGVORlRSZXF1ZXN0LFxuICBDcmVhdGVORlRSZXNwb25zZSxcbiAgVHJhbnNmZXJORlRSZXF1ZXN0LFxuICBUcmFuc2Zlck5GVFJlc3BvbnNlLFxuICBUeFJlcXVlc3RXaXRoT3B0aW9uYWxGZWVzQW5kRXh0cmFEYXRhLFxuICBVcGRhdGVORlRSZXF1ZXN0LFxuICBVcGRhdGVORlRSZXNwb25zZSxcbn0gZnJvbSAnLi4vYmFja2VuZC10eXBlcy9pbmRleC5qcyc7XG5pbXBvcnQgeyBQYXJ0aWFsV2l0aFJlcXVpcmVkRmllbGRzIH0gZnJvbSAnLi4vZGF0YS9pbmRleC5qcyc7XG5pbXBvcnQge1xuICBUcmFuc2FjdGlvbkV4dHJhRGF0YUtWLFxuICBUcmFuc2FjdGlvbk1ldGFkYXRhQWNjZXB0TkZUQmlkLFxuICBUcmFuc2FjdGlvbk1ldGFkYXRhQWNjZXB0TkZUVHJhbnNmZXIsXG4gIFRyYW5zYWN0aW9uTWV0YWRhdGFCdXJuTkZULFxuICBUcmFuc2FjdGlvbk1ldGFkYXRhQ3JlYXRlTkZULFxuICBUcmFuc2FjdGlvbk1ldGFkYXRhTkZUQmlkLFxuICBUcmFuc2FjdGlvbk1ldGFkYXRhTkZUVHJhbnNmZXIsXG4gIFRyYW5zYWN0aW9uTWV0YWRhdGFVcGRhdGVORlQsXG4gIGJzNThQdWJsaWNLZXlUb0NvbXByZXNzZWRCeXRlcyxcbiAgY29uY2F0VWludDhBcnJheXMsXG4gIGVuY29kZVVURjhUb0J5dGVzLFxuICB1dmFyaW50NjRUb0J1Zixcbn0gZnJvbSAnLi4vaWRlbnRpdHkvaW5kZXguanMnO1xuaW1wb3J0IHtcbiAgY29uc3RydWN0QmFsYW5jZU1vZGVsVHgsXG4gIGdldFR4V2l0aEZlZU5hbm9zLFxuICBoYW5kbGVTaWduQW5kU3VibWl0LFxuICBzdW1UcmFuc2FjdGlvbkZlZXMsXG59IGZyb20gJy4uL2ludGVybmFsLmpzJztcbmltcG9ydCB7IENvbnN0cnVjdGVkQW5kU3VibWl0dGVkVHgsIFR4UmVxdWVzdE9wdGlvbnMgfSBmcm9tICcuLi90eXBlcy5qcyc7XG5pbXBvcnQgeyBndWFyZFR4UGVybWlzc2lvbiB9IGZyb20gJy4vdXRpbHMuanMnO1xuLyoqXG4gKiBodHRwczovL2RvY3MuZGVzby5vcmcvZGVzby1iYWNrZW5kL2NvbnN0cnVjdC10cmFuc2FjdGlvbnMvbmZ0LXRyYW5zYWN0aW9ucy1hcGkjY3JlYXRlLW5mdFxuICovXG5leHBvcnQgdHlwZSBDcmVhdGVORlRSZXF1ZXN0UGFyYW1zID0gVHhSZXF1ZXN0V2l0aE9wdGlvbmFsRmVlc0FuZEV4dHJhRGF0YTxcbiAgUGFydGlhbFdpdGhSZXF1aXJlZEZpZWxkczxcbiAgICBDcmVhdGVORlRSZXF1ZXN0LFxuICAgIHwgJ1VwZGF0ZXJQdWJsaWNLZXlCYXNlNThDaGVjaydcbiAgICB8ICdORlRQb3N0SGFzaEhleCdcbiAgICB8ICdOdW1Db3BpZXMnXG4gICAgfCAnTkZUUm95YWx0eVRvQ29pbkJhc2lzUG9pbnRzJ1xuICAgIHwgJ05GVFJveWFsdHlUb0NyZWF0b3JCYXNpc1BvaW50cydcbiAgICB8ICdIYXNVbmxvY2thYmxlJ1xuICAgIHwgJ0lzRm9yU2FsZSdcbiAgPlxuPjtcblxuZXhwb3J0IGNvbnN0IGNyZWF0ZU5GVCA9IGFzeW5jIChcbiAgcGFyYW1zOiBDcmVhdGVORlRSZXF1ZXN0UGFyYW1zLFxuICBvcHRpb25zPzogVHhSZXF1ZXN0T3B0aW9uc1xuKTogUHJvbWlzZTxcbiAgQ29uc3RydWN0ZWRBbmRTdWJtaXR0ZWRUeDxDcmVhdGVORlRSZXNwb25zZSB8IENvbnN0cnVjdGVkVHJhbnNhY3Rpb25SZXNwb25zZT5cbj4gPT4ge1xuICBjb25zdCB0eFdpdGhGZWUgPSBnZXRUeFdpdGhGZWVOYW5vcyhcbiAgICBwYXJhbXMuVXBkYXRlclB1YmxpY0tleUJhc2U1OENoZWNrLFxuICAgIGJ1aWxkQ3JlYXRlTkZUTWV0YWRhdGEocGFyYW1zKSxcbiAgICB7XG4gICAgICBFeHRyYURhdGE6IHBhcmFtcy5FeHRyYURhdGEsXG4gICAgICBNaW5GZWVSYXRlTmFub3NQZXJLQjogcGFyYW1zLk1pbkZlZVJhdGVOYW5vc1BlcktCLFxuICAgICAgVHJhbnNhY3Rpb25GZWVzOiBwYXJhbXMuVHJhbnNhY3Rpb25GZWVzLFxuICAgICAgQ29uc2Vuc3VzRXh0cmFEYXRhS1ZzOiBidWlsZENyZWF0ZU5GVENvbnNlbnN1c0tWcyhwYXJhbXMpLFxuICAgIH1cbiAgKTtcblxuICBpZiAob3B0aW9ucz8uY2hlY2tQZXJtaXNzaW9ucyAhPT0gZmFsc2UpIHtcbiAgICBhd2FpdCBndWFyZFR4UGVybWlzc2lvbih7XG4gICAgICBHbG9iYWxERVNPTGltaXQ6XG4gICAgICAgIHR4V2l0aEZlZS5mZWVOYW5vcyArIHN1bVRyYW5zYWN0aW9uRmVlcyhwYXJhbXMuVHJhbnNhY3Rpb25GZWVzKSxcbiAgICAgIFRyYW5zYWN0aW9uQ291bnRMaW1pdE1hcDoge1xuICAgICAgICBDUkVBVEVfTkZUOiBvcHRpb25zPy50eExpbWl0Q291bnQgPz8gMSxcbiAgICAgIH0sXG4gICAgfSk7XG4gIH1cblxuICByZXR1cm4gaGFuZGxlU2lnbkFuZFN1Ym1pdCgnYXBpL3YwL2NyZWF0ZS1uZnQnLCBwYXJhbXMsIHtcbiAgICAuLi5vcHRpb25zLFxuICAgIGNvbnN0cnVjdGlvbkZ1bmN0aW9uOiBjb25zdHJ1Y3RDcmVhdGVORlRUcmFuc2FjdGlvbixcbiAgfSk7XG59O1xuXG5jb25zdCBidWlsZENyZWF0ZU5GVE1ldGFkYXRhID0gKHBhcmFtczogQ3JlYXRlTkZUUmVxdWVzdFBhcmFtcykgPT4ge1xuICBjb25zdCBtZXRhZGF0YSA9IG5ldyBUcmFuc2FjdGlvbk1ldGFkYXRhQ3JlYXRlTkZUKCk7XG4gIG1ldGFkYXRhLmhhc1VubG9ja2FibGUgPSBwYXJhbXMuSGFzVW5sb2NrYWJsZTtcbiAgbWV0YWRhdGEuaXNGb3JTYWxlID0gcGFyYW1zLklzRm9yU2FsZTtcbiAgbWV0YWRhdGEubWluQmlkQW1vdW50TmFub3MgPSBwYXJhbXMuTWluQmlkQW1vdW50TmFub3MgfHwgMDtcbiAgbWV0YWRhdGEubmZ0UG9zdEhhc2ggPSBoZXhUb0J5dGVzKHBhcmFtcy5ORlRQb3N0SGFzaEhleCk7XG4gIG1ldGFkYXRhLm5mdFJveWFsdHlUb0NvaW5CYXNpc1BvaW50cyA9IHBhcmFtcy5ORlRSb3lhbHR5VG9Db2luQmFzaXNQb2ludHM7XG4gIG1ldGFkYXRhLm5mdFJveWFsdHlUb0NyZWF0b3JCYXNpc1BvaW50cyA9XG4gICAgcGFyYW1zLk5GVFJveWFsdHlUb0NyZWF0b3JCYXNpc1BvaW50cztcbiAgbWV0YWRhdGEubnVtQ29waWVzID0gcGFyYW1zLk51bUNvcGllcztcblxuICByZXR1cm4gbWV0YWRhdGE7XG59O1xuXG5jb25zdCBidWlsZENyZWF0ZU5GVENvbnNlbnN1c0tWcyA9IChwYXJhbXM6IENyZWF0ZU5GVFJlcXVlc3RQYXJhbXMpID0+IHtcbiAgY29uc3QgY29uc2Vuc3VzRXh0cmFEYXRhS1ZzOiBUcmFuc2FjdGlvbkV4dHJhRGF0YUtWW10gPSBbXTtcbiAgaWYgKHBhcmFtcy5Jc0J1eU5vdyAmJiBwYXJhbXMuQnV5Tm93UHJpY2VOYW5vcyAhPT0gdW5kZWZpbmVkKSB7XG4gICAgY29uc2Vuc3VzRXh0cmFEYXRhS1ZzLnB1c2goXG4gICAgICBuZXcgVHJhbnNhY3Rpb25FeHRyYURhdGFLVihcbiAgICAgICAgZW5jb2RlVVRGOFRvQnl0ZXMoJ0J1eU5vd1ByaWNlTmFub3MnKSxcbiAgICAgICAgdXZhcmludDY0VG9CdWYocGFyYW1zLkJ1eU5vd1ByaWNlTmFub3MpXG4gICAgICApXG4gICAgKTtcbiAgfVxuICBpZiAoXG4gICAgcGFyYW1zLkFkZGl0aW9uYWxERVNPUm95YWx0aWVzTWFwICYmXG4gICAgT2JqZWN0LmtleXMocGFyYW1zLkFkZGl0aW9uYWxERVNPUm95YWx0aWVzTWFwKS5sZW5ndGhcbiAgKSB7XG4gICAgY29uc3Qgcm95YWx0eU1hcCA9IHBhcmFtcy5BZGRpdGlvbmFsREVTT1JveWFsdGllc01hcDtcbiAgICBsZXQgYnVmID0gdXZhcmludDY0VG9CdWYoT2JqZWN0LmtleXMocm95YWx0eU1hcCkubGVuZ3RoKTtcbiAgICBPYmplY3Qua2V5cyhyb3lhbHR5TWFwKVxuICAgICAgLnNvcnQoKGEsIGIpID0+IGEubG9jYWxlQ29tcGFyZShiKSlcbiAgICAgIC5mb3JFYWNoKChwdWJsaWNLZXkpID0+IHtcbiAgICAgICAgYnVmID0gY29uY2F0VWludDhBcnJheXMoW1xuICAgICAgICAgIGJ1ZixcbiAgICAgICAgICBiczU4UHVibGljS2V5VG9Db21wcmVzc2VkQnl0ZXMocHVibGljS2V5KSxcbiAgICAgICAgICB1dmFyaW50NjRUb0J1Zihyb3lhbHR5TWFwW3B1YmxpY0tleV0pLFxuICAgICAgICBdKTtcbiAgICAgIH0pO1xuICAgIGNvbnNlbnN1c0V4dHJhRGF0YUtWcy5wdXNoKFxuICAgICAgbmV3IFRyYW5zYWN0aW9uRXh0cmFEYXRhS1YoZW5jb2RlVVRGOFRvQnl0ZXMoJ0RFU09Sb3lhbHRpZXNNYXAnKSwgYnVmKVxuICAgICk7XG4gIH1cbiAgaWYgKFxuICAgIHBhcmFtcy5BZGRpdGlvbmFsQ29pblJveWFsdGllc01hcCAmJlxuICAgIE9iamVjdC5rZXlzKHBhcmFtcy5BZGRpdGlvbmFsQ29pblJveWFsdGllc01hcCkubGVuZ3RoXG4gICkge1xuICAgIGNvbnN0IHJveWFsdHlNYXAgPSBwYXJhbXMuQWRkaXRpb25hbENvaW5Sb3lhbHRpZXNNYXA7XG4gICAgbGV0IGJ1ZiA9IHV2YXJpbnQ2NFRvQnVmKE9iamVjdC5rZXlzKHJveWFsdHlNYXApLmxlbmd0aCk7XG4gICAgT2JqZWN0LmtleXMocm95YWx0eU1hcClcbiAgICAgIC5zb3J0KChhLCBiKSA9PiBhLmxvY2FsZUNvbXBhcmUoYikpXG4gICAgICAuZm9yRWFjaCgocHVibGljS2V5KSA9PiB7XG4gICAgICAgIGJ1ZiA9IGNvbmNhdFVpbnQ4QXJyYXlzKFtcbiAgICAgICAgICBidWYsXG4gICAgICAgICAgYnM1OFB1YmxpY0tleVRvQ29tcHJlc3NlZEJ5dGVzKHB1YmxpY0tleSksXG4gICAgICAgICAgdXZhcmludDY0VG9CdWYocm95YWx0eU1hcFtwdWJsaWNLZXldKSxcbiAgICAgICAgXSk7XG4gICAgICB9KTtcbiAgICBjb25zZW5zdXNFeHRyYURhdGFLVnMucHVzaChcbiAgICAgIG5ldyBUcmFuc2FjdGlvbkV4dHJhRGF0YUtWKGVuY29kZVVURjhUb0J5dGVzKCdDb2luUm95YWx0aWVzTWFwJyksIGJ1ZilcbiAgICApO1xuICB9XG5cbiAgcmV0dXJuIGNvbnNlbnN1c0V4dHJhRGF0YUtWcztcbn07XG5cbmV4cG9ydCBjb25zdCBjb25zdHJ1Y3RDcmVhdGVORlRUcmFuc2FjdGlvbiA9IChcbiAgcGFyYW1zOiBDcmVhdGVORlRSZXF1ZXN0UGFyYW1zXG4pOiBQcm9taXNlPENvbnN0cnVjdGVkVHJhbnNhY3Rpb25SZXNwb25zZT4gPT4ge1xuICByZXR1cm4gY29uc3RydWN0QmFsYW5jZU1vZGVsVHgoXG4gICAgcGFyYW1zLlVwZGF0ZXJQdWJsaWNLZXlCYXNlNThDaGVjayxcbiAgICBidWlsZENyZWF0ZU5GVE1ldGFkYXRhKHBhcmFtcyksXG4gICAge1xuICAgICAgRXh0cmFEYXRhOiBwYXJhbXMuRXh0cmFEYXRhLFxuICAgICAgQ29uc2Vuc3VzRXh0cmFEYXRhS1ZzOiBidWlsZENyZWF0ZU5GVENvbnNlbnN1c0tWcyhwYXJhbXMpLFxuICAgICAgTWluRmVlUmF0ZU5hbm9zUGVyS0I6IHBhcmFtcy5NaW5GZWVSYXRlTmFub3NQZXJLQixcbiAgICAgIFRyYW5zYWN0aW9uRmVlczogcGFyYW1zLlRyYW5zYWN0aW9uRmVlcyxcbiAgICB9XG4gICk7XG59O1xuXG4vKipcbiAqIGh0dHBzOi8vZG9jcy5kZXNvLm9yZy9kZXNvLWJhY2tlbmQvY29uc3RydWN0LXRyYW5zYWN0aW9ucy9uZnQtdHJhbnNhY3Rpb25zLWFwaSN1cGRhdGUtbmZ0XG4gKi9cbmV4cG9ydCB0eXBlIFVwZGF0ZU5GVFJlcXVlc3RQYXJhbXMgPSBUeFJlcXVlc3RXaXRoT3B0aW9uYWxGZWVzQW5kRXh0cmFEYXRhPFxuICBQYXJ0aWFsV2l0aFJlcXVpcmVkRmllbGRzPFxuICAgIFVwZGF0ZU5GVFJlcXVlc3QsXG4gICAgfCAnVXBkYXRlclB1YmxpY0tleUJhc2U1OENoZWNrJ1xuICAgIHwgJ05GVFBvc3RIYXNoSGV4J1xuICAgIHwgJ1NlcmlhbE51bWJlcidcbiAgICB8ICdNaW5CaWRBbW91bnROYW5vcydcbiAgPlxuPjtcbmV4cG9ydCBjb25zdCB1cGRhdGVORlQgPSBhc3luYyAoXG4gIHBhcmFtczogVXBkYXRlTkZUUmVxdWVzdFBhcmFtcyxcbiAgb3B0aW9ucz86IFR4UmVxdWVzdE9wdGlvbnNcbik6IFByb21pc2U8XG4gIENvbnN0cnVjdGVkQW5kU3VibWl0dGVkVHg8VXBkYXRlTkZUUmVzcG9uc2UgfCBDb25zdHJ1Y3RlZFRyYW5zYWN0aW9uUmVzcG9uc2U+XG4+ID0+IHtcbiAgY29uc3QgdHhXaXRoRmVlID0gZ2V0VHhXaXRoRmVlTmFub3MoXG4gICAgcGFyYW1zLlVwZGF0ZXJQdWJsaWNLZXlCYXNlNThDaGVjayxcbiAgICBidWlsZFVwZGF0ZU5GVE1ldGFkYXRhKHBhcmFtcyksXG4gICAge1xuICAgICAgRXh0cmFEYXRhOiBwYXJhbXMuRXh0cmFEYXRhLFxuICAgICAgTWluRmVlUmF0ZU5hbm9zUGVyS0I6IHBhcmFtcy5NaW5GZWVSYXRlTmFub3NQZXJLQixcbiAgICAgIFRyYW5zYWN0aW9uRmVlczogcGFyYW1zLlRyYW5zYWN0aW9uRmVlcyxcbiAgICAgIENvbnNlbnN1c0V4dHJhRGF0YUtWczogYnVpbGRVcGRhdGVORlRDb25zZW5zdXNLVnMocGFyYW1zKSxcbiAgICB9XG4gICk7XG5cbiAgaWYgKG9wdGlvbnM/LmNoZWNrUGVybWlzc2lvbnMgIT09IGZhbHNlKSB7XG4gICAgYXdhaXQgZ3VhcmRUeFBlcm1pc3Npb24oe1xuICAgICAgR2xvYmFsREVTT0xpbWl0OlxuICAgICAgICB0eFdpdGhGZWUuZmVlTmFub3MgKyBzdW1UcmFuc2FjdGlvbkZlZXMocGFyYW1zLlRyYW5zYWN0aW9uRmVlcyksXG4gICAgICBUcmFuc2FjdGlvbkNvdW50TGltaXRNYXA6IHtcbiAgICAgICAgVVBEQVRFX05GVDogb3B0aW9ucz8udHhMaW1pdENvdW50ID8/IDEsXG4gICAgICB9LFxuICAgIH0pO1xuICB9XG5cbiAgcmV0dXJuIGhhbmRsZVNpZ25BbmRTdWJtaXQoJ2FwaS92MC91cGRhdGUtbmZ0JywgcGFyYW1zLCB7XG4gICAgLi4ub3B0aW9ucyxcbiAgICBjb25zdHJ1Y3Rpb25GdW5jdGlvbjogY29uc3RydWN0VXBkYXRlTkZUVHJhbnNhY3Rpb24sXG4gIH0pO1xufTtcblxuY29uc3QgYnVpbGRVcGRhdGVORlRNZXRhZGF0YSA9IChwYXJhbXM6IFVwZGF0ZU5GVFJlcXVlc3RQYXJhbXMpID0+IHtcbiAgY29uc3QgbWV0YWRhdGEgPSBuZXcgVHJhbnNhY3Rpb25NZXRhZGF0YVVwZGF0ZU5GVCgpO1xuICBtZXRhZGF0YS5pc0ZvclNhbGUgPSAhIXBhcmFtcy5Jc0ZvclNhbGU7XG4gIG1ldGFkYXRhLm1pbkJpZEFtb3VudE5hbm9zID0gcGFyYW1zLk1pbkJpZEFtb3VudE5hbm9zO1xuICBtZXRhZGF0YS5uZnRQb3N0SGFzaCA9IGhleFRvQnl0ZXMocGFyYW1zLk5GVFBvc3RIYXNoSGV4KTtcbiAgbWV0YWRhdGEuc2VyaWFsTnVtYmVyID0gcGFyYW1zLlNlcmlhbE51bWJlcjtcbiAgcmV0dXJuIG1ldGFkYXRhO1xufTtcblxuY29uc3QgYnVpbGRVcGRhdGVORlRDb25zZW5zdXNLVnMgPSAocGFyYW1zOiBVcGRhdGVORlRSZXF1ZXN0UGFyYW1zKSA9PiB7XG4gIGNvbnN0IGNvbnNlbnN1c0V4dHJhRGF0YUtWczogVHJhbnNhY3Rpb25FeHRyYURhdGFLVltdID0gW107XG4gIGlmIChwYXJhbXMuSXNCdXlOb3cgJiYgcGFyYW1zLkJ1eU5vd1ByaWNlTmFub3MgIT09IHVuZGVmaW5lZCkge1xuICAgIGNvbnNlbnN1c0V4dHJhRGF0YUtWcy5wdXNoKFxuICAgICAgbmV3IFRyYW5zYWN0aW9uRXh0cmFEYXRhS1YoXG4gICAgICAgIGVuY29kZVVURjhUb0J5dGVzKCdCdXlOb3dQcmljZU5hbm9zJyksXG4gICAgICAgIHV2YXJpbnQ2NFRvQnVmKHBhcmFtcy5CdXlOb3dQcmljZU5hbm9zKVxuICAgICAgKVxuICAgICk7XG4gIH1cbiAgcmV0dXJuIGNvbnNlbnN1c0V4dHJhRGF0YUtWcztcbn07XG5cbmV4cG9ydCBjb25zdCBjb25zdHJ1Y3RVcGRhdGVORlRUcmFuc2FjdGlvbiA9IChcbiAgcGFyYW1zOiBVcGRhdGVORlRSZXF1ZXN0UGFyYW1zXG4pOiBQcm9taXNlPENvbnN0cnVjdGVkVHJhbnNhY3Rpb25SZXNwb25zZT4gPT4ge1xuICByZXR1cm4gY29uc3RydWN0QmFsYW5jZU1vZGVsVHgoXG4gICAgcGFyYW1zLlVwZGF0ZXJQdWJsaWNLZXlCYXNlNThDaGVjayxcbiAgICBidWlsZFVwZGF0ZU5GVE1ldGFkYXRhKHBhcmFtcyksXG4gICAge1xuICAgICAgRXh0cmFEYXRhOiBwYXJhbXMuRXh0cmFEYXRhLFxuICAgICAgTWluRmVlUmF0ZU5hbm9zUGVyS0I6IHBhcmFtcy5NaW5GZWVSYXRlTmFub3NQZXJLQixcbiAgICAgIFRyYW5zYWN0aW9uRmVlczogcGFyYW1zLlRyYW5zYWN0aW9uRmVlcyxcbiAgICAgIENvbnNlbnN1c0V4dHJhRGF0YUtWczogYnVpbGRVcGRhdGVORlRDb25zZW5zdXNLVnMocGFyYW1zKSxcbiAgICB9XG4gICk7XG59O1xuXG4vKipcbiAqIGh0dHBzOi8vZG9jcy5kZXNvLm9yZy9kZXNvLWJhY2tlbmQvY29uc3RydWN0LXRyYW5zYWN0aW9ucy9uZnQtdHJhbnNhY3Rpb25zLWFwaSNjcmVhdGUtbmZ0LWJpZFxuICovXG5leHBvcnQgdHlwZSBDcmVhdGVORlRCaWRSZXF1ZXN0UGFyYW1zID0gVHhSZXF1ZXN0V2l0aE9wdGlvbmFsRmVlc0FuZEV4dHJhRGF0YTxcbiAgUGFydGlhbFdpdGhSZXF1aXJlZEZpZWxkczxcbiAgICBDcmVhdGVORlRCaWRSZXF1ZXN0LFxuICAgIHwgJ0JpZEFtb3VudE5hbm9zJ1xuICAgIHwgJ05GVFBvc3RIYXNoSGV4J1xuICAgIHwgJ1NlcmlhbE51bWJlcidcbiAgICB8ICdVcGRhdGVyUHVibGljS2V5QmFzZTU4Q2hlY2snXG4gID5cbj47XG5leHBvcnQgY29uc3QgY3JlYXRlTkZUQmlkID0gYXN5bmMgKFxuICBwYXJhbXM6IENyZWF0ZU5GVEJpZFJlcXVlc3RQYXJhbXMsXG4gIG9wdGlvbnM/OiBUeFJlcXVlc3RPcHRpb25zXG4pOiBQcm9taXNlPFxuICBDb25zdHJ1Y3RlZEFuZFN1Ym1pdHRlZFR4PFxuICAgIENyZWF0ZU5GVEJpZFJlc3BvbnNlIHwgQ29uc3RydWN0ZWRUcmFuc2FjdGlvblJlc3BvbnNlXG4gID5cbj4gPT4ge1xuICBjb25zdCB0eFdpdGhGZWUgPSBnZXRUeFdpdGhGZWVOYW5vcyhcbiAgICBwYXJhbXMuVXBkYXRlclB1YmxpY0tleUJhc2U1OENoZWNrLFxuICAgIGJ1aWxkQ3JlYXRlTkZUQmlkTWV0YWRhdGEocGFyYW1zKSxcbiAgICB7XG4gICAgICBFeHRyYURhdGE6IHBhcmFtcy5FeHRyYURhdGEsXG4gICAgICBNaW5GZWVSYXRlTmFub3NQZXJLQjogcGFyYW1zLk1pbkZlZVJhdGVOYW5vc1BlcktCLFxuICAgICAgVHJhbnNhY3Rpb25GZWVzOiBwYXJhbXMuVHJhbnNhY3Rpb25GZWVzLFxuICAgIH1cbiAgKTtcblxuICBpZiAob3B0aW9ucz8uY2hlY2tQZXJtaXNzaW9ucyAhPT0gZmFsc2UpIHtcbiAgICBhd2FpdCBndWFyZFR4UGVybWlzc2lvbih7XG4gICAgICBHbG9iYWxERVNPTGltaXQ6XG4gICAgICAgIHBhcmFtcy5CaWRBbW91bnROYW5vcyArXG4gICAgICAgIHR4V2l0aEZlZS5mZWVOYW5vcyArXG4gICAgICAgIHN1bVRyYW5zYWN0aW9uRmVlcyhwYXJhbXMuVHJhbnNhY3Rpb25GZWVzKSxcbiAgICAgIE5GVE9wZXJhdGlvbkxpbWl0TWFwOiB7XG4gICAgICAgIFtwYXJhbXMuTkZUUG9zdEhhc2hIZXhdOiB7XG4gICAgICAgICAgW3BhcmFtcy5TZXJpYWxOdW1iZXJdOiB7XG4gICAgICAgICAgICBuZnRfYmlkOiBvcHRpb25zPy50eExpbWl0Q291bnQgPz8gMSxcbiAgICAgICAgICB9LFxuICAgICAgICB9LFxuICAgICAgfSxcbiAgICB9KTtcbiAgfVxuXG4gIHJldHVybiBoYW5kbGVTaWduQW5kU3VibWl0KCdhcGkvdjAvY3JlYXRlLW5mdC1iaWQnLCBwYXJhbXMsIHtcbiAgICAuLi5vcHRpb25zLFxuICAgIGNvbnN0cnVjdGlvbkZ1bmN0aW9uOiBjb25zdHJ1Y3RORlRCaWRUcmFuc2FjdGlvbixcbiAgfSk7XG59O1xuXG5jb25zdCBidWlsZENyZWF0ZU5GVEJpZE1ldGFkYXRhID0gKHBhcmFtczogQ3JlYXRlTkZUQmlkUmVxdWVzdFBhcmFtcykgPT4ge1xuICBjb25zdCBtZXRhZGF0YSA9IG5ldyBUcmFuc2FjdGlvbk1ldGFkYXRhTkZUQmlkKCk7XG4gIG1ldGFkYXRhLmJpZEFtb3VudE5hbm9zID0gcGFyYW1zLkJpZEFtb3VudE5hbm9zO1xuICBtZXRhZGF0YS5uZnRQb3N0SGFzaCA9IGhleFRvQnl0ZXMocGFyYW1zLk5GVFBvc3RIYXNoSGV4KTtcbiAgbWV0YWRhdGEuc2VyaWFsTnVtYmVyID0gcGFyYW1zLlNlcmlhbE51bWJlcjtcblxuICByZXR1cm4gbWV0YWRhdGE7XG59O1xuXG5leHBvcnQgY29uc3QgY29uc3RydWN0TkZUQmlkVHJhbnNhY3Rpb24gPSAoXG4gIHBhcmFtczogQ3JlYXRlTkZUQmlkUmVxdWVzdFBhcmFtc1xuKTogUHJvbWlzZTxDb25zdHJ1Y3RlZFRyYW5zYWN0aW9uUmVzcG9uc2U+ID0+IHtcbiAgcmV0dXJuIGNvbnN0cnVjdEJhbGFuY2VNb2RlbFR4KFxuICAgIHBhcmFtcy5VcGRhdGVyUHVibGljS2V5QmFzZTU4Q2hlY2ssXG4gICAgYnVpbGRDcmVhdGVORlRCaWRNZXRhZGF0YShwYXJhbXMpLFxuICAgIHtcbiAgICAgIE1pbkZlZVJhdGVOYW5vc1BlcktCOiBwYXJhbXMuTWluRmVlUmF0ZU5hbm9zUGVyS0IsXG4gICAgICBFeHRyYURhdGE6IHBhcmFtcy5FeHRyYURhdGEsXG4gICAgICBUcmFuc2FjdGlvbkZlZXM6IHBhcmFtcy5UcmFuc2FjdGlvbkZlZXMsXG4gICAgfVxuICApO1xufTtcblxuLyoqXG4gKiBodHRwczovL2RvY3MuZGVzby5vcmcvZGVzby1iYWNrZW5kL2NvbnN0cnVjdC10cmFuc2FjdGlvbnMvbmZ0LXRyYW5zYWN0aW9ucy1hcGkjYWNjZXB0LW5mdC1iaWRcbiAqL1xuZXhwb3J0IHR5cGUgQWNjZXB0TkZUQmlkUmVxdWVzdFBhcmFtcyA9IFR4UmVxdWVzdFdpdGhPcHRpb25hbEZlZXNBbmRFeHRyYURhdGE8XG4gIFBhcnRpYWxXaXRoUmVxdWlyZWRGaWVsZHM8XG4gICAgQWNjZXB0TkZUQmlkUmVxdWVzdCxcbiAgICB8ICdCaWRBbW91bnROYW5vcydcbiAgICB8ICdORlRQb3N0SGFzaEhleCdcbiAgICB8ICdTZXJpYWxOdW1iZXInXG4gICAgfCAnVXBkYXRlclB1YmxpY0tleUJhc2U1OENoZWNrJ1xuICAgIHwgJ0JpZGRlclB1YmxpY0tleUJhc2U1OENoZWNrJ1xuICA+XG4+O1xuZXhwb3J0IGNvbnN0IGFjY2VwdE5GVEJpZCA9IGFzeW5jIChcbiAgcGFyYW1zOiBBY2NlcHRORlRCaWRSZXF1ZXN0UGFyYW1zLFxuICBvcHRpb25zPzogVHhSZXF1ZXN0T3B0aW9uc1xuKTogUHJvbWlzZTxcbiAgQ29uc3RydWN0ZWRBbmRTdWJtaXR0ZWRUeDxcbiAgICBBY2NlcHRORlRCaWRSZXNwb25zZSB8IENvbnN0cnVjdGVkVHJhbnNhY3Rpb25SZXNwb25zZVxuICA+XG4+ID0+IHtcbiAgY29uc3QgdHhXaXRoRmVlID0gZ2V0VHhXaXRoRmVlTmFub3MoXG4gICAgcGFyYW1zLlVwZGF0ZXJQdWJsaWNLZXlCYXNlNThDaGVjayxcbiAgICBidWlsZEFjY2VwdE5GVEJpZE1ldGFkYXRhKHBhcmFtcyksXG4gICAge1xuICAgICAgRXh0cmFEYXRhOiBwYXJhbXMuRXh0cmFEYXRhLFxuICAgICAgTWluRmVlUmF0ZU5hbm9zUGVyS0I6IHBhcmFtcy5NaW5GZWVSYXRlTmFub3NQZXJLQixcbiAgICAgIFRyYW5zYWN0aW9uRmVlczogcGFyYW1zLlRyYW5zYWN0aW9uRmVlcyxcbiAgICB9XG4gICk7XG5cbiAgaWYgKG9wdGlvbnM/LmNoZWNrUGVybWlzc2lvbnMgIT09IGZhbHNlKSB7XG4gICAgYXdhaXQgZ3VhcmRUeFBlcm1pc3Npb24oe1xuICAgICAgR2xvYmFsREVTT0xpbWl0OlxuICAgICAgICBwYXJhbXMuQmlkQW1vdW50TmFub3MgK1xuICAgICAgICB0eFdpdGhGZWUuZmVlTmFub3MgK1xuICAgICAgICBzdW1UcmFuc2FjdGlvbkZlZXMocGFyYW1zLlRyYW5zYWN0aW9uRmVlcyksXG4gICAgICBORlRPcGVyYXRpb25MaW1pdE1hcDoge1xuICAgICAgICBbcGFyYW1zLk5GVFBvc3RIYXNoSGV4XToge1xuICAgICAgICAgIFtwYXJhbXMuU2VyaWFsTnVtYmVyXToge1xuICAgICAgICAgICAgYWNjZXB0X25mdF9iaWQ6IG9wdGlvbnM/LnR4TGltaXRDb3VudCA/PyAxLFxuICAgICAgICAgIH0sXG4gICAgICAgIH0sXG4gICAgICB9LFxuICAgIH0pO1xuICB9XG5cbiAgcmV0dXJuIGhhbmRsZVNpZ25BbmRTdWJtaXQoJ2FwaS92MC9hY2NlcHQtbmZ0LWJpZCcsIHBhcmFtcywge1xuICAgIC4uLm9wdGlvbnMsXG4gICAgY29uc3RydWN0aW9uRnVuY3Rpb246IGNvbnN0cnVjdEFjY2VwdE5GVEJpZFRyYW5zYWN0aW9uLFxuICB9KTtcbn07XG5cbmNvbnN0IGJ1aWxkQWNjZXB0TkZUQmlkTWV0YWRhdGEgPSAocGFyYW1zOiBBY2NlcHRORlRCaWRSZXF1ZXN0UGFyYW1zKSA9PiB7XG4gIGNvbnN0IG1ldGFkYXRhID0gbmV3IFRyYW5zYWN0aW9uTWV0YWRhdGFBY2NlcHRORlRCaWQoKTtcbiAgbWV0YWRhdGEuYmlkQW1vdW50TmFub3MgPSBwYXJhbXMuQmlkQW1vdW50TmFub3M7XG4gIG1ldGFkYXRhLmJpZGRlcklucHV0cyA9IFtdO1xuICAvLyBUT0RPOiB0aGlzIHdvbid0IHdvcmsgaWYgdGhleSd2ZSBoYWQgdGhlaXIgaWRlbnRpdHkgc3dhcHBlZC5cbiAgbWV0YWRhdGEuYmlkZGVyUEtJRCA9IGJzNThQdWJsaWNLZXlUb0NvbXByZXNzZWRCeXRlcyhcbiAgICBwYXJhbXMuQmlkZGVyUHVibGljS2V5QmFzZTU4Q2hlY2tcbiAgKTtcbiAgbWV0YWRhdGEuZW5jcnlwdGVkVW5sb2NrYWJsZVRleHQgPSBoZXhUb0J5dGVzKFxuICAgIHBhcmFtcy5FbmNyeXB0ZWRVbmxvY2thYmxlVGV4dCB8fCAnJ1xuICApO1xuICBtZXRhZGF0YS5uZnRQb3N0SGFzaCA9IGhleFRvQnl0ZXMocGFyYW1zLk5GVFBvc3RIYXNoSGV4KTtcbiAgbWV0YWRhdGEuc2VyaWFsTnVtYmVyID0gcGFyYW1zLlNlcmlhbE51bWJlcjtcblxuICByZXR1cm4gbWV0YWRhdGE7XG59O1xuXG5leHBvcnQgY29uc3QgY29uc3RydWN0QWNjZXB0TkZUQmlkVHJhbnNhY3Rpb24gPSAoXG4gIHBhcmFtczogQWNjZXB0TkZUQmlkUmVxdWVzdFBhcmFtc1xuKTogUHJvbWlzZTxDb25zdHJ1Y3RlZFRyYW5zYWN0aW9uUmVzcG9uc2U+ID0+IHtcbiAgcmV0dXJuIGNvbnN0cnVjdEJhbGFuY2VNb2RlbFR4KFxuICAgIHBhcmFtcy5VcGRhdGVyUHVibGljS2V5QmFzZTU4Q2hlY2ssXG4gICAgYnVpbGRBY2NlcHRORlRCaWRNZXRhZGF0YShwYXJhbXMpLFxuICAgIHtcbiAgICAgIE1pbkZlZVJhdGVOYW5vc1BlcktCOiBwYXJhbXMuTWluRmVlUmF0ZU5hbm9zUGVyS0IsXG4gICAgICBFeHRyYURhdGE6IHBhcmFtcy5FeHRyYURhdGEsXG4gICAgICBUcmFuc2FjdGlvbkZlZXM6IHBhcmFtcy5UcmFuc2FjdGlvbkZlZXMsXG4gICAgfVxuICApO1xufTtcblxuLyoqXG4gKiBodHRwczovL2RvY3MuZGVzby5vcmcvZGVzby1iYWNrZW5kL2NvbnN0cnVjdC10cmFuc2FjdGlvbnMvbmZ0LXRyYW5zYWN0aW9ucy1hcGkjdHJhbnNmZXItbmZ0XG4gKi9cbmV4cG9ydCB0eXBlIFRyYW5zZmVyTkZUUmVxdWVzdFBhcmFtcyA9IFR4UmVxdWVzdFdpdGhPcHRpb25hbEZlZXNBbmRFeHRyYURhdGE8XG4gIFBhcnRpYWxXaXRoUmVxdWlyZWRGaWVsZHM8XG4gICAgVHJhbnNmZXJORlRSZXF1ZXN0LFxuICAgIHwgJ1NlbmRlclB1YmxpY0tleUJhc2U1OENoZWNrJ1xuICAgIHwgJ1JlY2VpdmVyUHVibGljS2V5QmFzZTU4Q2hlY2snXG4gICAgfCAnTkZUUG9zdEhhc2hIZXgnXG4gICAgfCAnU2VyaWFsTnVtYmVyJ1xuICA+XG4+O1xuZXhwb3J0IGNvbnN0IHRyYW5zZmVyTkZUID0gYXN5bmMgKFxuICBwYXJhbXM6IFRyYW5zZmVyTkZUUmVxdWVzdFBhcmFtcyxcbiAgb3B0aW9ucz86IFR4UmVxdWVzdE9wdGlvbnNcbik6IFByb21pc2U8XG4gIENvbnN0cnVjdGVkQW5kU3VibWl0dGVkVHg8XG4gICAgVHJhbnNmZXJORlRSZXNwb25zZSB8IENvbnN0cnVjdGVkVHJhbnNhY3Rpb25SZXNwb25zZVxuICA+XG4+ID0+IHtcbiAgY29uc3QgdHhXaXRoRmVlID0gZ2V0VHhXaXRoRmVlTmFub3MoXG4gICAgcGFyYW1zLlNlbmRlclB1YmxpY0tleUJhc2U1OENoZWNrLFxuICAgIGJ1aWxkVHJhbnNmZXJORlRNZXRhZGF0YShwYXJhbXMpLFxuICAgIHtcbiAgICAgIEV4dHJhRGF0YTogcGFyYW1zLkV4dHJhRGF0YSxcbiAgICAgIE1pbkZlZVJhdGVOYW5vc1BlcktCOiBwYXJhbXMuTWluRmVlUmF0ZU5hbm9zUGVyS0IsXG4gICAgICBUcmFuc2FjdGlvbkZlZXM6IHBhcmFtcy5UcmFuc2FjdGlvbkZlZXMsXG4gICAgfVxuICApO1xuXG4gIGlmIChvcHRpb25zPy5jaGVja1Blcm1pc3Npb25zICE9PSBmYWxzZSkge1xuICAgIGF3YWl0IGd1YXJkVHhQZXJtaXNzaW9uKHtcbiAgICAgIEdsb2JhbERFU09MaW1pdDpcbiAgICAgICAgdHhXaXRoRmVlLmZlZU5hbm9zICsgc3VtVHJhbnNhY3Rpb25GZWVzKHBhcmFtcy5UcmFuc2FjdGlvbkZlZXMpLFxuICAgICAgTkZUT3BlcmF0aW9uTGltaXRNYXA6IHtcbiAgICAgICAgW3BhcmFtcy5ORlRQb3N0SGFzaEhleF06IHtcbiAgICAgICAgICBbcGFyYW1zLlNlcmlhbE51bWJlcl06IHtcbiAgICAgICAgICAgIHRyYW5zZmVyOiBvcHRpb25zPy50eExpbWl0Q291bnQgPz8gMSxcbiAgICAgICAgICB9LFxuICAgICAgICB9LFxuICAgICAgfSxcbiAgICB9KTtcbiAgfVxuICByZXR1cm4gaGFuZGxlU2lnbkFuZFN1Ym1pdCgnYXBpL3YwL3RyYW5zZmVyLW5mdCcsIHBhcmFtcywge1xuICAgIC4uLm9wdGlvbnMsXG4gICAgY29uc3RydWN0aW9uRnVuY3Rpb246IGNvbnN0cnVjdFRyYW5zZmVyTkZULFxuICB9KTtcbn07XG5cbmNvbnN0IGJ1aWxkVHJhbnNmZXJORlRNZXRhZGF0YSA9IChwYXJhbXM6IFRyYW5zZmVyTkZUUmVxdWVzdFBhcmFtcykgPT4ge1xuICBjb25zdCBtZXRhZGF0YSA9IG5ldyBUcmFuc2FjdGlvbk1ldGFkYXRhTkZUVHJhbnNmZXIoKTtcbiAgbWV0YWRhdGEuZW5jcnlwdGVkVW5sb2NrYWJsZVRleHQgPSBoZXhUb0J5dGVzKFxuICAgIHBhcmFtcy5FbmNyeXB0ZWRVbmxvY2thYmxlVGV4dCB8fCAnJ1xuICApO1xuICBtZXRhZGF0YS5uZnRQb3N0SGFzaCA9IGhleFRvQnl0ZXMocGFyYW1zLk5GVFBvc3RIYXNoSGV4KTtcbiAgbWV0YWRhdGEucmVjZWl2ZXJQdWJsaWNLZXkgPSBiczU4UHVibGljS2V5VG9Db21wcmVzc2VkQnl0ZXMoXG4gICAgcGFyYW1zLlJlY2VpdmVyUHVibGljS2V5QmFzZTU4Q2hlY2tcbiAgKTtcbiAgbWV0YWRhdGEuc2VyaWFsTnVtYmVyID0gcGFyYW1zLlNlcmlhbE51bWJlcjtcblxuICByZXR1cm4gbWV0YWRhdGE7XG59O1xuXG5leHBvcnQgY29uc3QgY29uc3RydWN0VHJhbnNmZXJORlQgPSAoXG4gIHBhcmFtczogVHJhbnNmZXJORlRSZXF1ZXN0UGFyYW1zXG4pOiBQcm9taXNlPENvbnN0cnVjdGVkVHJhbnNhY3Rpb25SZXNwb25zZSB8IENvbnN0cnVjdGVkVHJhbnNhY3Rpb25SZXNwb25zZT4gPT4ge1xuICByZXR1cm4gY29uc3RydWN0QmFsYW5jZU1vZGVsVHgoXG4gICAgcGFyYW1zLlNlbmRlclB1YmxpY0tleUJhc2U1OENoZWNrLFxuICAgIGJ1aWxkVHJhbnNmZXJORlRNZXRhZGF0YShwYXJhbXMpLFxuICAgIHtcbiAgICAgIE1pbkZlZVJhdGVOYW5vc1BlcktCOiBwYXJhbXMuTWluRmVlUmF0ZU5hbm9zUGVyS0IsXG4gICAgICBFeHRyYURhdGE6IHBhcmFtcy5FeHRyYURhdGEsXG4gICAgICBUcmFuc2FjdGlvbkZlZXM6IHBhcmFtcy5UcmFuc2FjdGlvbkZlZXMsXG4gICAgfVxuICApO1xufTtcblxuLyoqXG4gKiBodHRwczovL2RvY3MuZGVzby5vcmcvZGVzby1iYWNrZW5kL2NvbnN0cnVjdC10cmFuc2FjdGlvbnMvbmZ0LXRyYW5zYWN0aW9ucy1hcGkjYWNjZXB0LW5mdC10cmFuc2ZlclxuICovXG5leHBvcnQgdHlwZSBBY2NlcHRORlRUcmFuc2ZlclJlcXVlc3RQYXJhbXMgPVxuICBUeFJlcXVlc3RXaXRoT3B0aW9uYWxGZWVzQW5kRXh0cmFEYXRhPFxuICAgIFBhcnRpYWxXaXRoUmVxdWlyZWRGaWVsZHM8XG4gICAgICBBY2NlcHRORlRUcmFuc2ZlclJlcXVlc3QsXG4gICAgICAnVXBkYXRlclB1YmxpY0tleUJhc2U1OENoZWNrJyB8ICdORlRQb3N0SGFzaEhleCcgfCAnU2VyaWFsTnVtYmVyJ1xuICAgID5cbiAgPjtcbmV4cG9ydCBjb25zdCBhY2NlcHRORlRUcmFuc2ZlciA9IGFzeW5jIChcbiAgcGFyYW1zOiBBY2NlcHRORlRUcmFuc2ZlclJlcXVlc3RQYXJhbXMsXG4gIG9wdGlvbnM/OiBUeFJlcXVlc3RPcHRpb25zXG4pOiBQcm9taXNlPFxuICBDb25zdHJ1Y3RlZEFuZFN1Ym1pdHRlZFR4PFxuICAgIEFjY2VwdE5GVFRyYW5zZmVyUmVzcG9uc2UgfCBDb25zdHJ1Y3RlZFRyYW5zYWN0aW9uUmVzcG9uc2VcbiAgPlxuPiA9PiB7XG4gIGNvbnN0IHR4V2l0aEZlZSA9IGdldFR4V2l0aEZlZU5hbm9zKFxuICAgIHBhcmFtcy5VcGRhdGVyUHVibGljS2V5QmFzZTU4Q2hlY2ssXG4gICAgYnVpbGRBY2NlcHRORlRUcmFuc2Zlck1ldGFkYXRhKHBhcmFtcyksXG4gICAge1xuICAgICAgRXh0cmFEYXRhOiBwYXJhbXMuRXh0cmFEYXRhLFxuICAgICAgTWluRmVlUmF0ZU5hbm9zUGVyS0I6IHBhcmFtcy5NaW5GZWVSYXRlTmFub3NQZXJLQixcbiAgICAgIFRyYW5zYWN0aW9uRmVlczogcGFyYW1zLlRyYW5zYWN0aW9uRmVlcyxcbiAgICB9XG4gICk7XG5cbiAgaWYgKG9wdGlvbnM/LmNoZWNrUGVybWlzc2lvbnMgIT09IGZhbHNlKSB7XG4gICAgYXdhaXQgZ3VhcmRUeFBlcm1pc3Npb24oe1xuICAgICAgR2xvYmFsREVTT0xpbWl0OlxuICAgICAgICB0eFdpdGhGZWUuZmVlTmFub3MgKyBzdW1UcmFuc2FjdGlvbkZlZXMocGFyYW1zLlRyYW5zYWN0aW9uRmVlcyksXG4gICAgICBORlRPcGVyYXRpb25MaW1pdE1hcDoge1xuICAgICAgICBbcGFyYW1zLk5GVFBvc3RIYXNoSGV4XToge1xuICAgICAgICAgIFtwYXJhbXMuU2VyaWFsTnVtYmVyXToge1xuICAgICAgICAgICAgYWNjZXB0X25mdF90cmFuc2Zlcjogb3B0aW9ucz8udHhMaW1pdENvdW50ID8/IDEsXG4gICAgICAgICAgfSxcbiAgICAgICAgfSxcbiAgICAgIH0sXG4gICAgfSk7XG4gIH1cblxuICByZXR1cm4gaGFuZGxlU2lnbkFuZFN1Ym1pdCgnYXBpL3YwL2FjY2VwdC1uZnQtdHJhbnNmZXInLCBwYXJhbXMsIHtcbiAgICAuLi5vcHRpb25zLFxuICAgIGNvbnN0cnVjdGlvbkZ1bmN0aW9uOiBjb25zdHJ1Y3RBY2NlcHRORlRUcmFuc2ZlcixcbiAgfSk7XG59O1xuXG5leHBvcnQgY29uc3QgYnVpbGRBY2NlcHRORlRUcmFuc2Zlck1ldGFkYXRhID0gKFxuICBwYXJhbXM6IEFjY2VwdE5GVFRyYW5zZmVyUmVxdWVzdFBhcmFtc1xuKSA9PiB7XG4gIGNvbnN0IG1ldGFkYXRhID0gbmV3IFRyYW5zYWN0aW9uTWV0YWRhdGFBY2NlcHRORlRUcmFuc2ZlcigpO1xuICBtZXRhZGF0YS5uZnRQb3N0SGFzaCA9IGhleFRvQnl0ZXMocGFyYW1zLk5GVFBvc3RIYXNoSGV4KTtcbiAgbWV0YWRhdGEuc2VyaWFsTnVtYmVyID0gcGFyYW1zLlNlcmlhbE51bWJlcjtcblxuICByZXR1cm4gbWV0YWRhdGE7XG59O1xuXG5leHBvcnQgY29uc3QgY29uc3RydWN0QWNjZXB0TkZUVHJhbnNmZXIgPSAoXG4gIHBhcmFtczogQWNjZXB0TkZUVHJhbnNmZXJSZXF1ZXN0UGFyYW1zXG4pOiBQcm9taXNlPENvbnN0cnVjdGVkVHJhbnNhY3Rpb25SZXNwb25zZT4gPT4ge1xuICByZXR1cm4gY29uc3RydWN0QmFsYW5jZU1vZGVsVHgoXG4gICAgcGFyYW1zLlVwZGF0ZXJQdWJsaWNLZXlCYXNlNThDaGVjayxcbiAgICBidWlsZEFjY2VwdE5GVFRyYW5zZmVyTWV0YWRhdGEocGFyYW1zKSxcbiAgICB7XG4gICAgICBFeHRyYURhdGE6IHBhcmFtcy5FeHRyYURhdGEsXG4gICAgICBNaW5GZWVSYXRlTmFub3NQZXJLQjogcGFyYW1zLk1pbkZlZVJhdGVOYW5vc1BlcktCLFxuICAgICAgVHJhbnNhY3Rpb25GZWVzOiBwYXJhbXMuVHJhbnNhY3Rpb25GZWVzLFxuICAgIH1cbiAgKTtcbn07XG5cbi8qKlxuICogaHR0cHM6Ly9kb2NzLmRlc28ub3JnL2Rlc28tYmFja2VuZC9jb25zdHJ1Y3QtdHJhbnNhY3Rpb25zL25mdC10cmFuc2FjdGlvbnMtYXBpI2J1cm4tbmZ0XG4gKi9cbmV4cG9ydCB0eXBlIEJ1cm5ORlRSZXF1ZXN0UGFyYW1zID0gVHhSZXF1ZXN0V2l0aE9wdGlvbmFsRmVlc0FuZEV4dHJhRGF0YTxcbiAgUGFydGlhbFdpdGhSZXF1aXJlZEZpZWxkczxcbiAgICBCdXJuTkZUUmVxdWVzdCxcbiAgICAnVXBkYXRlclB1YmxpY0tleUJhc2U1OENoZWNrJyB8ICdORlRQb3N0SGFzaEhleCcgfCAnU2VyaWFsTnVtYmVyJ1xuICA+XG4+O1xuZXhwb3J0IGNvbnN0IGJ1cm5ORlQgPSBhc3luYyAoXG4gIHBhcmFtczogQnVybk5GVFJlcXVlc3RQYXJhbXMsXG4gIG9wdGlvbnM/OiBUeFJlcXVlc3RPcHRpb25zXG4pOiBQcm9taXNlPFxuICBDb25zdHJ1Y3RlZEFuZFN1Ym1pdHRlZFR4PEJ1cm5ORlRSZXNwb25zZSB8IENvbnN0cnVjdGVkVHJhbnNhY3Rpb25SZXNwb25zZT5cbj4gPT4ge1xuICBjb25zdCB0eFdpdGhGZWUgPSBnZXRUeFdpdGhGZWVOYW5vcyhcbiAgICBwYXJhbXMuVXBkYXRlclB1YmxpY0tleUJhc2U1OENoZWNrLFxuICAgIGJ1aWxkQnVybk5GVE1ldGFkYXRhKHBhcmFtcyksXG4gICAge1xuICAgICAgRXh0cmFEYXRhOiBwYXJhbXMuRXh0cmFEYXRhLFxuICAgICAgTWluRmVlUmF0ZU5hbm9zUGVyS0I6IHBhcmFtcy5NaW5GZWVSYXRlTmFub3NQZXJLQixcbiAgICAgIFRyYW5zYWN0aW9uRmVlczogcGFyYW1zLlRyYW5zYWN0aW9uRmVlcyxcbiAgICB9XG4gICk7XG5cbiAgaWYgKG9wdGlvbnM/LmNoZWNrUGVybWlzc2lvbnMgIT09IGZhbHNlKSB7XG4gICAgYXdhaXQgZ3VhcmRUeFBlcm1pc3Npb24oe1xuICAgICAgR2xvYmFsREVTT0xpbWl0OlxuICAgICAgICB0eFdpdGhGZWUuZmVlTmFub3MgKyBzdW1UcmFuc2FjdGlvbkZlZXMocGFyYW1zLlRyYW5zYWN0aW9uRmVlcyksXG4gICAgICBORlRPcGVyYXRpb25MaW1pdE1hcDoge1xuICAgICAgICBbcGFyYW1zLk5GVFBvc3RIYXNoSGV4XToge1xuICAgICAgICAgIFtwYXJhbXMuU2VyaWFsTnVtYmVyXToge1xuICAgICAgICAgICAgYnVybjogb3B0aW9ucz8udHhMaW1pdENvdW50ID8/IDEsXG4gICAgICAgICAgfSxcbiAgICAgICAgfSxcbiAgICAgIH0sXG4gICAgfSk7XG4gIH1cblxuICByZXR1cm4gaGFuZGxlU2lnbkFuZFN1Ym1pdCgnYXBpL3YwL2J1cm4tbmZ0JywgcGFyYW1zLCB7XG4gICAgLi4ub3B0aW9ucyxcbiAgICBjb25zdHJ1Y3Rpb25GdW5jdGlvbjogY29uc3RydWN0QnVybk5GVFRyYW5zYXRpb24sXG4gIH0pO1xufTtcblxuY29uc3QgYnVpbGRCdXJuTkZUTWV0YWRhdGEgPSAocGFyYW1zOiBCdXJuTkZUUmVxdWVzdFBhcmFtcykgPT4ge1xuICBjb25zdCBtZXRhZGF0YSA9IG5ldyBUcmFuc2FjdGlvbk1ldGFkYXRhQnVybk5GVCgpO1xuICBtZXRhZGF0YS5uZnRQb3N0SGFzaCA9IGhleFRvQnl0ZXMocGFyYW1zLk5GVFBvc3RIYXNoSGV4KTtcbiAgbWV0YWRhdGEuc2VyaWFsTnVtYmVyID0gcGFyYW1zLlNlcmlhbE51bWJlcjtcblxuICByZXR1cm4gbWV0YWRhdGE7XG59O1xuXG5leHBvcnQgY29uc3QgY29uc3RydWN0QnVybk5GVFRyYW5zYXRpb24gPSAoXG4gIHBhcmFtczogQnVybk5GVFJlcXVlc3RQYXJhbXNcbik6IFByb21pc2U8Q29uc3RydWN0ZWRUcmFuc2FjdGlvblJlc3BvbnNlPiA9PiB7XG4gIHJldHVybiBjb25zdHJ1Y3RCYWxhbmNlTW9kZWxUeChcbiAgICBwYXJhbXMuVXBkYXRlclB1YmxpY0tleUJhc2U1OENoZWNrLFxuICAgIGJ1aWxkQnVybk5GVE1ldGFkYXRhKHBhcmFtcyksXG4gICAge1xuICAgICAgRXh0cmFEYXRhOiBwYXJhbXMuRXh0cmFEYXRhLFxuICAgICAgTWluRmVlUmF0ZU5hbm9zUGVyS0I6IHBhcmFtcy5NaW5GZWVSYXRlTmFub3NQZXJLQixcbiAgICAgIFRyYW5zYWN0aW9uRmVlczogcGFyYW1zLlRyYW5zYWN0aW9uRmVlcyxcbiAgICB9XG4gICk7XG59O1xuIl19